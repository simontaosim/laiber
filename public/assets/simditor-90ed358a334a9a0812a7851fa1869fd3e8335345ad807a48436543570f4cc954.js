/*!
* Simditor v2.1.11
* http://simditor.tower.im/
* 2015-20-05
*/
!function(e,t){"function"==typeof define&&define.amd?define("simditor",["jquery","simple-module","simple-hotkeys","simple-uploader"],function(n,i,o,a){return e.Simditor=t(n,i,o,a)}):"object"==typeof exports?module.exports=t(require("jquery"),require("simple-module"),require("simple-hotkeys"),require("simple-uploader")):e.Simditor=t(jQuery,SimpleModule,simple.hotkeys,simple.uploader)}(this,function(e,t,n,i){var o,a,s,r,l,c,u,d,h,f,p,m,g,v,E,y,T,b,C,I,D,w,O,R,k,_,x,S,K,N,A,L,P=function(e,t){function n(){this.constructor=e}for(var i in t)F.call(t,i)&&(e[i]=t[i]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e},F={}.hasOwnProperty,M=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1},$=[].slice;return O=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return P(n,t),n.pluginName="Selection",n.prototype._init=function(){return this.editor=this._module,this.sel=document.getSelection()},n.prototype.clear=function(){var e;try{return this.sel.removeAllRanges()}catch(t){e=t}},n.prototype.getRange=function(){return this.editor.inputManager.focused&&this.sel.rangeCount?this.sel.getRangeAt(0):null},n.prototype.selectRange=function(e){return this.clear(),this.sel.addRange(e),this.editor.inputManager.focused||!this.editor.util.browser.firefox&&!this.editor.util.browser.msie||this.editor.body.focus(),e},n.prototype.rangeAtEndOf=function(t,n){var i,o,a;return null==n&&(n=this.getRange()),null!=n&&n.collapsed?(t=e(t)[0],i=n.endContainer,o=this.editor.util.getNodeLength(i),n.endOffset===o-1&&e(i).contents().last().is("br")||n.endOffset===o?t===i?!0:e.contains(t,i)?(a=!0,e(i).parentsUntil(t).addBack().each(function(){return function(t,n){var i,o;return o=e(n).parent().contents().filter(function(){return!(this!==n&&3===this.nodeType&&!this.nodeValue)}),i=o.last(),i.get(0)===n||i.is("br")&&i.prev().get(0)===n?void 0:(a=!1,!1)}}(this)),a):!1:!1):void 0},n.prototype.rangeAtStartOf=function(t,n){var i,o;return null==n&&(n=this.getRange()),null!=n&&n.collapsed?(t=e(t)[0],o=n.startContainer,0!==n.startOffset?!1:t===o?!0:e.contains(t,o)?(i=!0,e(o).parentsUntil(t).addBack().each(function(){return function(t,n){var o;return o=e(n).parent().contents().filter(function(){return!(this!==n&&3===this.nodeType&&!this.nodeValue)}),o.first().get(0)!==n?i=!1:void 0}}(this)),i):!1):void 0},n.prototype.insertNode=function(t,n){return null==n&&(n=this.getRange()),null!=n?(t=e(t)[0],n.insertNode(t),this.setRangeAfter(t,n)):void 0},n.prototype.setRangeAfter=function(t,n){return null==n&&(n=this.getRange()),null!=n?(t=e(t)[0],n.setEndAfter(t),n.collapse(!1),this.selectRange(n)):void 0},n.prototype.setRangeBefore=function(t,n){return null==n&&(n=this.getRange()),null!=n?(t=e(t)[0],n.setEndBefore(t),n.collapse(!1),this.selectRange(n)):void 0},n.prototype.setRangeAtStartOf=function(t,n){return null==n&&(n=this.getRange()),t=e(t).get(0),n.setEnd(t,0),n.collapse(!1),this.selectRange(n)},n.prototype.setRangeAtEndOf=function(t,n){var i,o,a,s,r,l;return null==n&&(n=this.getRange()),o=e(t),t=o.get(0),o.is("pre")?(a=o.contents(),a.length>0?(s=a.last(),r=s.text(),"\n"===r.charAt(r.length-1)?n.setEnd(s[0],this.editor.util.getNodeLength(s[0])-1):n.setEnd(s[0],this.editor.util.getNodeLength(s[0]))):n.setEnd(t,0)):(l=this.editor.util.getNodeLength(t),3!==t.nodeType&&l>0&&(i=e(t).contents().last(),i.is("br")?l-=1:3!==i[0].nodeType&&this.editor.util.isEmptyNode(i)&&(i.append(this.editor.util.phBr),t=i[0],l=0)),n.setEnd(t,l)),n.collapse(!1),this.selectRange(n)},n.prototype.deleteRangeContents=function(e){var t,n;return null==e&&(e=this.getRange()),n=e.cloneRange(),t=e.cloneRange(),n.collapse(!0),t.collapse(!1),!e.collapsed&&this.rangeAtStartOf(this.editor.body,n)&&this.rangeAtEndOf(this.editor.body,t)?(this.editor.body.empty(),e.setStart(this.editor.body[0],0),e.collapse(!0),this.selectRange(e)):e.deleteContents(),e},n.prototype.breakBlockEl=function(t,n){var i;return null==n&&(n=this.getRange()),i=e(t),n.collapsed?(n.setStartBefore(i.get(0)),n.collapsed?i:i.before(n.extractContents())):i},n.prototype.save=function(t){var n,i,o;return null==t&&(t=this.getRange()),this._selectionSaved?void 0:(i=t.cloneRange(),i.collapse(!1),o=e("<span/>").addClass("simditor-caret-start"),n=e("<span/>").addClass("simditor-caret-end"),i.insertNode(n[0]),t.insertNode(o[0]),this.clear(),this._selectionSaved=!0)},n.prototype.restore=function(){var e,t,n,i,o,a,s;return this._selectionSaved?(o=this.editor.body.find(".simditor-caret-start"),e=this.editor.body.find(".simditor-caret-end"),o.length&&e.length?(a=o.parent(),s=a.contents().index(o),t=e.parent(),n=t.contents().index(e),a[0]===t[0]&&(n-=1),i=document.createRange(),i.setStart(a.get(0),s),i.setEnd(t.get(0),n),o.remove(),e.remove(),this.selectRange(i)):(o.remove(),e.remove()),this._selectionSaved=!1,i):!1},n}(t),d=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return P(n,t),n.pluginName="Formatter",n.prototype.opts={allowedTags:null,allowedAttributes:null},n.prototype._init=function(){return this.editor=this._module,this._allowedTags=this.opts.allowedTags||["br","a","img","b","strong","i","u","font","p","ul","ol","li","blockquote","pre","h1","h2","h3","h4","hr"],this._allowedAttributes=this.opts.allowedAttributes||{img:["src","alt","width","height","data-image-src","data-image-size","data-image-name","data-non-image"],a:["href","target"],font:["color"],pre:["data-lang","class"],p:["data-indent","data-align"],h1:["data-indent"],h2:["data-indent"],h3:["data-indent"],h4:["data-indent"]},this.editor.body.on("click","a",function(){return function(){return!1}}(this))},n.prototype.decorate=function(e){return null==e&&(e=this.editor.body),this.editor.trigger("decorate",[e])},n.prototype.undecorate=function(t){return null==t&&(t=this.editor.body.clone()),this.editor.trigger("undecorate",[t]),e.trim(t.html())},n.prototype.autolink=function(t){var n,i,o,a,s,r,l,c,u,d,h;for(null==t&&(t=this.editor.body),r=[],i=function(n){return n.contents().each(function(n,o){var a,s;return a=e(o),a.is("a")||a.closest("a, pre",t).length?void 0:a.contents().length?i(a):(s=a.text())&&/https?:\/\/|www\./gi.test(s)?r.push(a):void 0})},i(t),c=/(https?:\/\/|www\.)[\w\-\.\?&=\/#%:,@\!\+]+/gi,o=0,s=r.length;s>o;o++){for(n=r[o],d=n.text(),u=[],l=null,a=0;null!==(l=c.exec(d));)u.push(document.createTextNode(d.substring(a,l.index))),a=c.lastIndex,h=/^(http(s)?:\/\/|\/)/.test(l[0])?l[0]:"http://"+l[0],u.push(e('<a href="'+h+'" rel="nofollow"></a>').text(l[0])[0]);u.push(document.createTextNode(d.substring(a))),n.replaceWith(e(u))}return t},n.prototype.format=function(t){var n,i,o,a,s,r,l,c,u,d;if(null==t&&(t=this.editor.body),t.is(":empty"))return t.append("<p>"+this.editor.util.phBr+"</p>"),t;for(u=t.contents(),o=0,s=u.length;s>o;o++)l=u[o],this.cleanNode(l,!0);for(d=t.contents(),a=0,r=d.length;r>a;a++)c=d[a],n=e(c),n.is("br")?("undefined"!=typeof i&&null!==i&&(i=null),n.remove()):this.editor.util.isBlockNode(c)?n.is("li")?i&&i.is("ul, ol")?i.append(c):(i=e("<ul/>").insertBefore(c),i.append(c)):i=null:((!i||i.is("ul, ol"))&&(i=e("<p/>").insertBefore(c)),i.append(c));return t},n.prototype.cleanNode=function(t,n){var i,o,a,s,r,l,c,u,d,h,f,p,m,g,v,E,y;if(o=e(t),o.length>0){if(3===o[0].nodeType)return E=o.text().replace(/(\r\n|\n|\r)/gm,""),void(E?(y=document.createTextNode(E),o.replaceWith(y)):o.remove());if(c=o.contents(),u=o.is('[class^="simditor-"]'),o.is(this._allowedTags.join(","))||u){if(o.is("a")&&(i=o.find("img")).length>0&&(o.replaceWith(i),o=i,c=null),o.is("img")&&o.hasClass("uploading")&&o.remove(),!u)for(r=this._allowedAttributes[o[0].tagName.toLowerCase()],g=e.makeArray(o[0].attributes),d=0,f=g.length;f>d;d++)l=g[d],null!=r&&(v=l.name,M.call(r,v)>=0)||o.removeAttr(l.name)}else 1!==o[0].nodeType||o.is(":empty")?(o.remove(),c=null):o.is("div, article, dl, header, footer, tr")?(o.append("<br/>"),c.first().unwrap()):o.is("table")?(a=e("<p/>"),o.find("tr").each(function(){return function(t,n){return a.append(e(n).text()+"<br/>")}}(this)),o.replaceWith(a),c=null):o.is("thead, tfoot")?(o.remove(),c=null):o.is("th")?(s=e("<td/>").append(o.contents()),o.replaceWith(s)):c.first().unwrap();if(n&&null!=c&&!o.is("pre"))for(h=0,p=c.length;p>h;h++)m=c[h],this.cleanNode(m,!0);return null}},n.prototype.clearHtml=function(t,n){var i,o,a;return null==n&&(n=!0),i=e("<div/>").append(t),o=i.contents(),a="",o.each(function(t){return function(i,s){var r,l;return 3===s.nodeType?a+=s.nodeValue:1===s.nodeType&&(r=e(s),l=r.contents(),l.length>0&&(a+=t.clearHtml(l)),n&&i<o.length-1&&r.is("br, p, div, li, tr, pre, address, artticle, aside, dl, figcaption, footer, h1, h2, h3, h4, header"))?a+="\n":void 0}}(this)),a},n.prototype.beautify=function(t){var n;return n=function(e){return!!(e.is("p")&&!e.text()&&e.children(":not(br)").length<1)},t.each(function(){return function(t,i){var o;return o=e(i),o.is(':not(img, br, col, td, hr, [class^="simditor-"]):empty')&&o.remove(),n(o)&&o.remove(),o.find(':not(img, br, col, td, hr, [class^="simditor-"]):empty').remove()}}(this))},n}(t),v=function(t){function i(){return i.__super__.constructor.apply(this,arguments)}return P(i,t),i.pluginName="InputManager",i.prototype.opts={pasteImage:!1},i.prototype._modifierKeys=[16,17,18,91,93,224],i.prototype._arrowKeys=[37,38,39,40],i.prototype._init=function(){var t;return this.editor=this._module,this.throttledTrigger=this.editor.util.throttle(function(e){return function(){var t;return t=1<=arguments.length?$.call(arguments,0):[],setTimeout(function(){var n;return(n=e.editor).trigger.apply(n,t)},10)}}(this),300),this.opts.pasteImage&&"string"!=typeof this.opts.pasteImage&&(this.opts.pasteImage="inline"),this._keystrokeHandlers={},this.hotkeys=n({el:this.editor.body}),this._pasteArea=e("<div/>").css({width:"1px",height:"1px",overflow:"hidden",position:"fixed",right:"0",bottom:"100px"}).attr({tabIndex:"-1",contentEditable:!0}).addClass("simditor-paste-area").appendTo(this.editor.el),e(document).on("selectionchange.simditor"+this.editor.id,function(e){return function(){return e.focused?(e._selectionTimer&&(clearTimeout(e._selectionTimer),e._selectionTimer=null),e._selectionTimer=setTimeout(function(){return e.editor.trigger("selectionchanged")},20)):void 0}}(this)),this.editor.on("valuechanged",function(t){return function(){return!t.editor.util.closestBlockEl()&&t.focused&&(t.editor.selection.save(),t.editor.formatter.format(),t.editor.selection.restore()),t.editor.body.find("hr, pre, .simditor-table").each(function(n,i){var o,a;return o=e(i),(o.parent().is("blockquote")||o.parent()[0]===t.editor.body[0])&&(a=!1,0===o.next().length&&(e("<p/>").append(t.editor.util.phBr).insertAfter(o),a=!0),0===o.prev().length&&(e("<p/>").append(t.editor.util.phBr).insertBefore(o),a=!0),a)?setTimeout(function(){return t.editor.trigger("valuechanged")},10):void 0}),t.editor.body.find("pre:empty").append(t.editor.util.phBr),!t.editor.util.support.onselectionchange&&t.focused?t.editor.trigger("selectionchanged"):void 0}}(this)),this.editor.on("selectionchanged",function(e){return function(){return e.editor.undoManager.update()}}(this)),this.editor.body.on("keydown",e.proxy(this._onKeyDown,this)).on("keypress",e.proxy(this._onKeyPress,this)).on("keyup",e.proxy(this._onKeyUp,this)).on("mouseup",e.proxy(this._onMouseUp,this)).on("focus",e.proxy(this._onFocus,this)).on("blur",e.proxy(this._onBlur,this)).on("paste",e.proxy(this._onPaste,this)).on("drop",e.proxy(this._onDrop,this)).on("input",e.proxy(this._onInput,this)),this.editor.util.browser.firefox&&(this.addShortcut("cmd+left",function(e){return function(t){return t.preventDefault(),e.editor.selection.sel.modify("move","backward","lineboundary"),!1}}(this)),this.addShortcut("cmd+right",function(e){return function(t){return t.preventDefault(),e.editor.selection.sel.modify("move","forward","lineboundary"),!1}}(this)),this.addShortcut("cmd+a",function(e){return function(){var t,n,i,o;return t=e.editor.body.children(),t.length>0?(n=t.first().get(0),i=t.last().get(0),o=document.createRange(),o.setStart(n,0),o.setEnd(i,e.editor.util.getNodeLength(i)),e.editor.selection.selectRange(o),!1):void 0}}(this))),t=this.editor.util.os.mac?"cmd+enter":"ctrl+enter",this.addShortcut(t,function(e){return function(){return e.editor.el.closest("form").find("button:submit").click(),!1}}(this)),this.editor.textarea.attr("autofocus")?setTimeout(function(e){return function(){return e.editor.focus()}}(this),0):void 0},i.prototype._onFocus=function(){return this.editor.el.addClass("focus").removeClass("error"),this.focused=!0,this.lastCaretPosition=null,setTimeout(function(e){return function(){return e.editor.triggerHandler("focus"),e.editor.trigger("selectionchanged")}}(this),0)},i.prototype._onBlur=function(){var e;return this.editor.el.removeClass("focus"),this.editor.sync(),this.focused=!1,this.lastCaretPosition=null!=(e=this.editor.undoManager.currentState())?e.caret:void 0,this.editor.triggerHandler("blur")},i.prototype._onMouseUp=function(){return this.editor.util.support.onselectionchange?void 0:setTimeout(function(e){return function(){return e.editor.trigger("selectionchanged")}}(this),0)},i.prototype._onKeyDown=function(t){var n,i,o,a;if(this.editor.triggerHandler(t)===!1)return!1;if(!this.hotkeys.respondTo(t)){if(t.which in this._keystrokeHandlers){if(a="function"==typeof(n=this._keystrokeHandlers[t.which])["*"]?n["*"](t):void 0)return this.editor.trigger("valuechanged"),!1;if(this.editor.util.traverseUp(function(n){return function(i){var o,s;if(i.nodeType===document.ELEMENT_NODE)return o=null!=(s=n._keystrokeHandlers[t.which])?s[i.tagName.toLowerCase()]:void 0,a="function"==typeof o?o(t,e(i)):void 0,a===!0||a===!1?!1:void 0}}(this)),a)return this.editor.trigger("valuechanged"),!1}if(i=t.which,!(M.call(this._modifierKeys,i)>=0||(o=t.which,M.call(this._arrowKeys,o)>=0)||this.editor.util.metaKey(t)&&86===t.which))return this.editor.util.support.oninput||this.throttledTrigger("valuechanged",["typing"]),null}},i.prototype._onKeyPress=function(e){return this.editor.triggerHandler(e)===!1?!1:void 0},i.prototype._onKeyUp=function(t){var n,i;return this.editor.triggerHandler(t)===!1?!1:!this.editor.util.support.onselectionchange&&(i=t.which,M.call(this._arrowKeys,i)>=0)?void this.editor.trigger("selectionchanged"):void(8!==t.which&&46!==t.which||!this.editor.util.isEmptyNode(this.editor.body)||(this.editor.body.empty(),n=e("<p/>").append(this.editor.util.phBr).appendTo(this.editor.body),this.editor.selection.setRangeAtStartOf(n)))},i.prototype._onPaste=function(t){var n,i,o,a,s,r,l,c,u;if(this.editor.triggerHandler(t)===!1)return!1;if(l=this.editor.selection.deleteRangeContents(),l.collapsed||l.collapse(!0),n=this.editor.util.closestBlockEl(),i=n.is("pre, table"),t.originalEvent.clipboardData&&t.originalEvent.clipboardData.items&&t.originalEvent.clipboardData.items.length>0&&(s=t.originalEvent.clipboardData.items[0],/^image\//.test(s.type)&&!i)){if(o=s.getAsFile(),null==o||!this.opts.pasteImage)return;return o.name||(o.name="Clipboard Image.png"),u={},u[this.opts.pasteImage]=!0,null!=(c=this.editor.uploader)&&c.upload(o,u),!1}return r=function(t){return function(o){var a,s,r,c,d,h,f,p,m,g,v,E,y,T,b,C,I,D,w,O,R;if(t.editor.triggerHandler("pasting",[o])!==!1&&o){if(i)if(n.is("table")){for(b=o.split("\n"),p=b.pop(),d=0,m=b.length;m>d;d++)T=b[d],t.editor.selection.insertNode(document.createTextNode(T)),t.editor.selection.insertNode(e("<br/>"));t.editor.selection.insertNode(document.createTextNode(p))}else for(o=e("<div/>").text(o),w=o.contents(),h=0,g=w.length;g>h;h++)I=w[h],t.editor.selection.insertNode(e(I)[0],l);else if(n.is(t.editor.body))for(f=0,v=o.length;v>f;f++)I=o[f],t.editor.selection.insertNode(I,l);else{if(o.length<1)return;if(1===o.length)if(o.is("p")){if(r=o.contents(),1===r.length&&r.is("img")){if(a=r,/^data:image/.test(a.attr("src"))){if(!t.opts.pasteImage)return;return s=t.editor.util.dataURLtoBlob(a.attr("src")),s.name="Clipboard Image.png",u={},u[t.opts.pasteImage]=!0,void(null!=(O=t.editor.uploader)&&O.upload(s,u))}if(a.is('img[src^="webkit-fake-url://"]'))return}for(C=0,E=r.length;E>C;C++)I=r[C],t.editor.selection.insertNode(I,l)}else if(n.is("p")&&t.editor.util.isEmptyNode(n))n.replaceWith(o),t.editor.selection.setRangeAtEndOf(o,l);else if(o.is("ul, ol"))if(1===o.find("li").length)for(o=e("<div/>").text(o.text()),R=o.contents(),D=0,y=R.length;y>D;D++)I=R[D],t.editor.selection.insertNode(e(I)[0],l);else n.is("li")?(n.parent().after(o),t.editor.selection.setRangeAtEndOf(o,l)):(n.after(o),t.editor.selection.setRangeAtEndOf(o,l));else n.after(o),t.editor.selection.setRangeAtEndOf(o,l);else n.is("li")&&(n=n.parent()),t.editor.selection.rangeAtStartOf(n,l)?c="before":t.editor.selection.rangeAtEndOf(n,l)?c="after":(t.editor.selection.breakBlockEl(n,l),c="before"),n[c](o),t.editor.selection.setRangeAtEndOf(o.last(),l)}return t.editor.trigger("valuechanged")}}}(this),i?(t.preventDefault(),a=this.editor.util.browser.msie?window.clipboardData.getData("Text"):t.originalEvent.clipboardData.getData("text/plain"),r(a)):(this.editor.selection.save(l),this._pasteArea.focus(),this.editor.util.browser.msie&&10===this.editor.util.browser.version&&(t.preventDefault(),this._pasteArea.html(window.clipboardData.getData("Text"))),setTimeout(function(t){return function(){return t._pasteArea.is(":empty")?a=null:(a=e("<div/>").append(t._pasteArea.contents()),a.find("table colgroup").remove(),t.editor.formatter.format(a),t.editor.formatter.decorate(a),t.editor.formatter.beautify(a.children()),a=a.contents()),t._pasteArea.empty(),l=t.editor.selection.restore(),r(a)}}(this),10))},i.prototype._onDrop=function(e){return this.editor.triggerHandler(e)===!1?!1:setTimeout(function(e){return function(){return e.editor.trigger("valuechanged")}}(this),0)},i.prototype._onInput=function(){return this.throttledTrigger("valuechanged",["oninput"])},i.prototype.addKeystrokeHandler=function(e,t,n){return this._keystrokeHandlers[e]||(this._keystrokeHandlers[e]={}),this._keystrokeHandlers[e][t]=n},i.prototype.addShortcut=function(t,n){return this.hotkeys.add(t,e.proxy(n,this))},i}(t),y=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return P(n,t),n.pluginName="Keystroke",n.prototype._init=function(){var t;return this.editor=this._module,this.editor.util.browser.safari&&this.editor.inputManager.addKeystrokeHandler("13","*",function(t){return function(n){var i,o;if(n.shiftKey&&(i=t.editor.util.closestBlockEl(),!i.is("pre")))return o=e("<br/>"),t.editor.selection.rangeAtEndOf(i)?(t.editor.selection.insertNode(o),t.editor.selection.insertNode(e("<br/>")),t.editor.selection.setRangeBefore(o)):t.editor.selection.insertNode(o),!0}}(this)),(this.editor.util.browser.webkit||this.editor.util.browser.msie)&&(t=function(t){return function(n,i){var o;if(t.editor.selection.rangeAtEndOf(i))return o=e("<p/>").append(t.editor.util.phBr).insertAfter(i),t.editor.selection.setRangeAtStartOf(o),!0}}(this),this.editor.inputManager.addKeystrokeHandler("13","h1",t),this.editor.inputManager.addKeystrokeHandler("13","h2",t),this.editor.inputManager.addKeystrokeHandler("13","h3",t),this.editor.inputManager.addKeystrokeHandler("13","h4",t),this.editor.inputManager.addKeystrokeHandler("13","h5",t),this.editor.inputManager.addKeystrokeHandler("13","h6",t)),this.editor.inputManager.addKeystrokeHandler("8","*",function(e){return function(){var t,n,i;return i=e.editor.util.furthestBlockEl(),n=i.prev(),n.is("hr")&&e.editor.selection.rangeAtStartOf(i)?(e.editor.selection.save(),n.remove(),e.editor.selection.restore(),!0):(t=e.editor.util.closestBlockEl(),e.editor.util.browser.webkit&&e.editor.selection.rangeAtStartOf(t)?(e.editor.selection.save(),e.editor.formatter.cleanNode(t,!0),e.editor.selection.restore(),null):void 0)}}(this)),this.editor.inputManager.addKeystrokeHandler("13","li",function(t){return function(n,i){var o,a,s,r;if(o=i.clone(),o.find("ul, ol").remove(),t.editor.util.isEmptyNode(o)&&i.is(t.editor.util.closestBlockEl())){if(a=i.parent(),i.next("li").length>0){if(!t.editor.util.isEmptyNode(i))return;a.parent("li").length>0?(s=e("<li/>").append(t.editor.util.phBr).insertAfter(a.parent("li")),r=e("<"+a[0].tagName+"/>").append(i.nextAll("li")),s.append(r)):(s=e("<p/>").append(t.editor.util.phBr).insertAfter(a),r=e("<"+a[0].tagName+"/>").append(i.nextAll("li")),s.after(r))}else a.parent("li").length>0?(s=e("<li/>").insertAfter(a.parent("li")),s.append(i.contents().length>0?i.contents():t.editor.util.phBr)):(s=e("<p/>").append(t.editor.util.phBr).insertAfter(a),i.children("ul, ol").length>0&&s.after(i.children("ul, ol")));return i.prev("li").length?i.remove():a.remove(),t.editor.selection.setRangeAtStartOf(s),!0}}}(this)),this.editor.inputManager.addKeystrokeHandler("13","pre",function(t){return function(n,i){var o,a,s;return n.preventDefault(),n.shiftKey?(o=e("<p/>").append(t.editor.util.phBr).insertAfter(i),t.editor.selection.setRangeAtStartOf(o),!0):(s=t.editor.selection.getRange(),a=null,s.deleteContents(),!t.editor.util.browser.msie&&t.editor.selection.rangeAtEndOf(i)?(a=document.createTextNode("\n\n"),s.insertNode(a),s.setEnd(a,1)):(a=document.createTextNode("\n"),s.insertNode(a),s.setStartAfter(a)),s.collapse(!1),t.editor.selection.selectRange(s),!0)}}(this)),this.editor.inputManager.addKeystrokeHandler("13","blockquote",function(e){return function(t,n){var i,o;return i=e.editor.util.closestBlockEl(),i.is("p")&&!i.next().length&&e.editor.util.isEmptyNode(i)?(n.after(i),o=document.createRange(),e.editor.selection.setRangeAtStartOf(i,o),!0):void 0}}(this)),this.editor.inputManager.addKeystrokeHandler("8","li",function(t){return function(n,i){var o,a,s,r,l,c,u,d;return a=i.children("ul, ol"),l=i.prev("li"),a.length>0&&l.length>0?(d="",c=null,i.contents().each(function(t,n){if(1===n.nodeType&&/UL|OL/.test(n.nodeName))return!1;if(1!==n.nodeType||!/BR/.test(n.nodeName))return 3===n.nodeType&&n.nodeValue?d+=n.nodeValue:1===n.nodeType&&(d+=e(n).text()),c=e(n)}),c&&1===d.length&&t.editor.util.browser.firefox&&!c.next("br").length?(o=e(t.editor.util.phBr).insertAfter(c),c.remove(),t.editor.selection.setRangeBefore(o),!0):d.length>0?!1:(u=document.createRange(),r=l.children("ul, ol"),r.length>0?(s=e("<li/>").append(t.editor.util.phBr).appendTo(r),r.append(a.children("li")),i.remove(),t.editor.selection.setRangeAtEndOf(s,u)):(t.editor.selection.setRangeAtEndOf(l,u),l.append(a),i.remove(),t.editor.selection.selectRange(u)),!0)):!1}}(this)),this.editor.inputManager.addKeystrokeHandler("8","pre",function(t){return function(n,i){var o,a,s;if(t.editor.selection.rangeAtStartOf(i))return a=i.html().replace("\n","<br/>"),o=e("<p/>").append(a||t.editor.util.phBr).insertAfter(i),i.remove(),s=document.createRange(),t.editor.selection.setRangeAtStartOf(o,s),!0}}(this)),this.editor.inputManager.addKeystrokeHandler("8","blockquote",function(e){return function(t,n){var i,o;if(e.editor.selection.rangeAtStartOf(n))return i=n.children().first().unwrap(),o=document.createRange(),e.editor.selection.setRangeAtStartOf(i,o),!0}}(this))},n}(t),N=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return P(n,t),n.pluginName="UndoManager",n.prototype._index=-1,n.prototype._capacity=50,n.prototype._timer=null,n.prototype._init=function(){var e,t;return this.editor=this._module,this._stack=[],this.editor.util.os.mac?(t="cmd+z",e="shift+cmd+z"):this.editor.util.os.win?(t="ctrl+z",e="ctrl+y"):(t="ctrl+z",e="shift+ctrl+z"),this.editor.inputManager.addShortcut(t,function(e){return function(t){return t.preventDefault(),e.undo(),!1}}(this)),this.editor.inputManager.addShortcut(e,function(e){return function(t){return t.preventDefault(),e.redo(),!1}}(this)),this.editor.on("valuechanged",function(e){return function(t,n){return"undo"!==n&&"redo"!==n?(e._timer&&(clearTimeout(e._timer),e._timer=null),e._timer=setTimeout(function(){return e._pushUndoState(),e._timer=null},200)):void 0}}(this))},n.prototype._pushUndoState=function(){var e,t;if(this.editor.triggerHandler("pushundostate")!==!1&&(e=this.currentState(),t=this.editor.body.html(),!e||e.html!==t))return this._index+=1,this._stack.length=this._index,this._stack.push({html:t,caret:this.caretPosition()}),this._stack.length>this._capacity?(this._stack.shift(),this._index-=1):void 0},n.prototype.currentState=function(){return this._stack.length&&this._index>-1?this._stack[this._index]:null},n.prototype.undo=function(){var e;if(!(this._index<1||this._stack.length<2))return this.editor.hidePopover(),this._index-=1,e=this._stack[this._index],this.editor.body.html(e.html),this.caretPosition(e.caret),this.editor.body.find(".selected").removeClass("selected"),this.editor.sync(),this.editor.trigger("valuechanged",["undo"])},n.prototype.redo=function(){var e;if(!(this._index<0||this._stack.length<this._index+2))return this.editor.hidePopover(),this._index+=1,e=this._stack[this._index],this.editor.body.html(e.html),this.caretPosition(e.caret),this.editor.body.find(".selected").removeClass("selected"),this.editor.sync(),this.editor.trigger("valuechanged",["redo"])},n.prototype.update=function(){var e,t;if(!this._timer&&(e=this.currentState()))return t=this.editor.body.html(),e.html=t,e.caret=this.caretPosition()},n.prototype._getNodeOffset=function(t,n){var i,o,a;return i=n?e(t):e(t).parent(),a=0,o=!1,i.contents().each(function(){return function(e,i){return n===e||t===i?!1:(3===i.nodeType?o||(a+=1,o=!0):(a+=1,o=!1),null)}}(this)),a},n.prototype._getNodePosition=function(e,t){var n,i;if(3===e.nodeType)for(i=e.previousSibling;i&&3===i.nodeType;)e=i,t+=this.editor.util.getNodeLength(i),i=i.previousSibling;else t=this._getNodeOffset(e,t);return n=[],n.unshift(t),this.editor.util.traverseUp(function(e){return function(t){return n.unshift(e._getNodeOffset(t))}}(this),e),n},n.prototype._getNodeByPosition=function(t){var n,i,o,a,s,r,l,c;for(r=this.editor.body[0],c=t.slice(0,t.length-1),o=a=0,s=c.length;s>a;o=++a){if(l=c[o],i=r.childNodes,l>i.length-1){if(o!==t.length-2||!e(r).is("pre")){r=null;break}n=document.createTextNode(""),r.appendChild(n),i=r.childNodes}r=i[l]}return r},n.prototype.caretPosition=function(e){var t,n,i,o,a;if(e){if(this.editor.inputManager.focused||this.editor.body.focus(),!e.start)return void this.editor.body.blur();if(o=this._getNodeByPosition(e.start),a=e.start[e.start.length-1],e.collapsed?(t=o,n=a):(t=this._getNodeByPosition(e.end),n=e.start[e.start.length-1]),!o||!t)throw new Error("simditor: invalid caret state");return i=document.createRange(),i.setStart(o,a),i.setEnd(t,n),this.editor.selection.selectRange(i)}return i=this.editor.selection.getRange(),this.editor.inputManager.focused&&null!=i?(e={start:[],end:null,collapsed:!0},e.start=this._getNodePosition(i.startContainer,i.startOffset),i.collapsed||(e.end=this._getNodePosition(i.endContainer,i.endOffset),e.collapsed=!1),e):{}},n}(t),L=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return P(n,t),n.pluginName="Util",n.prototype._init=function(){return this.editor=this._module,this.browser.msie&&this.browser.version<11?this.phBr="":void 0},n.prototype.phBr="<br/>",n.prototype.os=function(){var e;return e={},/Mac/.test(navigator.appVersion)?e.mac=!0:/Linux/.test(navigator.appVersion)?e.linux=!0:/Win/.test(navigator.appVersion)?e.win=!0:/X11/.test(navigator.appVersion)&&(e.unix=!0),/Mobi/.test(navigator.appVersion)&&(e.mobile=!0),e}(),n.prototype.browser=function(){var e,t,n,i,o,a,s,r,l;return l=navigator.userAgent,n=/(msie|trident)/i.test(l),e=/chrome|crios/i.test(l),r=/safari/i.test(l)&&!e,t=/firefox/i.test(l),n?{msie:!0,version:1*(null!=(i=l.match(/(msie |rv:)(\d+(\.\d+)?)/i))?i[2]:void 0)}:e?{webkit:!0,chrome:!0,version:1*(null!=(o=l.match(/(?:chrome|crios)\/(\d+(\.\d+)?)/i))?o[1]:void 0)}:r?{webkit:!0,safari:!0,version:1*(null!=(a=l.match(/version\/(\d+(\.\d+)?)/i))?a[1]:void 0)}:t?{mozilla:!0,firefox:!0,version:1*(null!=(s=l.match(/firefox\/(\d+(\.\d+)?)/i))?s[1]:void 0)}:{}}(),n.prototype.support=function(){return{onselectionchange:function(){var e,t;if(t=document.onselectionchange,void 0!==t)try{return document.onselectionchange=0,null===document.onselectionchange}catch(n){e=n}finally{document.onselectionchange=t}return!1}(),oninput:function(){return!/(msie|trident)/i.test(navigator.userAgent)}()}}(),n.prototype.reflow=function(t){return null==t&&(t=document),e(t)[0].offsetHeight},n.prototype.metaKey=function(e){var t;return t=/Mac/.test(navigator.userAgent),t?e.metaKey:e.ctrlKey},n.prototype.isEmptyNode=function(t){var n;return n=e(t),n.is(":empty")||!n.text()&&!n.find(":not(br, span, div)").length},n.prototype.blockNodes=["div","p","ul","ol","li","blockquote","hr","pre","h1","h2","h3","h4","table"],n.prototype.isBlockNode=function(t){return t=e(t)[0],t&&3!==t.nodeType?new RegExp("^("+this.blockNodes.join("|")+")$").test(t.nodeName.toLowerCase()):!1},n.prototype.closestBlockEl=function(t){var n,i,o;return null==t&&(o=this.editor.selection.getRange(),t=null!=o?o.commonAncestorContainer:void 0),n=e(t),n.length?(i=n.parentsUntil(this.editor.body).addBack(),i=i.filter(function(e){return function(t){return e.isBlockNode(i.eq(t))}}(this)),i.length?i.last():null):null},n.prototype.furthestNode=function(t,n){var i,o,a;return null==t&&(a=this.editor.selection.getRange(),t=null!=a?a.commonAncestorContainer:void 0),i=e(t),i.length?(o=i.parentsUntil(this.editor.body).addBack(),o=o.filter(function(){return function(t){var i;return i=o.eq(t),e.isFunction(n)?n(i):i.is(n)}}(this)),o.length?o.first():null):null},n.prototype.furthestBlockEl=function(t){return this.furthestNode(t,e.proxy(this.isBlockNode,this))},n.prototype.getNodeLength=function(e){switch(e.nodeType){case 7:case 10:return 0;case 3:case 8:return e.length;default:return e.childNodes.length}},n.prototype.traverseUp=function(t,n){var i,o,a,s,r,l,c;if(null==n&&(r=this.editor.selection.getRange(),n=null!=r?r.commonAncestorContainer:void 0),null==n||!e.contains(this.editor.body[0],n))return!1;for(s=e(n).parentsUntil(this.editor.body).get(),s.unshift(n),c=[],i=0,o=s.length;o>i&&(a=s[i],l=t(a),l!==!1);i++)c.push(void 0);return c},n.prototype.dataURLtoBlob=function(e){var t,n,i,o,a,s,r,l,c,u,d;if(s=window.Blob&&function(){var e;try{return Boolean(new Blob)}catch(t){return e=t,!1}}(),a=s&&window.Uint8Array&&function(){var e;try{return 100===new Blob([new Uint8Array(100)]).size}catch(t){return e=t,!1}}(),t=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder,!((s||t)&&window.atob&&window.ArrayBuffer&&window.Uint8Array))return!1;for(o=e.split(",")[0].indexOf("base64")>=0?atob(e.split(",")[1]):decodeURIComponent(e.split(",")[1]),n=new ArrayBuffer(o.length),l=new Uint8Array(n),r=c=0,d=o.length;d>=0?d>=c:c>=d;r=d>=0?++c:--c)l[r]=o.charCodeAt(r);return u=e.split(",")[0].split(":")[1].split(";")[0],s?new Blob([a?l:n],{type:u}):(i=new t,i.append(n),i.getBlob(u))},n.prototype.throttle=function(e,t){var n,i,o;return n=null,i=0,o=function(){return n?(clearTimeout(n),n=null):void 0},function(){var a,s,r,l;return s=Date.now(),i||(i=s),r=t-(s-i),l=null,r>0&&t>r?(i=s,o(),a=arguments,n=setTimeout(function(){return i=0,n=null,l=e.apply(null,a)},t)):(o(),i!==s&&(i=0),l=e.apply(null,arguments)),l}},n.prototype.formatHTML=function(t){var n,i,o,a,s,r,l,c,u;for(r=/<(\/?)(.+?)(\/?)>/g,c="",a=0,o=null,i="  ",l=function(e,t){return new Array(t+1).join(e)};null!==(s=r.exec(t));)s.isBlockNode=e.inArray(s[2],this.blockNodes)>-1,s.isStartTag="/"!==s[1]&&"/"!==s[3],s.isEndTag="/"===s[1]||"/"===s[3],n=o?o.index+o[0].length:0,(u=t.substring(n,s.index)).length>0&&e.trim(u)&&(c+=u),s.isBlockNode&&s.isEndTag&&!s.isStartTag&&(a-=1),s.isBlockNode&&s.isStartTag&&(o&&o.isBlockNode&&o.isEndTag||(c+="\n"),c+=l(i,a)),c+=s[0],s.isBlockNode&&s.isEndTag&&(c+="\n"),s.isBlockNode&&s.isStartTag&&(a+=1),o=s;return e.trim(c)},n}(t),S=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return P(n,t),n.pluginName="Toolbar",n.prototype.opts={toolbar:!0,toolbarFloat:!0,toolbarHidden:!1,toolbarFloatOffset:0},n.prototype._tpl={wrapper:'<div class="simditor-toolbar"><ul></ul></div>',separator:'<li><span class="separator"></span></li>'},n.prototype._init=function(){var t;return this.editor=this._module,this.opts.toolbar?(e.isArray(this.opts.toolbar)||(this.opts.toolbar=["bold","italic","underline","strikethrough","|","ol","ul","blockquote","code","|","link","image","|","indent","outdent"]),this._render(),this.list.on("click",function(){return function(){return!1}}(this)),this.wrapper.on("mousedown",function(e){return function(){return e.list.find(".menu-on").removeClass(".menu-on")}}(this)),e(document).on("mousedown.simditor"+this.editor.id,function(e){return function(){return e.list.find(".menu-on").removeClass(".menu-on")}}(this)),!this.opts.toolbarHidden&&this.opts.toolbarFloat&&(this.wrapper.css("top",this.opts.toolbarFloatOffset),t=0,e(window).on("resize.simditor-"+this.editor.id,function(e){return function(){return e.wrapper.css("position","static"),e.wrapper.width("auto"),e.editor.util.reflow(e.wrapper),e.wrapper.width(e.wrapper.outerWidth()),e.wrapper.css("left",e.wrapper.offset().left),e.wrapper.css("position",""),t=e.wrapper.outerHeight(),e.editor.placeholderEl.css("top",t)
}}(this)).resize(),e(window).on("scroll.simditor-"+this.editor.id,function(n){return function(){var i,o,a;if(a=n.editor.wrapper.offset().top,i=a+n.editor.wrapper.outerHeight()-80,o=e(document).scrollTop()+n.opts.toolbarFloatOffset,a>=o||o>=i){if(n.editor.wrapper.removeClass("toolbar-floating").css("padding-top",""),n.editor.util.os.mobile)return n.wrapper.css("top",n.opts.toolbarFloatOffset)}else if(n.editor.wrapper.addClass("toolbar-floating").css("padding-top",t),n.editor.util.os.mobile)return n.wrapper.css("top",o-a+n.opts.toolbarFloatOffset)}}(this))),this.editor.on("selectionchanged",function(e){return function(){return e.toolbarStatus()}}(this)),this.editor.on("destroy",function(e){return function(){return e.buttons.length=0}}(this)),e(document).on("mousedown.simditor-"+this.editor.id,function(e){return function(){return e.list.find("li.menu-on").removeClass("menu-on")}}(this))):void 0},n.prototype._render=function(){var t,n,i,o;for(this.buttons=[],this.wrapper=e(this._tpl.wrapper).prependTo(this.editor.wrapper),this.list=this.wrapper.find("ul"),o=this.opts.toolbar,t=0,n=o.length;n>t;t++)if(i=o[t],"|"!==i){if(!this.constructor.buttons[i])throw new Error('simditor: invalid toolbar button "'+i+'"');this.buttons.push(new this.constructor.buttons[i]({editor:this.editor}))}else e(this._tpl.separator).appendTo(this.list);return this.opts.toolbarHidden?this.wrapper.hide():void 0},n.prototype.toolbarStatus=function(t){var n;if(this.editor.inputManager.focused)return n=this.buttons.slice(0),this.editor.util.traverseUp(function(){return function(i){var o,a,s,r,l,c,u;for(u=[],a=s=0,l=n.length;l>s;a=++s)o=n[a],(null==t||o.name===t)&&(o.status&&o.status(e(i))!==!0||u.push(o));for(r=0,c=u.length;c>r;r++)o=u[r],a=e.inArray(o,n),n.splice(a,1);return 0===n.length?!1:void 0}}(this))},n.prototype.findButton=function(e){var t;return t=this.list.find(".toolbar-item-"+e).data("button"),null!=t?t:null},n.addButton=function(e){return this.buttons[e.prototype.name]=e},n.buttons={},n}(t),g=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return P(n,t),n.pluginName="Indentation",n.prototype.opts={tabIndent:!0},n.prototype._init=function(){return this.editor=this._module,this.editor.inputManager.addKeystrokeHandler("9","*",function(e){return function(t){var n;return n=e.editor.toolbar.findButton("code"),e.opts.tabIndent||n&&n.active?e.indent(t.shiftKey):void 0}}(this))},n.prototype.indent=function(e){var t,n,i,o,a;return(o=this.editor.selection.getRange())?(i=this.editor.util.closestBlockEl(o.startContainer),n=this.editor.util.closestBlockEl(o.endContainer),i.is("li")&&n.is("li")&&i.parent().is(n.parent())||(i=this.editor.util.furthestBlockEl(i),n=this.editor.util.furthestBlockEl(n)),t=i.is(n)?i:i.nextUntil(n).add(i).add(n),a=!1,t.each(function(t){return function(n,i){return a=e?t.outdentBlock(i):t.indentBlock(i)}}(this)),a):void 0},n.prototype.indentBlock=function(t){var n,i,o,a,s,r,l,c,u;if(n=e(t),n.length){if(n.is("pre")){if(c=this.editor.selection.getRange(),s=e(c.commonAncestorContainer),!s.is(n)&&!s.closest("pre").is(n))return;this.indentText(c)}else if(n.is("li")){if(a=n.prev("li"),a.length<1)return;this.editor.selection.save(),u=n.parent()[0].tagName,i=a.children("ul, ol"),i.length>0?i.append(n):e("<"+u+"/>").append(n).appendTo(a),this.editor.selection.restore()}else if(n.is("p, h1, h2, h3, h4"))l=n.attr("data-indent")||0,l=Math.min(1*l+1,10),n.attr("data-indent",l);else if(n.is("table")||n.is(".simditor-table")){if(c=this.editor.selection.getRange(),r=e(c.commonAncestorContainer).closest("td"),o=r.next("td"),o.length>0||(o=r.parent("tr").next("tr").find("td:first")),!(r.length>0&&o.length>0))return!1;this.editor.selection.setRangeAtEndOf(o)}return!0}},n.prototype.indentText=function(e){var t,n;return t=e.toString().replace(/^(?=.+)/gm,"\xa0\xa0"),n=document.createTextNode(t||"\xa0\xa0"),e.deleteContents(),e.insertNode(n),t?(e.selectNode(n),this.editor.selection.selectRange(e)):this.editor.selection.setRangeAfter(n)},n.prototype.outdentBlock=function(t){var n,i,o,a,s,r,l,c,u,d;if(n=e(t),n&&n.length>0){if(n.is("pre")){if(u=this.editor.selection.getRange(),a=e(u.commonAncestorContainer),!a.is(n)&&!a.closest("pre").is(n))return;this.outdentText(u)}else if(n.is("li")){if(i=n.parent(),o=i.parent("li"),o.length<1)return l=this.editor.toolbar.findButton(i[0].tagName.toLowerCase()),void(null!=l&&l.command());this.editor.selection.save(),n.next("li").length>0&&e("<"+i[0].tagName+"/>").append(n.nextAll("li")).appendTo(n),n.insertAfter(o),i.children("li").length<1&&i.remove(),this.editor.selection.restore()}else if(n.is("p, h1, h2, h3, h4"))c=null!=(d=n.attr("data-indent"))?d:0,c=1*c-1,0>c&&(c=0),n.attr("data-indent",c);else if(n.is("table")||n.is(".simditor-table")){if(u=this.editor.selection.getRange(),r=e(u.commonAncestorContainer).closest("td"),s=r.prev("td"),s.length>0||(s=r.parent("tr").prev("tr").find("td:last")),!(r.length>0&&s.length>0))return;this.editor.selection.setRangeAtEndOf(s)}return!0}},n.prototype.outdentText=function(){},n}(t),R=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return P(n,t),n.connect(L),n.connect(v),n.connect(N),n.connect(y),n.connect(d),n.connect(O),n.connect(S),n.connect(g),n.count=0,n.prototype.opts={textarea:null,placeholder:"",defaultImage:"images/image.png",params:{},upload:!1},n.prototype._init=function(){var t,o,a,s;if(this.textarea=e(this.opts.textarea),this.opts.placeholder=this.opts.placeholder||this.textarea.attr("placeholder"),!this.textarea.length)throw new Error("simditor: param textarea is required.");if(o=this.textarea.data("simditor"),null!=o&&o.destroy(),this.id=++n.count,this._render(),this.opts.upload&&i&&(s="object"==typeof this.opts.upload?this.opts.upload:{},this.uploader=i(s)),a=this.textarea.closest("form"),a.length&&(a.on("submit.simditor-"+this.id,function(e){return function(){return e.sync()}}(this)),a.on("reset.simditor-"+this.id,function(e){return function(){return e.setValue("")}}(this))),this.on("initialized",function(e){return function(){return e.opts.placeholder&&e.on("valuechanged",function(){return e._placeholder()}),e.setValue(e.textarea.val().trim()||"")}}(this)),this.util.browser.mozilla){this.util.reflow();try{return document.execCommand("enableObjectResizing",!1,!1),document.execCommand("enableInlineTableEditing",!1,!1)}catch(r){t=r}}},n.prototype._tpl='<div class="simditor">\n  <div class="simditor-wrapper">\n    <div class="simditor-placeholder"></div>\n    <div class="simditor-body" contenteditable="true">\n    </div>\n  </div>\n</div>',n.prototype._render=function(){var t,n,i,o;if(this.el=e(this._tpl).insertBefore(this.textarea),this.wrapper=this.el.find(".simditor-wrapper"),this.body=this.wrapper.find(".simditor-body"),this.placeholderEl=this.wrapper.find(".simditor-placeholder").append(this.opts.placeholder),this.el.data("simditor",this),this.wrapper.append(this.textarea),this.textarea.data("simditor",this).blur(),this.body.attr("tabindex",this.textarea.attr("tabindex")),this.util.os.mac?this.el.addClass("simditor-mac"):this.util.os.linux&&this.el.addClass("simditor-linux"),this.util.os.mobile&&this.el.addClass("simditor-mobile"),this.opts.params){n=this.opts.params,i=[];for(t in n)o=n[t],i.push(e("<input/>",{type:"hidden",name:t,value:o}).insertAfter(this.textarea));return i}},n.prototype._placeholder=function(){var e,t;return e=this.body.children(),0===e.length||1===e.length&&this.util.isEmptyNode(e)&&(null!=(t=e.data("indent"))?t:0)<1?this.placeholderEl.show():this.placeholderEl.hide()},n.prototype.setValue=function(e){return this.hidePopover(),this.textarea.val(e),this.body.html(e),this.formatter.format(),this.formatter.decorate(),this.util.reflow(this.body),this.inputManager.lastCaretPosition=null,this.trigger("valuechanged")},n.prototype.getValue=function(){return this.sync()},n.prototype.sync=function(){var t,n,i,o,a,s;for(n=this.body.clone(),this.formatter.undecorate(n),this.formatter.format(n),this.formatter.autolink(n),t=n.children(),a=t.last("p"),o=t.first("p");a.is("p")&&this.util.isEmptyNode(a);)i=a,a=a.prev("p"),i.remove();for(;o.is("p")&&this.util.isEmptyNode(o);)i=o,o=a.next("p"),i.remove();return n.find("img.uploading").remove(),s=e.trim(n.html()),this.textarea.val(s),s},n.prototype.focus=function(){var t,n;return this.body.is(":visible")&&this.body.is("[contenteditable]")?this.inputManager.lastCaretPosition?this.undoManager.caretPosition(this.inputManager.lastCaretPosition):(t=this.body.find("p").last(),t.length>0||(t=e("<p/>").append(this.util.phBr).appendTo(this.body)),n=document.createRange(),this.selection.setRangeAtEndOf(t,n),this.body.focus()):void this.el.find("textarea:visible").focus()},n.prototype.blur=function(){return this.body.is(":visible")&&this.body.is("[contenteditable]")?this.body.blur():this.body.find("textarea:visible").blur()},n.prototype.hidePopover=function(){return this.el.find(".simditor-popover").each(function(){return function(t,n){return n=e(n).data("popover"),n.active?n.hide():void 0}}(this))},n.prototype.destroy=function(){return this.triggerHandler("destroy"),this.textarea.closest("form").off(".simditor .simditor-"+this.id),this.selection.clear(),this.inputManager.focused=!1,this.textarea.insertBefore(this.el).hide().val("").removeData("simditor"),this.el.remove(),e(document).off(".simditor-"+this.id),e(window).off(".simditor-"+this.id),this.off()},n}(t),R.i18n={"zh-CN":{blockquote:"\u5f15\u7528",bold:"\u52a0\u7c97\u6587\u5b57",code:"\u63d2\u5165\u4ee3\u7801",color:"\u6587\u5b57\u989c\u8272",hr:"\u5206\u9694\u7ebf",image:"\u63d2\u5165\u56fe\u7247",externalImage:"\u5916\u94fe\u56fe\u7247",uploadImage:"\u4e0a\u4f20\u56fe\u7247",uploadFailed:"\u4e0a\u4f20\u5931\u8d25\u4e86",uploadError:"\u4e0a\u4f20\u51fa\u9519\u4e86",imageUrl:"\u56fe\u7247\u5730\u5740",imageSize:"\u56fe\u7247\u5c3a\u5bf8",imageAlt:"\u56fe\u7247\u63cf\u8ff0",restoreImageSize:"\u8fd8\u539f\u56fe\u7247\u5c3a\u5bf8",uploading:"\u6b63\u5728\u4e0a\u4f20",indent:"\u5411\u53f3\u7f29\u8fdb",outdent:"\u5411\u5de6\u7f29\u8fdb",italic:"\u659c\u4f53\u6587\u5b57",link:"\u63d2\u5165\u94fe\u63a5",text:"\u6587\u672c",linkText:"\u94fe\u63a5\u6587\u5b57",linkUrl:"\u5730\u5740",removeLink:"\u79fb\u9664\u94fe\u63a5",ol:"\u6709\u5e8f\u5217\u8868",ul:"\u65e0\u5e8f\u5217\u8868",strikethrough:"\u5220\u9664\u7ebf\u6587\u5b57",table:"\u8868\u683c",deleteRow:"\u5220\u9664\u884c",insertRowAbove:"\u5728\u4e0a\u9762\u63d2\u5165\u884c",insertRowBelow:"\u5728\u4e0b\u9762\u63d2\u5165\u884c",deleteColumn:"\u5220\u9664\u5217",insertColumnLeft:"\u5728\u5de6\u8fb9\u63d2\u5165\u5217",insertColumnRight:"\u5728\u53f3\u8fb9\u63d2\u5165\u5217",deleteTable:"\u5220\u9664\u8868\u683c",title:"\u6807\u9898",normalText:"\u666e\u901a\u6587\u672c",underline:"\u4e0b\u5212\u7ebf\u6587\u5b57",alignment:"\u6392\u7248",alignCenter:"\u5c45\u4e2d",alignLeft:"\u5c45\u5de6",alignRight:"\u5c45\u53f3"}},r=function(t){function n(e){this.editor=e.editor,this.title=this._t(this.name),n.__super__.constructor.call(this,e)}return P(n,t),n.prototype._tpl={item:'<li><a tabindex="-1" unselectable="on" class="toolbar-item" href="javascript:;"><span></span></a></li>',menuWrapper:'<div class="toolbar-menu"></div>',menuItem:'<li><a tabindex="-1" unselectable="on" class="menu-item" href="javascript:;"><span></span></a></li>',separator:'<li><span class="separator"></span></li>'},n.prototype.name="",n.prototype.icon="",n.prototype.title="",n.prototype.text="",n.prototype.htmlTag="",n.prototype.disableTag="",n.prototype.menu=!1,n.prototype.active=!1,n.prototype.disabled=!1,n.prototype.needFocus=!0,n.prototype.shortcut=null,n.prototype._init=function(){var t,n,i,o,a;for(this.render(),this.el.on("mousedown",function(e){return function(t){var n,i;return t.preventDefault(),e.el.hasClass("disabled")||e.needFocus&&!e.editor.inputManager.focused?!1:e.menu?(e.wrapper.toggleClass("menu-on").siblings("li").removeClass("menu-on"),e.wrapper.is(".menu-on")&&(n=e.menuWrapper.offset().left+e.menuWrapper.outerWidth()+5-e.editor.wrapper.offset().left-e.editor.wrapper.outerWidth(),n>0&&e.menuWrapper.css({left:"auto",right:0}),e.trigger("menuexpand")),!1):(i=e.el.data("param"),e.command(i),!1)}}(this)),this.wrapper.on("click","a.menu-item",function(t){return function(n){var i,o;return n.preventDefault(),i=e(n.currentTarget),t.wrapper.removeClass("menu-on"),i.hasClass("disabled")||t.needFocus&&!t.editor.inputManager.focused?!1:(t.editor.toolbar.wrapper.removeClass("menu-on"),o=i.data("param"),t.command(o),!1)}}(this)),this.wrapper.on("mousedown","a.menu-item",function(){return function(){return!1}}(this)),this.editor.on("blur",function(e){return function(){return e.editor.body.is(":visible")&&e.editor.body.is("[contenteditable]")?(e.setActive(!1),e.setDisabled(!1)):void 0}}(this)),null!=this.shortcut&&this.editor.inputManager.addShortcut(this.shortcut,function(e){return function(){return e.el.mousedown(),!1}}(this)),i=this.htmlTag.split(","),o=[],t=0,n=i.length;n>t;t++)a=i[t],a=e.trim(a),o.push(a&&e.inArray(a,this.editor.formatter._allowedTags)<0?this.editor.formatter._allowedTags.push(a):void 0);return o},n.prototype.iconClassOf=function(e){return e?"simditor-icon simditor-icon-"+e:""},n.prototype.setIcon=function(e){return this.el.find("span").removeClass().addClass(this.iconClassOf(e)).text(this.text)},n.prototype.render=function(){return this.wrapper=e(this._tpl.item).appendTo(this.editor.toolbar.list),this.el=this.wrapper.find("a.toolbar-item"),this.el.attr("title",this.title).addClass("toolbar-item-"+this.name).data("button",this),this.setIcon(this.icon),this.menu?(this.menuWrapper=e(this._tpl.menuWrapper).appendTo(this.wrapper),this.menuWrapper.addClass("toolbar-menu-"+this.name),this.renderMenu()):void 0},n.prototype.renderMenu=function(){var t,n,i,o,a,s,r,l;if(e.isArray(this.menu)){for(this.menuEl=e("<ul/>").appendTo(this.menuWrapper),s=this.menu,l=[],i=0,o=s.length;o>i;i++)a=s[i],"|"!==a?(n=e(this._tpl.menuItem).appendTo(this.menuEl),t=n.find("a.menu-item").attr({title:null!=(r=a.title)?r:a.text,"data-param":a.param}).addClass("menu-item-"+a.name),l.push(a.icon?t.find("span").addClass(this.iconClassOf(a.icon)):t.find("span").text(a.text))):e(this._tpl.separator).appendTo(this.menuEl);return l}},n.prototype.setActive=function(e){return e!==this.active?(this.active=e,this.el.toggleClass("active",this.active),this.editor.toolbar.trigger("buttonstatus",[this])):void 0},n.prototype.setDisabled=function(e){return e!==this.disabled?(this.disabled=e,this.el.toggleClass("disabled",this.disabled),this.editor.toolbar.trigger("buttonstatus",[this])):void 0},n.prototype.status=function(e){return null!=e&&this.setDisabled(e.is(this.disableTag)),this.disabled?!0:(null!=e&&this.setActive(e.is(this.htmlTag)),this.active)},n.prototype.command=function(){},n.prototype._t=function(){var e,t,i;return e=1<=arguments.length?$.call(arguments,0):[],i=n.__super__._t.apply(this,e),i||(i=(t=this.editor)._t.apply(t,e)),i},n}(t),R.Button=r,w=function(t){function n(e){this.button=e.button,this.editor=e.button.editor,n.__super__.constructor.call(this,e)}return P(n,t),n.prototype.offset={top:4,left:0},n.prototype.target=null,n.prototype.active=!1,n.prototype._init=function(){return this.el=e('<div class="simditor-popover"></div>').appendTo(this.editor.el).data("popover",this),this.render(),this.el.on("mouseenter",function(e){return function(){return e.el.addClass("hover")}}(this)),this.el.on("mouseleave",function(e){return function(){return e.el.removeClass("hover")}}(this))},n.prototype.render=function(){},n.prototype.show=function(t,n){return null==n&&(n="bottom"),null!=t?(this.el.siblings(".simditor-popover").each(function(){return function(t,n){return n=e(n).data("popover"),n.active?n.hide():void 0}}(this)),this.target=t.addClass("selected"),this.active?(this.refresh(n),this.trigger("popovershow")):(this.active=!0,this.el.css({left:-9999}).show(),setTimeout(function(e){return function(){return e.refresh(n),e.trigger("popovershow")}}(this),0))):void 0},n.prototype.hide=function(){return this.active?(this.target&&this.target.removeClass("selected"),this.target=null,this.active=!1,this.el.hide(),this.trigger("popoverhide")):void 0},n.prototype.refresh=function(e){var t,n,i,o,a;return null==e&&(e="bottom"),this.active?(t=this.editor.el.offset(),o=this.target.offset(),i=this.target.outerHeight(),"bottom"===e?a=o.top-t.top+i:"top"===e&&(a=o.top-t.top-this.el.height()),n=Math.min(o.left-t.left,this.editor.wrapper.width()-this.el.outerWidth()-10),this.el.css({top:a+this.offset.top,left:n+this.offset.left})):void 0},n.prototype.destroy=function(){return this.target=null,this.active=!1,this.editor.off(".linkpopover"),this.el.remove()},n.prototype._t=function(){var e,t,i;return e=1<=arguments.length?$.call(arguments,0):[],i=n.__super__._t.apply(this,e),i||(i=(t=this.button)._t.apply(t,e)),i},n}(t),R.Popover=w,x=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return P(n,t),n.prototype.name="title",n.prototype.htmlTag="h1, h2, h3, h4",n.prototype.disableTag="pre, table",n.prototype._init=function(){return this.menu=[{name:"normal",text:this._t("normalText"),param:"p"},"|",{name:"h1",text:this._t("title")+" 1",param:"h1"},{name:"h2",text:this._t("title")+" 2",param:"h2"},{name:"h3",text:this._t("title")+" 3",param:"h3"},{name:"h4",text:this._t("title")+" 4",param:"h4"},{name:"h5",text:this._t("title")+" 5",param:"h5"}],n.__super__._init.call(this)},n.prototype.setActive=function(e,t){return n.__super__.setActive.call(this,e),this.el.removeClass("active-p active-h1 active-h2 active-h3"),e?this.el.addClass("active active-"+t):void 0},n.prototype.status=function(e){var t,n;return null!=e&&this.setDisabled(e.is(this.disableTag)),this.disabled?!0:(null!=e&&(t=null!=(n=e[0].tagName)?n.toLowerCase():void 0,this.setActive(e.is(this.htmlTag),t)),this.active)},n.prototype.command=function(t){var n,i,o,a,s,r,l,c,u,d,h;for(c=this.editor.selection.getRange(),h=c.startContainer,a=c.endContainer,o=this.editor.util.closestBlockEl(h),i=this.editor.util.closestBlockEl(a),this.editor.selection.save(),c.setStartBefore(o[0]),c.setEndAfter(i[0]),n=e(c.extractContents()),d=[],n.children().each(function(e){return function(n,i){var o,a,s,r,l;for(a=e._convertEl(i,t),l=[],s=0,r=a.length;r>s;s++)o=a[s],l.push(d.push(o));return l}}(this)),u=d.reverse(),s=0,r=u.length;r>s;s++)l=u[s],c.insertNode(l[0]);return this.editor.selection.restore(),this.editor.trigger("valuechanged")},n.prototype._convertEl=function(t,n){var i,o,a;return o=e(t),a=[],o.is(n)?a.push(o):(i=e("<"+n+"/>").append(o.contents()),a.push(i)),a},n}(r),R.Toolbar.addButton(x),s=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return P(n,t),n.prototype.name="bold",n.prototype.icon="bold",n.prototype.htmlTag="b, strong",n.prototype.disableTag="pre",n.prototype.shortcut="cmd+b",n.prototype._init=function(){return this.editor.util.os.mac?this.title=this.title+" ( Cmd + b )":(this.title=this.title+" ( Ctrl + b )",this.shortcut="ctrl+b"),n.__super__._init.call(this)},n.prototype.status=function(e){var t;return null!=e&&this.setDisabled(e.is(this.disableTag)),this.disabled?!0:(t=document.queryCommandState("bold")===!0,this.setActive(t),t)},n.prototype.command=function(){return document.execCommand("bold"),this.editor.util.support.oninput||this.editor.trigger("valuechanged"),e(document).trigger("selectionchange")},n}(r),R.Toolbar.addButton(s),E=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return P(n,t),n.prototype.name="italic",n.prototype.icon="italic",n.prototype.htmlTag="i",n.prototype.disableTag="pre",n.prototype.shortcut="cmd+i",n.prototype._init=function(){return this.editor.util.os.mac?this.title=this.title+" ( Cmd + i )":(this.title=this.title+" ( Ctrl + i )",this.shortcut="ctrl+i"),n.__super__._init.call(this)},n.prototype.status=function(e){var t;return null!=e&&this.setDisabled(e.is(this.disableTag)),this.disabled?this.disabled:(t=document.queryCommandState("italic")===!0,this.setActive(t),t)},n.prototype.command=function(){return document.execCommand("italic"),this.editor.util.support.oninput||this.editor.trigger("valuechanged"),e(document).trigger("selectionchange")},n}(r),R.Toolbar.addButton(E),K=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return P(n,t),n.prototype.name="underline",n.prototype.icon="underline",n.prototype.htmlTag="u",n.prototype.disableTag="pre",n.prototype.shortcut="cmd+u",n.prototype.render=function(){return this.editor.util.os.mac?this.title=this.title+" ( Cmd + u )":(this.title=this.title+" ( Ctrl + u )",this.shortcut="ctrl+u"),n.__super__.render.call(this)},n.prototype.status=function(e){var t;return null!=e&&this.setDisabled(e.is(this.disableTag)),this.disabled?this.disabled:(t=document.queryCommandState("underline")===!0,this.setActive(t),t)},n.prototype.command=function(){return document.execCommand("underline"),this.editor.util.support.oninput||this.editor.trigger("valuechanged"),e(document).trigger("selectionchange")},n}(r),R.Toolbar.addButton(K),u=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return P(n,t),n.prototype.name="color",n.prototype.icon="tint",n.prototype.disableTag="pre",n.prototype.menu=!0,n.prototype.render=function(){var e;return e=1<=arguments.length?$.call(arguments,0):[],n.__super__.render.apply(this,e)},n.prototype.renderMenu=function(){return e('<ul class="color-list">\n  <li><a href="javascript:;" class="font-color font-color-1" data-color=""></a></li>\n  <li><a href="javascript:;" class="font-color font-color-2" data-color=""></a></li>\n  <li><a href="javascript:;" class="font-color font-color-3" data-color=""></a></li>\n  <li><a href="javascript:;" class="font-color font-color-4" data-color=""></a></li>\n  <li><a href="javascript:;" class="font-color font-color-5" data-color=""></a></li>\n  <li><a href="javascript:;" class="font-color font-color-6" data-color=""></a></li>\n  <li><a href="javascript:;" class="font-color font-color-7" data-color=""></a></li>\n  <li><a href="javascript:;" class="font-color font-color-default" data-color=""></a></li>\n</ul>').appendTo(this.menuWrapper),this.menuWrapper.on("mousedown",".color-list",function(){return!1}),this.menuWrapper.on("click",".font-color",function(t){return function(n){var i,o,a,s;if(t.wrapper.removeClass("menu-on"),i=e(n.currentTarget),i.hasClass("font-color-default")){if(o=t.editor.body.find("p, li"),!(o.length>0))return;s=window.getComputedStyle(o[0],null).getPropertyValue("color"),a=t._convertRgbToHex(s)}else s=window.getComputedStyle(i[0],null).getPropertyValue("background-color"),a=t._convertRgbToHex(s);return a?(document.execCommand("foreColor",!1,a),t.editor.util.support.oninput?void 0:t.editor.trigger("valuechanged")):void 0}}(this))},n.prototype._convertRgbToHex=function(e){var t,n,i;return n=/rgb\((\d+),\s?(\d+),\s?(\d+)\)/g,(t=n.exec(e))?(i=function(e,t,n){var i;return i=function(e){var t;return t=e.toString(16),1===t.length?"0"+t:t},"#"+i(e)+i(t)+i(n)})(1*t[1],1*t[2],1*t[3]):""},n}(r),R.Toolbar.addButton(u),C=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return P(n,t),n.prototype.type="",n.prototype.disableTag="pre, table",n.prototype.status=function(e){var t;return null!=e&&this.setDisabled(e.is(this.disableTag)),this.disabled?!0:null==e?this.active:(t="ul"===this.type?"ol":"ul",e.is(t)?(this.setActive(!1),!0):(this.setActive(e.is(this.htmlTag)),this.active))},n.prototype.command=function(){var t,n,i,o,a,s,r,l,c,u,d,h,f,p,m,g,v;for(f=this.editor.selection.getRange(),v=f.startContainer,l=f.endContainer,s=this.editor.util.closestBlockEl(v),n=this.editor.util.closestBlockEl(l),this.editor.selection.save(),f.setStartBefore(s[0]),f.setEndAfter(n[0]),s.is("li")&&n.is("li")&&(o=this.editor.util.furthestNode(s,"ul, ol"),i=this.editor.util.furthestNode(n,"ul, ol"),o.is(i)?(c=function(e){var t;for(t=1;!e.parent().is(o);)t+=1,e=e.parent();return t},g=c(s),r=c(n),a=g>r?n.parent():s.parent(),f.setStartBefore(a[0]),f.setEndAfter(a[0])):(f.setStartBefore(o[0]),f.setEndAfter(i[0]))),t=e(f.extractContents()),m=[],t.children().each(function(e){return function(t,n){var i,o,a,s,r;for(o=e._convertEl(n),r=[],a=0,s=o.length;s>a;a++)i=o[a],r.push(m.length&&m[m.length-1].is(e.type)&&i.is(e.type)?m[m.length-1].append(i.children()):m.push(i));return r}}(this)),p=m.reverse(),u=0,d=p.length;d>u;u++)h=p[u],f.insertNode(h[0]);return this.editor.selection.restore(),this.editor.trigger("valuechanged")},n.prototype._convertEl=function(t){var n,i,o,a,s,r,l,c,u;if(n=e(t),u=[],i="ul"===this.type?"ol":"ul",n.is(this.type))n.children("li").each(function(t){return function(n,i){var o,a,s;return a=e(i),o=a.children("ul, ol").remove(),s=e("<p/>").append(e(i).html()||t.editor.util.phBr),u.push(s),o.length>0?u.push(o):void 0}}(this));else if(n.is(i))o=e("<"+this.type+"/>").append(n.html()),u.push(o);else if(n.is("blockquote")){for(c=n.children().get(),r=0,l=c.length;l>r;r++)a=c[r],s=this._convertEl(a);e.merge(u,s)}else n.is("table")||(o=e("<"+this.type+"><li></li></"+this.type+">"),o.find("li").append(n.html()||this.editor.util.phBr),u.push(o));return u},n}(r),I=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return P(t,e),t.prototype.type="ol",t.prototype.name="ol",t.prototype.icon="list-ol",t.prototype.htmlTag="ol",t.prototype.shortcut="cmd+/",t.prototype._init=function(){return this.editor.util.os.mac?this.title=this.title+" ( Cmd + / )":(this.title=this.title+" ( ctrl + / )",this.shortcut="ctrl+/"),t.__super__._init.call(this)},t}(C),A=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return P(t,e),t.prototype.type="ul",t.prototype.name="ul",t.prototype.icon="list-ul",t.prototype.htmlTag="ul",t.prototype.shortcut="cmd+.",t.prototype._init=function(){return this.editor.util.os.mac?this.title=this.title+" ( Cmd + . )":(this.title=this.title+" ( Ctrl + . )",this.shortcut="ctrl+."),t.__super__._init.call(this)},t}(C),R.Toolbar.addButton(I),R.Toolbar.addButton(A),a=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return P(n,t),n.prototype.name="blockquote",n.prototype.icon="quote-left",n.prototype.htmlTag="blockquote",n.prototype.disableTag="pre, table",n.prototype.command=function(){var t,n,i,o,a,s,r,l,c,u,d;for(l=this.editor.selection.getRange(),d=l.startContainer,o=l.endContainer,i=this.editor.util.furthestBlockEl(d),n=this.editor.util.furthestBlockEl(o),this.editor.selection.save(),l.setStartBefore(i[0]),l.setEndAfter(n[0]),t=e(l.extractContents()),u=[],t.children().each(function(e){return function(t,n){var i,o,a,s,r;for(o=e._convertEl(n),r=[],a=0,s=o.length;s>a;a++)i=o[a],r.push(u.length&&u[u.length-1].is(e.htmlTag)&&i.is(e.htmlTag)?u[u.length-1].append(i.children()):u.push(i));return r}}(this)),c=u.reverse(),a=0,s=c.length;s>a;a++)r=c[a],l.insertNode(r[0]);return this.editor.selection.restore(),this.editor.trigger("valuechanged")},n.prototype._convertEl=function(t){var n,i,o;return n=e(t),o=[],n.is(this.htmlTag)?n.children().each(function(){return function(t,n){return o.push(e(n))}}(this)):(i=e("<"+this.htmlTag+"/>").append(n),o.push(i)),o},n}(r),R.Toolbar.addButton(a),l=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return P(n,t),n.prototype.name="code",n.prototype.icon="code",n.prototype.htmlTag="pre",n.prototype.disableTag="li, table",n.prototype._init=function(){return n.__super__._init.call(this),this.editor.on("decorate",function(t){return function(n,i){return i.find("pre").each(function(n,i){return t.decorate(e(i))})}}(this)),this.editor.on("undecorate",function(t){return function(n,i){return i.find("pre").each(function(n,i){return t.undecorate(e(i))})}}(this))},n.prototype.render=function(){var e;return e=1<=arguments.length?$.call(arguments,0):[],n.__super__.render.apply(this,e),this.popover=new c({button:this})},n.prototype.status=function(e){var t;return t=n.__super__.status.call(this,e),this.active?this.popover.show(e):this.editor.util.isBlockNode(e)&&this.popover.hide(),t},n.prototype.decorate=function(e){var t;return t=e.attr("data-lang"),e.removeClass(),t&&-1!==t?e.addClass("lang-"+t):void 0},n.prototype.undecorate=function(e){var t;return t=e.attr("data-lang"),e.removeClass(),t&&-1!==t?e.addClass("lang-"+t):void 0},n.prototype.command=function(){var t,n,i,o,a,s,r,l,c,u,d;for(l=this.editor.selection.getRange(),d=l.startContainer,o=l.endContainer,i=this.editor.util.closestBlockEl(d),n=this.editor.util.closestBlockEl(o),l.setStartBefore(i[0]),l.setEndAfter(n[0]),t=e(l.extractContents()),u=[],t.children().each(function(e){return function(t,n){var i,o,a,s,r;for(o=e._convertEl(n),r=[],a=0,s=o.length;s>a;a++)i=o[a],r.push(u.length&&u[u.length-1].is(e.htmlTag)&&i.is(e.htmlTag)?u[u.length-1].append(i.contents()):u.push(i));return r}}(this)),c=u.reverse(),a=0,s=c.length;s>a;a++)r=c[a],l.insertNode(r[0]);return this.editor.selection.setRangeAtEndOf(u[0]),this.editor.trigger("valuechanged")},n.prototype._convertEl=function(t){var n,i,o,a;return n=e(t),a=[],n.is(this.htmlTag)?(i=e("<p/>").append(n.html().replace("\n","<br/>")),a.push(i)):(o=!n.text()&&1===n.children().length&&n.children().is("br")?"\n":this.editor.formatter.clearHtml(n),i=e("<"+this.htmlTag+"/>").text(o),a.push(i)),a},n}(r),c=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return P(t,e),t.prototype._tpl='<div class="code-settings">\n  <div class="settings-field">\n    <select class="select-lang">\n      <option value="-1">\u9009\u62e9\u7a0b\u5e8f\u8bed\u8a00</option>\n      <option value="bash">Bash</option>\n      <option value="c++">C++</option>\n      <option value="cs">C#</option>\n      <option value="css">CSS</option>\n      <option value="erlang">Erlang</option>\n      <option value="less">Less</option>\n      <option value="scss">Sass</option>\n      <option value="diff">Diff</option>\n      <option value="coffeeScript">CoffeeScript</option>\n      <option value="html">Html,XML</option>\n      <option value="json">JSON</option>\n      <option value="java">Java</option>\n      <option value="js">JavaScript</option>\n      <option value="markdown">Markdown</option>\n      <option value="oc">Objective C</option>\n      <option value="php">PHP</option>\n      <option value="perl">Perl</option>\n      <option value="python">Python</option>\n      <option value="ruby">Ruby</option>\n      <option value="sql">SQL</option>\n    </select>\n  </div>\n</div>',t.prototype.render=function(){return this.el.addClass("code-popover").append(this._tpl),this.selectEl=this.el.find(".select-lang"),this.selectEl.on("change",function(e){return function(){var t;return e.lang=e.selectEl.val(),t=e.target.hasClass("selected"),e.target.removeClass().removeAttr("data-lang"),-1!==e.lang&&(e.target.addClass("lang-"+e.lang),e.target.attr("data-lang",e.lang)),t?e.target.addClass("selected"):void 0}}(this)),this.editor.on("valuechanged",function(e){return function(){return e.active?e.refresh():void 0}}(this))},t.prototype.show=function(){var e;return e=1<=arguments.length?$.call(arguments,0):[],t.__super__.show.apply(this,e),this.lang=this.target.attr("data-lang"),this.selectEl.val(null!=this.lang?this.lang:-1)},t}(w),R.Toolbar.addButton(l),T=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return P(n,t),n.prototype.name="link",n.prototype.icon="link",n.prototype.htmlTag="a",n.prototype.disableTag="pre",n.prototype.render=function(){var e;return e=1<=arguments.length?$.call(arguments,0):[],n.__super__.render.apply(this,e),this.popover=new b({button:this})},n.prototype.status=function(e){var t;return null!=e&&this.setDisabled(e.is(this.disableTag)),this.disabled?!0:null==e?this.active:(t=!0,!e.is(this.htmlTag)||e.is('[class^="simditor-"]')?(this.setActive(!1),t=!1):this.editor.selection.rangeAtEndOf(e)?(this.setActive(!0),t=!1):this.setActive(!0),t?this.popover.show(e):this.editor.util.isBlockNode(e)&&this.popover.hide(),this.active)},n.prototype.command=function(){var t,n,i,o,a,s,r,l,c,u;return l=this.editor.selection.getRange(),this.active?(i=e(l.commonAncestorContainer).closest("a"),u=document.createTextNode(i.text()),i.replaceWith(u),l.selectNode(u)):(c=l.startContainer,s=l.endContainer,a=this.editor.util.closestBlockEl(c),n=this.editor.util.closestBlockEl(s),t=e(l.extractContents()),r=this.editor.formatter.clearHtml(t.contents(),!1),i=e("<a/>",{href:"http://www.example.com",target:"_blank",text:r||this._t("linkText")}),a[0]===n[0]?l.insertNode(i[0]):(o=e("<p/>").append(i),l.insertNode(o[0])),l.selectNodeContents(i[0]),this.popover.one("popovershow",function(e){return function(){return r?(e.popover.urlEl.focus(),e.popover.urlEl[0].select()):(e.popover.textEl.focus(),e.popover.textEl[0].select())}}(this))),this.editor.selection.selectRange(l),this.editor.trigger("valuechanged")
},n}(r),b=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return P(n,t),n.prototype.render=function(){var t;return t='<div class="link-settings">\n  <div class="settings-field">\n    <label>'+this._t("text")+'</label>\n    <input class="link-text" type="text"/>\n    <a class="btn-unlink" href="javascript:;" title="'+this._t("removeLink")+'" tabindex="-1"><span class="simditor-icon simditor-icon-unlink"></span></a>\n  </div>\n  <div class="settings-field">\n    <label>'+this._t("linkUrl")+'</label>\n    <input class="link-url" type="text"/>\n  </div>\n</div>',this.el.addClass("link-popover").append(t),this.textEl=this.el.find(".link-text"),this.urlEl=this.el.find(".link-url"),this.unlinkEl=this.el.find(".btn-unlink"),this.textEl.on("keyup",function(e){return function(t){return 13!==t.which?e.target.text(e.textEl.val()):void 0}}(this)),this.urlEl.on("keyup",function(e){return function(t){var n;if(13!==t.which)return n=e.urlEl.val(),!/https?:\/\/|^\//gi.test(n)&&n&&(n="http://"+n),e.target.attr("href",n)}}(this)),e([this.urlEl[0],this.textEl[0]]).on("keydown",function(t){return function(n){return 13===n.which||27===n.which||!n.shiftKey&&9===n.which&&e(n.target).hasClass("link-url")?(n.preventDefault(),setTimeout(function(){var e;return e=document.createRange(),t.editor.selection.setRangeAfter(t.target,e),t.hide(),t.editor.trigger("valuechanged")},0)):void 0}}(this)),this.unlinkEl.on("click",function(e){return function(){var t,n;return n=document.createTextNode(e.target.text()),e.target.replaceWith(n),e.hide(),t=document.createRange(),e.editor.selection.setRangeAfter(n,t),e.editor.trigger("valuechanged")}}(this))},n.prototype.show=function(){var e;return e=1<=arguments.length?$.call(arguments,0):[],n.__super__.show.apply(this,e),this.textEl.val(this.target.text()),this.urlEl.val(this.target.attr("href"))},n}(w),R.Toolbar.addButton(T),f=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return P(n,t),n.prototype.name="image",n.prototype.icon="picture-o",n.prototype.htmlTag="img",n.prototype.disableTag="pre, table",n.prototype.defaultImage="",n.prototype.needFocus=!1,n.prototype._init=function(){var t,i,o,a;if(this.editor.opts.imageButton)if(Array.isArray(this.editor.opts.imageButton))for(this.menu=[],a=this.editor.opts.imageButton,i=0,o=a.length;o>i;i++)t=a[i],this.menu.push({name:t+"-image",text:this._t(t+"Image")});else this.menu=!1;else this.menu=null!=this.editor.uploader?[{name:"upload-image",text:this._t("uploadImage")},{name:"external-image",text:this._t("externalImage")}]:!1;return this.defaultImage=this.editor.opts.defaultImage,this.editor.body.on("click","img:not([data-non-image])",function(t){return function(n){var i,o;return i=e(n.currentTarget),o=document.createRange(),o.selectNode(i[0]),t.editor.selection.selectRange(o),t.editor.util.support.onselectionchange||t.editor.trigger("selectionchanged"),!1}}(this)),this.editor.body.on("mouseup","img:not([data-non-image])",function(){return function(){return!1}}(this)),this.editor.on("selectionchanged.image",function(t){return function(){var n,i,o;return o=t.editor.selection.getRange(),null!=o?(n=e(o.cloneContents()).contents(),1===n.length&&n.is("img:not([data-non-image])")?(i=e(o.startContainer).contents().eq(o.startOffset),t.popover.show(i)):t.popover.hide()):void 0}}(this)),this.editor.on("valuechanged.image",function(t){return function(){var n;return n=t.editor.wrapper.find(".simditor-image-loading"),n.length>0?n.each(function(n,i){var o,a,s;return a=e(i),o=a.data("img"),!(o&&o.parent().length>0)&&(a.remove(),o&&(s=o.data("file"),s&&(t.editor.uploader.cancel(s),t.editor.body.find("img.uploading").length<1)))?t.editor.uploader.trigger("uploadready",[s]):void 0}):void 0}}(this)),n.__super__._init.call(this)},n.prototype.render=function(){var e;return e=1<=arguments.length?$.call(arguments,0):[],n.__super__.render.apply(this,e),this.popover=new p({button:this}),"upload"===this.editor.opts.imageButton?this._initUploader(this.el):void 0},n.prototype.renderMenu=function(){return n.__super__.renderMenu.call(this),this._initUploader()},n.prototype._initUploader=function(t){var n,i;return null==t&&(t=this.menuEl.find(".menu-item-upload-image")),null==this.editor.uploader?void this.el.find(".btn-upload").remove():(n=null,i=function(i){return function(){return n&&n.remove(),n=e('<input type="file" title="'+i._t("uploadImage")+'" accept="image/*">').appendTo(t)}}(this),i(),t.on("click mousedown","input[type=file]",function(){return function(e){return e.stopPropagation()}}(this)),t.on("change","input[type=file]",function(e){return function(){return e.editor.inputManager.focused?(e.editor.uploader.upload(n,{inline:!0}),i()):(e.editor.one("focus",function(){return e.editor.uploader.upload(n,{inline:!0}),i()}),e.editor.focus()),e.wrapper.removeClass("menu-on")}}(this)),this.editor.uploader.on("beforeupload",function(t){return function(n,i){var o;if(i.inline)return i.img?o=e(i.img):(o=t.createImage(i.name),i.img=o),o.addClass("uploading"),o.data("file",i),t.editor.uploader.readImageFile(i.obj,function(e){var n;if(o.hasClass("uploading"))return n=e?e.src:t.defaultImage,t.loadImage(o,n,function(){return t.popover.active?(t.popover.refresh(),t.popover.srcEl.val(t._t("uploading")).prop("disabled",!0)):void 0})})}}(this)),this.editor.uploader.on("uploadprogress",e.proxy(this.editor.util.throttle(function(e,t,n,i){var o,a,s;if(t.inline&&(a=t.img.data("mask")))return o=a.data("img"),o.hasClass("uploading")&&o.parent().length>0?(s=n/i,s=(100*s).toFixed(0),s>99&&(s=99),a.find(".progress").height(100-s+"%")):void a.remove()},500),this)),this.editor.uploader.on("uploadsuccess",function(t){return function(n,i,o){var a,s,r;if(i.inline&&(a=i.img,a.hasClass("uploading")&&a.parent().length>0)){if(a.removeData("file"),a.removeClass("uploading").removeClass("loading"),s=a.data("mask"),s&&s.remove(),a.removeData("mask"),"object"!=typeof o)try{o=e.parseJSON(o)}catch(l){n=l,o={success:!1}}return o.success===!1?(r=o.msg||t._t("uploadFailed"),alert(r),a.attr("src",t.defaultImage)):a.attr("src",o.file_path),t.popover.active&&(t.popover.srcEl.prop("disabled",!1),t.popover.srcEl.val(o.file_path)),t.editor.trigger("valuechanged"),t.editor.body.find("img.uploading").length<1?t.editor.uploader.trigger("uploadready",[i,o]):void 0}}}(this)),this.editor.uploader.on("uploaderror",function(t){return function(n,i,o){var a,s,r,l;if(i.inline&&"abort"!==o.statusText){if(o.responseText){try{l=e.parseJSON(o.responseText),r=l.msg}catch(c){n=c,r=t._t("uploadError")}alert(r)}if(a=i.img,a.hasClass("uploading")&&a.parent().length>0)return a.removeData("file"),a.removeClass("uploading").removeClass("loading"),s=a.data("mask"),s&&s.remove(),a.removeData("mask"),a.attr("src",t.defaultImage),t.popover.active&&(t.popover.srcEl.prop("disabled",!1),t.popover.srcEl.val(t.defaultImage)),t.editor.trigger("valuechanged"),t.editor.body.find("img.uploading").length<1?t.editor.uploader.trigger("uploadready",[i,l]):void 0}}}(this)))},n.prototype.status=function(e){return null!=e&&this.setDisabled(e.is(this.disableTag)),this.disabled?!0:void 0},n.prototype.loadImage=function(t,n,i){var o,a,s;return s=function(e){return function(){var n,i;return n=t.offset(),i=e.editor.wrapper.offset(),o.css({top:n.top-i.top,left:n.left-i.left,width:t.width(),height:t.height()}).show()}}(this),t.addClass("loading"),o=t.data("mask"),o||(o=e('<div class="simditor-image-loading"><div class="progress"></div></div>').hide().appendTo(this.editor.wrapper),s(),t.data("mask",o),o.data("img",t)),a=new Image,a.onload=function(e){return function(){var r,l;if(t.hasClass("loading")||t.hasClass("uploading"))return l=a.width,r=a.height,t.attr({src:n,"data-image-size":l+","+r}).removeClass("loading"),t.hasClass("uploading")?(e.editor.util.reflow(e.editor.body),s()):(o.remove(),t.removeData("mask")),i(a)}}(this),a.onerror=function(){return function(){return i(!1),o.remove(),t.removeData("mask").removeClass("loading")}}(this),a.src=n},n.prototype.createImage=function(t){var n,i,o,a;return null==t&&(t="Image"),this.editor.inputManager.focused||this.editor.focus(),a=this.editor.selection.getRange(),a.deleteContents(),n=this.editor.util.closestBlockEl(),n.is("p")&&!this.editor.util.isEmptyNode(n)&&(n=e("<p/>").append(this.editor.util.phBr).insertAfter(n),this.editor.selection.setRangeAtStartOf(n,a)),i=e("<img/>").attr("alt",t),a.insertNode(i[0]),o=n.next("p"),o.length>0||(o=e("<p/>").append(this.editor.util.phBr).insertAfter(n)),this.editor.selection.setRangeAtStartOf(o),i},n.prototype.command=function(e){var t;return t=this.createImage(),this.loadImage(t,e||this.defaultImage,function(e){return function(){return e.editor.trigger("valuechanged"),e.editor.util.reflow(t),t.click(),e.popover.one("popovershow",function(){return e.popover.srcEl.focus(),e.popover.srcEl[0].select()})}}(this))},n}(r),p=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return P(n,t),n.prototype.offset={top:6,left:-4},n.prototype.render=function(){var t;return t='<div class="link-settings">\n  <div class="settings-field">\n    <label>'+this._t("imageUrl")+'</label>\n    <input class="image-src" type="text" tabindex="1" />\n    <a class="btn-upload" href="javascript:;" title="'+this._t("uploadImage")+'" tabindex="-1">\n      <span class="simditor-icon simditor-icon-upload"></span>\n    </a>\n  </div>\n  <div class=\'settings-field\'>\n    <label>'+this._t("imageAlt")+'</label>\n    <input class="image-alt" id="image-alt" type="text" tabindex="1" />\n  </div>\n  <div class="settings-field">\n    <label>'+this._t("imageSize")+'</label>\n    <input class="image-size" id="image-width" type="text" tabindex="2" />\n    <span class="times">\xd7</span>\n    <input class="image-size" id="image-height" type="text" tabindex="3" />\n    <a class="btn-restore" href="javascript:;" title="'+this._t("restoreImageSize")+'" tabindex="-1">\n      <span class="simditor-icon simditor-icon-undo"></span>\n    </a>\n  </div>\n</div>',this.el.addClass("image-popover").append(t),this.srcEl=this.el.find(".image-src"),this.widthEl=this.el.find("#image-width"),this.heightEl=this.el.find("#image-height"),this.altEl=this.el.find("#image-alt"),this.srcEl.on("keydown",function(e){return function(t){return 13!==t.which||e.target.hasClass("uploading")?void 0:(t.preventDefault(),e.button.editor.body.focus(),e.button.editor.selection.setRangeAfter(e.target),e.hide())}}(this)),this.srcEl.on("blur",function(e){return function(){return e._loadImage(e.srcEl.val())}}(this)),this.el.find(".image-size").on("blur",function(t){return function(n){return t._resizeImg(e(n.currentTarget)),t.el.data("popover").refresh()}}(this)),this.el.find(".image-size").on("keyup",function(t){return function(n){var i;return i=e(n.currentTarget),13!==n.which&&27!==n.which&&9!==n.which?t._resizeImg(i,!0):void 0}}(this)),this.el.find(".image-size").on("keydown",function(t){return function(n){var i;return i=e(n.currentTarget),13===n.which||27===n.which?(n.preventDefault(),13===n.which?t._resizeImg(i):t._restoreImg(),t.button.editor.body.focus(),t.button.editor.selection.setRangeAfter(t.target),t.hide()):9===n.which?t.el.data("popover").refresh():void 0}}(this)),this.altEl.on("keydown",function(e){return function(t){return 13===t.which?(t.preventDefault(),e.button.editor.body.focus(),e.button.editor.selection.setRangeAfter(e.target),e.hide()):void 0}}(this)),this.altEl.on("keyup",function(e){return function(t){return 13!==t.which&&27!==t.which&&9!==t.which?(e.alt=e.altEl.val(),e.target.attr("alt",e.alt)):void 0}}(this)),this.el.find(".btn-restore").on("click",function(e){return function(){return e._restoreImg(),e.el.data("popover").refresh()}}(this)),this.editor.on("valuechanged",function(e){return function(){return e.active?e.refresh():void 0}}(this)),this._initUploader()},n.prototype._initUploader=function(){var t,n;return t=this.el.find(".btn-upload"),null==this.editor.uploader?void t.remove():(n=function(n){return function(){return n.input&&n.input.remove(),n.input=e('<input type="file" title="'+n._t("uploadImage")+'" accept="image/*">').appendTo(t)}}(this),n(),this.el.on("click mousedown","input[type=file]",function(){return function(e){return e.stopPropagation()}}(this)),this.el.on("change","input[type=file]",function(e){return function(){return e.editor.uploader.upload(e.input,{inline:!0,img:e.target}),n()}}(this)))},n.prototype._resizeImg=function(t,n){var i,o,a;return null==n&&(n=!1),o=1*t.val(),e.isNumeric(o)||0>o?(t.is(this.widthEl)?(i=this.height*o/this.width,this.heightEl.val(i)):(a=this.width*o/this.height,this.widthEl.val(a)),n||this.target.attr({width:a||o,height:i||o}),this.editor.trigger("valuechanged")):void 0},n.prototype._restoreImg=function(){var e,t;return t=(null!=(e=this.target.data("image-size"))?e.split(","):void 0)||[this.width,this.height],this.target.attr({width:1*t[0],height:1*t[1]}),this.widthEl.val(t[0]),this.heightEl.val(t[1]),this.editor.trigger("valuechanged")},n.prototype._loadImage=function(e,t){return/^data:image/.test(e)&&!this.editor.uploader?void(t&&t(!1)):this.button.loadImage(this.target,e,function(n){return function(i){var o;if(i)return n.active&&(n.width=i.width,n.height=i.height,n.widthEl.val(n.width),n.heightEl.val(n.height),n.target.removeAttr("width").removeAttr("height")),/^data:image/.test(e)?(o=n.editor.util.dataURLtoBlob(e),o.name="Base64 Image.png",n.editor.uploader.upload(o,{inline:!0,img:n.target})):n.editor.trigger("valuechanged"),t?t(i):void 0}}(this))},n.prototype.show=function(){var e,t;return t=1<=arguments.length?$.call(arguments,0):[],n.__super__.show.apply(this,t),e=this.target,this.width=e.width(),this.height=e.height(),this.alt=e.attr("alt"),e.hasClass("uploading")?this.srcEl.val(this._t("uploading")).prop("disabled",!0):(this.srcEl.val(e.attr("src")).prop("disabled",!1),this.widthEl.val(this.width),this.heightEl.val(this.height),this.altEl.val(this.alt))},n}(w),R.Toolbar.addButton(f),m=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return P(t,e),t.prototype.name="indent",t.prototype.icon="indent",t.prototype._init=function(){return this.title=this._t(this.name)+" (Tab)",t.__super__._init.call(this)},t.prototype.status=function(){return!0},t.prototype.command=function(){return this.editor.indentation.indent()},t}(r),R.Toolbar.addButton(m),D=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return P(t,e),t.prototype.name="outdent",t.prototype.icon="outdent",t.prototype._init=function(){return this.title=this._t(this.name)+" (Shift + Tab)",t.__super__._init.call(this)},t.prototype.status=function(){return!0},t.prototype.command=function(){return this.editor.indentation.indent(!0)},t}(r),R.Toolbar.addButton(D),h=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return P(n,t),n.prototype.name="hr",n.prototype.icon="minus",n.prototype.htmlTag="hr",n.prototype.status=function(){return!0},n.prototype.command=function(){var t,n,i,o;return o=this.editor.util.furthestBlockEl(),i=o.next(),i.length>0?this.editor.selection.save():n=e("<p/>").append(this.editor.util.phBr),t=e("<hr/>").insertAfter(o),n?(n.insertAfter(t),this.editor.selection.setRangeAtStartOf(n)):this.editor.selection.restore(),this.editor.trigger("valuechanged")},n}(r),R.Toolbar.addButton(h),_=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return P(n,t),n.prototype.name="table",n.prototype.icon="table",n.prototype.htmlTag="table",n.prototype.disableTag="pre, li, blockquote",n.prototype.menu=!0,n.prototype._init=function(){return n.__super__._init.call(this),e.merge(this.editor.formatter._allowedTags,["tbody","tr","td","colgroup","col"]),e.extend(this.editor.formatter._allowedAttributes,{td:["rowspan","colspan"],col:["width"]}),this._initShortcuts(),this.editor.on("decorate",function(t){return function(n,i){return i.find("table").each(function(n,i){return t.decorate(e(i))})}}(this)),this.editor.on("undecorate",function(t){return function(n,i){return i.find("table").each(function(n,i){return t.undecorate(e(i))})}}(this)),this.editor.on("selectionchanged.table",function(t){return function(){var n,i;return t.editor.body.find(".simditor-table td").removeClass("active"),i=t.editor.selection.getRange(),null!=i?(n=e(i.commonAncestorContainer),i.collapsed&&n.is(".simditor-table")&&(n=n.find(t.editor.selection.rangeAtStartOf(n)?"td:first":"td:last"),t.editor.selection.setRangeAtEndOf(n)),n.closest("td",t.editor.body).addClass("active")):void 0}}(this)),this.editor.on("blur.table",function(e){return function(){return e.editor.body.find(".simditor-table td").removeClass("active")}}(this)),this.editor.inputManager.addKeystrokeHandler("38","td",function(e){return function(t,n){var i,o,a;return o=n.parent("tr"),i=o.prev("tr"),i.length>0?(a=o.find("td").index(n),e.editor.selection.setRangeAtEndOf(i.find("td").eq(a)),!0):!0}}(this)),this.editor.inputManager.addKeystrokeHandler("40","td",function(e){return function(t,n){var i,o,a;return o=n.parent("tr"),i=o.next("tr"),i.length>0?(a=o.find("td").index(n),e.editor.selection.setRangeAtEndOf(i.find("td").eq(a)),!0):!0}}(this))},n.prototype.initResize=function(t){var n,i,o;return o=t.parent(".simditor-table"),n=t.find("colgroup"),n.length<1&&(n=e("<colgroup/>").prependTo(t),t.find("tr:first td").each(function(){return function(){var t;return t=e("<col/>").appendTo(n)}}(this)),this.refreshTableWidth(t)),i=e('<div class="simditor-resize-handle" contenteditable="false"></div>').appendTo(o),o.on("mousemove","td",function(){return function(t){var a,s,r,l,c,u;if(!o.hasClass("resizing"))return s=e(t.currentTarget),u=t.pageX-e(t.currentTarget).offset().left,5>u&&s.prev().length>0&&(s=s.prev()),s.next("td").length<1?void i.hide():(null!=(l=i.data("td"))?l.is(s):void 0)?void i.show():(r=s.parent().find("td").index(s),a=n.find("col").eq(r),(null!=(c=i.data("col"))?c.is(a):void 0)?void i.show():i.css("left",s.position().left+s.outerWidth()-5).data("td",s).data("col",a).show())}}(this)),o.on("mouseleave",function(){return function(){return i.hide()}}(this)),o.on("mousedown",".simditor-resize-handle",function(){return function(t){var n,i,a,s,r,l,c,u,d,h,f;return n=e(t.currentTarget),a=n.data("td"),i=n.data("col"),r=a.next("td"),s=i.next("col"),h=t.pageX,u=1*a.outerWidth(),d=1*r.outerWidth(),c=parseFloat(n.css("left")),f=a.closest("table").width(),l=50,e(document).on("mousemove.simditor-resize-table",function(e){var t,o,a;return t=e.pageX-h,o=u+t,a=d-t,l>o?(o=l,t=l-u,a=d-t):l>a&&(a=l,t=d-l,o=u+t),i.attr("width",o/f*100+"%"),s.attr("width",a/f*100+"%"),n.css("left",c+t)}),e(document).one("mouseup.simditor-resize-table",function(){return e(document).off(".simditor-resize-table"),o.removeClass("resizing")}),o.addClass("resizing"),!1}}(this))},n.prototype._initShortcuts=function(){return this.editor.inputManager.addShortcut("ctrl+alt+up",function(e){return function(){return e.editMenu.find(".menu-item[data-param=insertRowAbove]").click(),!1}}(this)),this.editor.inputManager.addShortcut("ctrl+alt+down",function(e){return function(){return e.editMenu.find(".menu-item[data-param=insertRowBelow]").click(),!1}}(this)),this.editor.inputManager.addShortcut("ctrl+alt+left",function(e){return function(){return e.editMenu.find(".menu-item[data-param=insertColLeft]").click(),!1}}(this)),this.editor.inputManager.addShortcut("ctrl+alt+right",function(e){return function(){return e.editMenu.find(".menu-item[data-param=insertColRight]").click(),!1}}(this))},n.prototype.decorate=function(e){return e.parent(".simditor-table").length>0&&this.undecorate(e),e.wrap('<div class="simditor-table"></div>'),this.initResize(e),e.parent()},n.prototype.undecorate=function(e){return e.parent(".simditor-table").length>0?e.parent().replaceWith(e):void 0},n.prototype.renderMenu=function(){return e('<div class="menu-create-table">\n</div>\n<div class="menu-edit-table">\n  <ul>\n    <li><a tabindex="-1" unselectable="on" class="menu-item" href="javascript:;" data-param="deleteRow"><span>'+this._t("deleteRow")+'</span></a></li>\n    <li><a tabindex="-1" unselectable="on" class="menu-item" href="javascript:;" data-param="insertRowAbove"><span>'+this._t("insertRowAbove")+' ( Ctrl + Alt + \u2191 )</span></a></li>\n    <li><a tabindex="-1" unselectable="on" class="menu-item" href="javascript:;" data-param="insertRowBelow"><span>'+this._t("insertRowBelow")+' ( Ctrl + Alt + \u2193 )</span></a></li>\n    <li><span class="separator"></span></li>\n    <li><a tabindex="-1" unselectable="on" class="menu-item" href="javascript:;" data-param="deleteCol"><span>'+this._t("deleteColumn")+'</span></a></li>\n    <li><a tabindex="-1" unselectable="on" class="menu-item" href="javascript:;" data-param="insertColLeft"><span>'+this._t("insertColumnLeft")+' ( Ctrl + Alt + \u2190 )</span></a></li>\n    <li><a tabindex="-1" unselectable="on" class="menu-item" href="javascript:;" data-param="insertColRight"><span>'+this._t("insertColumnRight")+' ( Ctrl + Alt + \u2192 )</span></a></li>\n    <li><span class="separator"></span></li>\n    <li><a tabindex="-1" unselectable="on" class="menu-item" href="javascript:;" data-param="deleteTable"><span>'+this._t("deleteTable")+"</span></a></li>\n  </ul>\n</div>").appendTo(this.menuWrapper),this.createMenu=this.menuWrapper.find(".menu-create-table"),this.editMenu=this.menuWrapper.find(".menu-edit-table"),this.createTable(6,6).appendTo(this.createMenu),this.createMenu.on("mouseenter","td",function(t){return function(n){var i,o,a;return t.createMenu.find("td").removeClass("selected"),i=e(n.currentTarget),o=i.parent(),a=o.find("td").index(i)+1,o.prevAll("tr").addBack().find("td:lt("+a+")").addClass("selected")}}(this)),this.createMenu.on("mouseleave",function(){return function(t){return e(t.currentTarget).find("td").removeClass("selected")}}(this)),this.createMenu.on("mousedown","td",function(t){return function(n){var i,o,a,s,r,l;return t.wrapper.removeClass("menu-on"),t.editor.inputManager.focused?(a=e(n.currentTarget),s=a.parent(),r=s.find("td").index(a)+1,l=s.prevAll("tr").length+1,o=t.createTable(l,r,!0),i=t.editor.util.closestBlockEl(),t.editor.util.isEmptyNode(i)?i.replaceWith(o):i.after(o),t.decorate(o),t.editor.selection.setRangeAtStartOf(o.find("td:first")),t.editor.trigger("valuechanged"),!1):void 0}}(this))},n.prototype.createTable=function(t,n,i){var o,a,s,r,l,c,u,d,h,f;for(o=e("<table/>"),a=e("<tbody/>").appendTo(o),d=c=0,h=t;h>=0?h>c:c>h;d=h>=0?++c:--c)for(r=e("<tr/>").appendTo(a),l=u=0,f=n;f>=0?f>u:u>f;l=f>=0?++u:--u)s=e("<td/>").appendTo(r),i&&s.append(this.editor.util.phBr);return o},n.prototype.refreshTableWidth=function(t){var n,i;return i=t.width(),n=t.find("col"),t.find("tr:first td").each(function(){return function(t,o){var a;return a=n.eq(t),a.attr("width",e(o).outerWidth()/i*100+"%")}}(this))},n.prototype.setActive=function(e){return n.__super__.setActive.call(this,e),e?(this.createMenu.hide(),this.editMenu.show()):(this.createMenu.show(),this.editMenu.hide())},n.prototype.deleteRow=function(e){var t,n,i;return n=e.parent("tr"),n.siblings("tr").length<1?this.deleteTable(e):(t=n.next("tr"),t.length>0||(t=n.prev("tr")),i=n.find("td").index(e),n.remove(),this.editor.selection.setRangeAtEndOf(t.find("td").eq(i)))},n.prototype.insertRow=function(t,n){var i,o,a,s,r,l,c,u;for(null==n&&(n="after"),a=t.parent("tr"),o=a.closest("table"),s=0,o.find("tr").each(function(){return function(t,n){return s=Math.max(s,e(n).find("td").length)}}(this)),i=e("<tr/>"),r=c=1,u=s;u>=1?u>=c:c>=u;r=u>=1?++c:--c)e("<td/>").append(this.editor.util.phBr).appendTo(i);return a[n](i),l=a.find("td").index(t),this.editor.selection.setRangeAtStartOf(i.find("td").eq(l))},n.prototype.deleteCol=function(t){var n,i,o,a;return o=t.parent("tr"),o.siblings("tr").length<1&&t.siblings("td").length<1?this.deleteTable(t):(a=o.find("td").index(t),n=t.next("td"),n.length>0||(n=o.prev("td")),i=o.closest("table"),i.find("col").eq(a).remove(),i.find("tr").each(function(){return function(t,n){return e(n).find("td").eq(a).remove()}}(this)),this.refreshTableWidth(i),this.editor.selection.setRangeAtEndOf(n))},n.prototype.insertCol=function(t,n){var i,o,a,s,r,l,c,u;return null==n&&(n="after"),r=t.parent("tr"),l=r.find("td").index(t),s=t.closest("table"),i=s.find("col").eq(l),s.find("tr").each(function(t){return function(i,o){var a;return a=e("<td/>").append(t.editor.util.phBr),e(o).find("td").eq(l)[n](a)}}(this)),o=e("<col/>"),i[n](o),c=s.width(),u=Math.max(parseFloat(i.attr("width"))/2,50/c*100),i.attr("width",u+"%"),o.attr("width",u+"%"),this.refreshTableWidth(s),a="after"===n?t.next("td"):t.prev("td"),this.editor.selection.setRangeAtStartOf(a)},n.prototype.deleteTable=function(e){var t,n;return n=e.closest(".simditor-table"),t=n.next("p"),n.remove(),t.length>0?this.editor.selection.setRangeAtStartOf(t):void 0},n.prototype.command=function(t){var n,i;if(i=this.editor.selection.getRange(),n=e(i.commonAncestorContainer).closest("td"),n.length>0){if("deleteRow"===t)this.deleteRow(n);else if("insertRowAbove"===t)this.insertRow(n,"before");else if("insertRowBelow"===t)this.insertRow(n);else if("deleteCol"===t)this.deleteCol(n);else if("insertColLeft"===t)this.insertCol(n,"before");else if("insertColRight"===t)this.insertCol(n);else{if("deleteTable"!==t)return;this.deleteTable(n)}return this.editor.trigger("valuechanged")}},n}(r),R.Toolbar.addButton(_),k=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return P(n,t),n.prototype.name="strikethrough",n.prototype.icon="strikethrough",n.prototype.htmlTag="strike",n.prototype.disableTag="pre",n.prototype.status=function(e){var t;return null!=e&&this.setDisabled(e.is(this.disableTag)),this.disabled?!0:(t=document.queryCommandState("strikethrough")===!0,this.setActive(t),t)},n.prototype.command=function(){return document.execCommand("strikethrough"),this.editor.util.support.oninput||this.editor.trigger("valuechanged"),e(document).trigger("selectionchange")},n}(r),R.Toolbar.addButton(k),o=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return P(n,t),n.prototype.name="alignment",n.prototype.icon="align-left",n.prototype.htmlTag="p, h1, h2, h3, h4",n.prototype._init=function(){return this.menu=[{name:"left",text:this._t("alignLeft"),icon:"align-left",param:"left"},{name:"center",text:this._t("alignCenter"),icon:"align-center",param:"center"},{name:"right",text:this._t("alignRight"),icon:"align-right",param:"right"}],n.__super__._init.call(this)},n.prototype.setActive=function(e,t){return null==t&&(t="left"),"left"===t?n.__super__.setActive.call(this,!1):n.__super__.setActive.call(this,e),this.el.removeClass("align-left align-center align-right"),e&&this.el.addClass("align-"+t),this.setIcon("align-"+t),this.menuEl.find(".menu-item").show().end().find(".menu-item-"+t).hide()},n.prototype.status=function(e){if(null==e)return!0;if(this.editor.util.isBlockNode(e))return this.setDisabled(!e.is(this.htmlTag)),this.disabled?(this.setActive(!1),!0):(this.setActive(!0,e.data("align")),this.active)},n.prototype.command=function(t){var n,i,o,a,s,r,l,c,u,d;if(["left","center","right"].indexOf(t)<0)throw"invalid "+t;for(c=this.editor.selection.getRange(),d=c.startContainer,s=c.endContainer,o=this.editor.util.closestBlockEl(d),i=this.editor.util.closestBlockEl(s),this.editor.selection.save(),n=o.is(i)?o:o.nextUntil(i).addBack().add(i),u=n.filter(this.htmlTag),r=0,l=u.length;l>r;r++)a=u[r],e(a).attr("data-align",t).data("align",t);return this.editor.selection.restore(),this.editor.trigger("valuechanged")},n}(r),R.Toolbar.addButton(o),R});