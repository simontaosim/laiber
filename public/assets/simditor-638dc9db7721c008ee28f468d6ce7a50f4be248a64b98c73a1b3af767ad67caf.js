/*!
* Simditor v2.1.11
* http://simditor.tower.im/
* 2015-20-05
*/
!function(t,e){"function"==typeof define&&define.amd?define("simditor",["jquery","simple-module","simple-hotkeys","simple-uploader"],function(i,n,o,s){return t.Simditor=e(i,n,o,s)}):"object"==typeof exports?module.exports=e(require("jquery"),require("simple-module"),require("simple-hotkeys"),require("simple-uploader")):t.Simditor=e(jQuery,SimpleModule,simple.hotkeys,simple.uploader)}(this,function(t,e,i,n){var o,s,a,r,l,c,u,d,h,p,f,m,v,g,y,w,b,x,C,T,k,S,E,_,A,N,D,M,I,P,F,$,O=function(t,e){function i(){this.constructor=t}for(var n in e)L.call(e,n)&&(t[n]=e[n]);return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t},L={}.hasOwnProperty,j=[].indexOf||function(t){for(var e=0,i=this.length;i>e;e++)if(e in this&&this[e]===t)return e;return-1},R=[].slice;return E=function(e){function i(){return i.__super__.constructor.apply(this,arguments)}return O(i,e),i.pluginName="Selection",i.prototype._init=function(){return this.editor=this._module,this.sel=document.getSelection()},i.prototype.clear=function(){var t;try{return this.sel.removeAllRanges()}catch(e){t=e}},i.prototype.getRange=function(){return this.editor.inputManager.focused&&this.sel.rangeCount?this.sel.getRangeAt(0):null},i.prototype.selectRange=function(t){return this.clear(),this.sel.addRange(t),this.editor.inputManager.focused||!this.editor.util.browser.firefox&&!this.editor.util.browser.msie||this.editor.body.focus(),t},i.prototype.rangeAtEndOf=function(e,i){var n,o,s;return null==i&&(i=this.getRange()),null!=i&&i.collapsed?(e=t(e)[0],n=i.endContainer,o=this.editor.util.getNodeLength(n),i.endOffset===o-1&&t(n).contents().last().is("br")||i.endOffset===o?e===n?!0:t.contains(e,n)?(s=!0,t(n).parentsUntil(e).addBack().each(function(){return function(e,i){var n,o;return o=t(i).parent().contents().filter(function(){return!(this!==i&&3===this.nodeType&&!this.nodeValue)}),n=o.last(),n.get(0)===i||n.is("br")&&n.prev().get(0)===i?void 0:(s=!1,!1)}}(this)),s):!1:!1):void 0},i.prototype.rangeAtStartOf=function(e,i){var n,o;return null==i&&(i=this.getRange()),null!=i&&i.collapsed?(e=t(e)[0],o=i.startContainer,0!==i.startOffset?!1:e===o?!0:t.contains(e,o)?(n=!0,t(o).parentsUntil(e).addBack().each(function(){return function(e,i){var o;return o=t(i).parent().contents().filter(function(){return!(this!==i&&3===this.nodeType&&!this.nodeValue)}),o.first().get(0)!==i?n=!1:void 0}}(this)),n):!1):void 0},i.prototype.insertNode=function(e,i){return null==i&&(i=this.getRange()),null!=i?(e=t(e)[0],i.insertNode(e),this.setRangeAfter(e,i)):void 0},i.prototype.setRangeAfter=function(e,i){return null==i&&(i=this.getRange()),null!=i?(e=t(e)[0],i.setEndAfter(e),i.collapse(!1),this.selectRange(i)):void 0},i.prototype.setRangeBefore=function(e,i){return null==i&&(i=this.getRange()),null!=i?(e=t(e)[0],i.setEndBefore(e),i.collapse(!1),this.selectRange(i)):void 0},i.prototype.setRangeAtStartOf=function(e,i){return null==i&&(i=this.getRange()),e=t(e).get(0),i.setEnd(e,0),i.collapse(!1),this.selectRange(i)},i.prototype.setRangeAtEndOf=function(e,i){var n,o,s,a,r,l;return null==i&&(i=this.getRange()),o=t(e),e=o.get(0),o.is("pre")?(s=o.contents(),s.length>0?(a=s.last(),r=a.text(),"\n"===r.charAt(r.length-1)?i.setEnd(a[0],this.editor.util.getNodeLength(a[0])-1):i.setEnd(a[0],this.editor.util.getNodeLength(a[0]))):i.setEnd(e,0)):(l=this.editor.util.getNodeLength(e),3!==e.nodeType&&l>0&&(n=t(e).contents().last(),n.is("br")?l-=1:3!==n[0].nodeType&&this.editor.util.isEmptyNode(n)&&(n.append(this.editor.util.phBr),e=n[0],l=0)),i.setEnd(e,l)),i.collapse(!1),this.selectRange(i)},i.prototype.deleteRangeContents=function(t){var e,i;return null==t&&(t=this.getRange()),i=t.cloneRange(),e=t.cloneRange(),i.collapse(!0),e.collapse(!1),!t.collapsed&&this.rangeAtStartOf(this.editor.body,i)&&this.rangeAtEndOf(this.editor.body,e)?(this.editor.body.empty(),t.setStart(this.editor.body[0],0),t.collapse(!0),this.selectRange(t)):t.deleteContents(),t},i.prototype.breakBlockEl=function(e,i){var n;return null==i&&(i=this.getRange()),n=t(e),i.collapsed?(i.setStartBefore(n.get(0)),i.collapsed?n:n.before(i.extractContents())):n},i.prototype.save=function(e){var i,n,o;return null==e&&(e=this.getRange()),this._selectionSaved?void 0:(n=e.cloneRange(),n.collapse(!1),o=t("<span/>").addClass("simditor-caret-start"),i=t("<span/>").addClass("simditor-caret-end"),n.insertNode(i[0]),e.insertNode(o[0]),this.clear(),this._selectionSaved=!0)},i.prototype.restore=function(){var t,e,i,n,o,s,a;return this._selectionSaved?(o=this.editor.body.find(".simditor-caret-start"),t=this.editor.body.find(".simditor-caret-end"),o.length&&t.length?(s=o.parent(),a=s.contents().index(o),e=t.parent(),i=e.contents().index(t),s[0]===e[0]&&(i-=1),n=document.createRange(),n.setStart(s.get(0),a),n.setEnd(e.get(0),i),o.remove(),t.remove(),this.selectRange(n)):(o.remove(),t.remove()),this._selectionSaved=!1,n):!1},i}(e),d=function(e){function i(){return i.__super__.constructor.apply(this,arguments)}return O(i,e),i.pluginName="Formatter",i.prototype.opts={allowedTags:null,allowedAttributes:null},i.prototype._init=function(){return this.editor=this._module,this._allowedTags=this.opts.allowedTags||["br","a","img","b","strong","i","u","font","p","ul","ol","li","blockquote","pre","h1","h2","h3","h4","hr"],this._allowedAttributes=this.opts.allowedAttributes||{img:["src","alt","width","height","data-image-src","data-image-size","data-image-name","data-non-image"],a:["href","target"],font:["color"],pre:["data-lang","class"],p:["data-indent","data-align"],h1:["data-indent"],h2:["data-indent"],h3:["data-indent"],h4:["data-indent"]},this.editor.body.on("click","a",function(){return function(){return!1}}(this))},i.prototype.decorate=function(t){return null==t&&(t=this.editor.body),this.editor.trigger("decorate",[t])},i.prototype.undecorate=function(e){return null==e&&(e=this.editor.body.clone()),this.editor.trigger("undecorate",[e]),t.trim(e.html())},i.prototype.autolink=function(e){var i,n,o,s,a,r,l,c,u,d,h;for(null==e&&(e=this.editor.body),r=[],n=function(i){return i.contents().each(function(i,o){var s,a;return s=t(o),s.is("a")||s.closest("a, pre",e).length?void 0:s.contents().length?n(s):(a=s.text())&&/https?:\/\/|www\./gi.test(a)?r.push(s):void 0})},n(e),c=/(https?:\/\/|www\.)[\w\-\.\?&=\/#%:,@\!\+]+/gi,o=0,a=r.length;a>o;o++){for(i=r[o],d=i.text(),u=[],l=null,s=0;null!==(l=c.exec(d));)u.push(document.createTextNode(d.substring(s,l.index))),s=c.lastIndex,h=/^(http(s)?:\/\/|\/)/.test(l[0])?l[0]:"http://"+l[0],u.push(t('<a href="'+h+'" rel="nofollow"></a>').text(l[0])[0]);u.push(document.createTextNode(d.substring(s))),i.replaceWith(t(u))}return e},i.prototype.format=function(e){var i,n,o,s,a,r,l,c,u,d;if(null==e&&(e=this.editor.body),e.is(":empty"))return e.append("<p>"+this.editor.util.phBr+"</p>"),e;for(u=e.contents(),o=0,a=u.length;a>o;o++)l=u[o],this.cleanNode(l,!0);for(d=e.contents(),s=0,r=d.length;r>s;s++)c=d[s],i=t(c),i.is("br")?("undefined"!=typeof n&&null!==n&&(n=null),i.remove()):this.editor.util.isBlockNode(c)?i.is("li")?n&&n.is("ul, ol")?n.append(c):(n=t("<ul/>").insertBefore(c),n.append(c)):n=null:((!n||n.is("ul, ol"))&&(n=t("<p/>").insertBefore(c)),n.append(c));return e},i.prototype.cleanNode=function(e,i){var n,o,s,a,r,l,c,u,d,h,p,f,m,v,g,y,w;if(o=t(e),o.length>0){if(3===o[0].nodeType)return y=o.text().replace(/(\r\n|\n|\r)/gm,""),void(y?(w=document.createTextNode(y),o.replaceWith(w)):o.remove());if(c=o.contents(),u=o.is('[class^="simditor-"]'),o.is(this._allowedTags.join(","))||u){if(o.is("a")&&(n=o.find("img")).length>0&&(o.replaceWith(n),o=n,c=null),o.is("img")&&o.hasClass("uploading")&&o.remove(),!u)for(r=this._allowedAttributes[o[0].tagName.toLowerCase()],v=t.makeArray(o[0].attributes),d=0,p=v.length;p>d;d++)l=v[d],null!=r&&(g=l.name,j.call(r,g)>=0)||o.removeAttr(l.name)}else 1!==o[0].nodeType||o.is(":empty")?(o.remove(),c=null):o.is("div, article, dl, header, footer, tr")?(o.append("<br/>"),c.first().unwrap()):o.is("table")?(s=t("<p/>"),o.find("tr").each(function(){return function(e,i){return s.append(t(i).text()+"<br/>")}}(this)),o.replaceWith(s),c=null):o.is("thead, tfoot")?(o.remove(),c=null):o.is("th")?(a=t("<td/>").append(o.contents()),o.replaceWith(a)):c.first().unwrap();if(i&&null!=c&&!o.is("pre"))for(h=0,f=c.length;f>h;h++)m=c[h],this.cleanNode(m,!0);return null}},i.prototype.clearHtml=function(e,i){var n,o,s;return null==i&&(i=!0),n=t("<div/>").append(e),o=n.contents(),s="",o.each(function(e){return function(n,a){var r,l;return 3===a.nodeType?s+=a.nodeValue:1===a.nodeType&&(r=t(a),l=r.contents(),l.length>0&&(s+=e.clearHtml(l)),i&&n<o.length-1&&r.is("br, p, div, li, tr, pre, address, artticle, aside, dl, figcaption, footer, h1, h2, h3, h4, header"))?s+="\n":void 0}}(this)),s},i.prototype.beautify=function(e){var i;return i=function(t){return!!(t.is("p")&&!t.text()&&t.children(":not(br)").length<1)},e.each(function(){return function(e,n){var o;return o=t(n),o.is(':not(img, br, col, td, hr, [class^="simditor-"]):empty')&&o.remove(),i(o)&&o.remove(),o.find(':not(img, br, col, td, hr, [class^="simditor-"]):empty').remove()}}(this))},i}(e),g=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return O(n,e),n.pluginName="InputManager",n.prototype.opts={pasteImage:!1},n.prototype._modifierKeys=[16,17,18,91,93,224],n.prototype._arrowKeys=[37,38,39,40],n.prototype._init=function(){var e;return this.editor=this._module,this.throttledTrigger=this.editor.util.throttle(function(t){return function(){var e;return e=1<=arguments.length?R.call(arguments,0):[],setTimeout(function(){var i;return(i=t.editor).trigger.apply(i,e)},10)}}(this),300),this.opts.pasteImage&&"string"!=typeof this.opts.pasteImage&&(this.opts.pasteImage="inline"),this._keystrokeHandlers={},this.hotkeys=i({el:this.editor.body}),this._pasteArea=t("<div/>").css({width:"1px",height:"1px",overflow:"hidden",position:"fixed",right:"0",bottom:"100px"}).attr({tabIndex:"-1",contentEditable:!0}).addClass("simditor-paste-area").appendTo(this.editor.el),t(document).on("selectionchange.simditor"+this.editor.id,function(t){return function(){return t.focused?(t._selectionTimer&&(clearTimeout(t._selectionTimer),t._selectionTimer=null),t._selectionTimer=setTimeout(function(){return t.editor.trigger("selectionchanged")},20)):void 0}}(this)),this.editor.on("valuechanged",function(e){return function(){return!e.editor.util.closestBlockEl()&&e.focused&&(e.editor.selection.save(),e.editor.formatter.format(),e.editor.selection.restore()),e.editor.body.find("hr, pre, .simditor-table").each(function(i,n){var o,s;return o=t(n),(o.parent().is("blockquote")||o.parent()[0]===e.editor.body[0])&&(s=!1,0===o.next().length&&(t("<p/>").append(e.editor.util.phBr).insertAfter(o),s=!0),0===o.prev().length&&(t("<p/>").append(e.editor.util.phBr).insertBefore(o),s=!0),s)?setTimeout(function(){return e.editor.trigger("valuechanged")},10):void 0}),e.editor.body.find("pre:empty").append(e.editor.util.phBr),!e.editor.util.support.onselectionchange&&e.focused?e.editor.trigger("selectionchanged"):void 0}}(this)),this.editor.on("selectionchanged",function(t){return function(){return t.editor.undoManager.update()}}(this)),this.editor.body.on("keydown",t.proxy(this._onKeyDown,this)).on("keypress",t.proxy(this._onKeyPress,this)).on("keyup",t.proxy(this._onKeyUp,this)).on("mouseup",t.proxy(this._onMouseUp,this)).on("focus",t.proxy(this._onFocus,this)).on("blur",t.proxy(this._onBlur,this)).on("paste",t.proxy(this._onPaste,this)).on("drop",t.proxy(this._onDrop,this)).on("input",t.proxy(this._onInput,this)),this.editor.util.browser.firefox&&(this.addShortcut("cmd+left",function(t){return function(e){return e.preventDefault(),t.editor.selection.sel.modify("move","backward","lineboundary"),!1}}(this)),this.addShortcut("cmd+right",function(t){return function(e){return e.preventDefault(),t.editor.selection.sel.modify("move","forward","lineboundary"),!1}}(this)),this.addShortcut("cmd+a",function(t){return function(){var e,i,n,o;return e=t.editor.body.children(),e.length>0?(i=e.first().get(0),n=e.last().get(0),o=document.createRange(),o.setStart(i,0),o.setEnd(n,t.editor.util.getNodeLength(n)),t.editor.selection.selectRange(o),!1):void 0}}(this))),e=this.editor.util.os.mac?"cmd+enter":"ctrl+enter",this.addShortcut(e,function(t){return function(){return t.editor.el.closest("form").find("button:submit").click(),!1}}(this)),this.editor.textarea.attr("autofocus")?setTimeout(function(t){return function(){return t.editor.focus()}}(this),0):void 0},n.prototype._onFocus=function(){return this.editor.el.addClass("focus").removeClass("error"),this.focused=!0,this.lastCaretPosition=null,setTimeout(function(t){return function(){return t.editor.triggerHandler("focus"),t.editor.trigger("selectionchanged")}}(this),0)},n.prototype._onBlur=function(){var t;return this.editor.el.removeClass("focus"),this.editor.sync(),this.focused=!1,this.lastCaretPosition=null!=(t=this.editor.undoManager.currentState())?t.caret:void 0,this.editor.triggerHandler("blur")},n.prototype._onMouseUp=function(){return this.editor.util.support.onselectionchange?void 0:setTimeout(function(t){return function(){return t.editor.trigger("selectionchanged")}}(this),0)},n.prototype._onKeyDown=function(e){var i,n,o,s;if(this.editor.triggerHandler(e)===!1)return!1;if(!this.hotkeys.respondTo(e)){if(e.which in this._keystrokeHandlers){if(s="function"==typeof(i=this._keystrokeHandlers[e.which])["*"]?i["*"](e):void 0)return this.editor.trigger("valuechanged"),!1;if(this.editor.util.traverseUp(function(i){return function(n){var o,a;if(n.nodeType===document.ELEMENT_NODE)return o=null!=(a=i._keystrokeHandlers[e.which])?a[n.tagName.toLowerCase()]:void 0,s="function"==typeof o?o(e,t(n)):void 0,s===!0||s===!1?!1:void 0}}(this)),s)return this.editor.trigger("valuechanged"),!1}if(n=e.which,!(j.call(this._modifierKeys,n)>=0||(o=e.which,j.call(this._arrowKeys,o)>=0)||this.editor.util.metaKey(e)&&86===e.which))return this.editor.util.support.oninput||this.throttledTrigger("valuechanged",["typing"]),null}},n.prototype._onKeyPress=function(t){return this.editor.triggerHandler(t)===!1?!1:void 0},n.prototype._onKeyUp=function(e){var i,n;return this.editor.triggerHandler(e)===!1?!1:!this.editor.util.support.onselectionchange&&(n=e.which,j.call(this._arrowKeys,n)>=0)?void this.editor.trigger("selectionchanged"):void(8!==e.which&&46!==e.which||!this.editor.util.isEmptyNode(this.editor.body)||(this.editor.body.empty(),i=t("<p/>").append(this.editor.util.phBr).appendTo(this.editor.body),this.editor.selection.setRangeAtStartOf(i)))},n.prototype._onPaste=function(e){var i,n,o,s,a,r,l,c,u;if(this.editor.triggerHandler(e)===!1)return!1;if(l=this.editor.selection.deleteRangeContents(),l.collapsed||l.collapse(!0),i=this.editor.util.closestBlockEl(),n=i.is("pre, table"),e.originalEvent.clipboardData&&e.originalEvent.clipboardData.items&&e.originalEvent.clipboardData.items.length>0&&(a=e.originalEvent.clipboardData.items[0],/^image\//.test(a.type)&&!n)){if(o=a.getAsFile(),null==o||!this.opts.pasteImage)return;return o.name||(o.name="Clipboard Image.png"),u={},u[this.opts.pasteImage]=!0,null!=(c=this.editor.uploader)&&c.upload(o,u),!1}return r=function(e){return function(o){var s,a,r,c,d,h,p,f,m,v,g,y,w,b,x,C,T,k,S,E,_;if(e.editor.triggerHandler("pasting",[o])!==!1&&o){if(n)if(i.is("table")){for(x=o.split("\n"),f=x.pop(),d=0,m=x.length;m>d;d++)b=x[d],e.editor.selection.insertNode(document.createTextNode(b)),e.editor.selection.insertNode(t("<br/>"));e.editor.selection.insertNode(document.createTextNode(f))}else for(o=t("<div/>").text(o),S=o.contents(),h=0,v=S.length;v>h;h++)T=S[h],e.editor.selection.insertNode(t(T)[0],l);else if(i.is(e.editor.body))for(p=0,g=o.length;g>p;p++)T=o[p],e.editor.selection.insertNode(T,l);else{if(o.length<1)return;if(1===o.length)if(o.is("p")){if(r=o.contents(),1===r.length&&r.is("img")){if(s=r,/^data:image/.test(s.attr("src"))){if(!e.opts.pasteImage)return;return a=e.editor.util.dataURLtoBlob(s.attr("src")),a.name="Clipboard Image.png",u={},u[e.opts.pasteImage]=!0,void(null!=(E=e.editor.uploader)&&E.upload(a,u))}if(s.is('img[src^="webkit-fake-url://"]'))return}for(C=0,y=r.length;y>C;C++)T=r[C],e.editor.selection.insertNode(T,l)}else if(i.is("p")&&e.editor.util.isEmptyNode(i))i.replaceWith(o),e.editor.selection.setRangeAtEndOf(o,l);else if(o.is("ul, ol"))if(1===o.find("li").length)for(o=t("<div/>").text(o.text()),_=o.contents(),k=0,w=_.length;w>k;k++)T=_[k],e.editor.selection.insertNode(t(T)[0],l);else i.is("li")?(i.parent().after(o),e.editor.selection.setRangeAtEndOf(o,l)):(i.after(o),e.editor.selection.setRangeAtEndOf(o,l));else i.after(o),e.editor.selection.setRangeAtEndOf(o,l);else i.is("li")&&(i=i.parent()),e.editor.selection.rangeAtStartOf(i,l)?c="before":e.editor.selection.rangeAtEndOf(i,l)?c="after":(e.editor.selection.breakBlockEl(i,l),c="before"),i[c](o),e.editor.selection.setRangeAtEndOf(o.last(),l)}return e.editor.trigger("valuechanged")}}}(this),n?(e.preventDefault(),s=this.editor.util.browser.msie?window.clipboardData.getData("Text"):e.originalEvent.clipboardData.getData("text/plain"),r(s)):(this.editor.selection.save(l),this._pasteArea.focus(),this.editor.util.browser.msie&&10===this.editor.util.browser.version&&(e.preventDefault(),this._pasteArea.html(window.clipboardData.getData("Text"))),setTimeout(function(e){return function(){return e._pasteArea.is(":empty")?s=null:(s=t("<div/>").append(e._pasteArea.contents()),s.find("table colgroup").remove(),e.editor.formatter.format(s),e.editor.formatter.decorate(s),e.editor.formatter.beautify(s.children()),s=s.contents()),e._pasteArea.empty(),l=e.editor.selection.restore(),r(s)}}(this),10))},n.prototype._onDrop=function(t){return this.editor.triggerHandler(t)===!1?!1:setTimeout(function(t){return function(){return t.editor.trigger("valuechanged")}}(this),0)},n.prototype._onInput=function(){return this.throttledTrigger("valuechanged",["oninput"])},n.prototype.addKeystrokeHandler=function(t,e,i){return this._keystrokeHandlers[t]||(this._keystrokeHandlers[t]={}),this._keystrokeHandlers[t][e]=i},n.prototype.addShortcut=function(e,i){return this.hotkeys.add(e,t.proxy(i,this))},n}(e),w=function(e){function i(){return i.__super__.constructor.apply(this,arguments)}return O(i,e),i.pluginName="Keystroke",i.prototype._init=function(){var e;return this.editor=this._module,this.editor.util.browser.safari&&this.editor.inputManager.addKeystrokeHandler("13","*",function(e){return function(i){var n,o;if(i.shiftKey&&(n=e.editor.util.closestBlockEl(),!n.is("pre")))return o=t("<br/>"),e.editor.selection.rangeAtEndOf(n)?(e.editor.selection.insertNode(o),e.editor.selection.insertNode(t("<br/>")),e.editor.selection.setRangeBefore(o)):e.editor.selection.insertNode(o),!0}}(this)),(this.editor.util.browser.webkit||this.editor.util.browser.msie)&&(e=function(e){return function(i,n){var o;if(e.editor.selection.rangeAtEndOf(n))return o=t("<p/>").append(e.editor.util.phBr).insertAfter(n),e.editor.selection.setRangeAtStartOf(o),!0}}(this),this.editor.inputManager.addKeystrokeHandler("13","h1",e),this.editor.inputManager.addKeystrokeHandler("13","h2",e),this.editor.inputManager.addKeystrokeHandler("13","h3",e),this.editor.inputManager.addKeystrokeHandler("13","h4",e),this.editor.inputManager.addKeystrokeHandler("13","h5",e),this.editor.inputManager.addKeystrokeHandler("13","h6",e)),this.editor.inputManager.addKeystrokeHandler("8","*",function(t){return function(){var e,i,n;return n=t.editor.util.furthestBlockEl(),i=n.prev(),i.is("hr")&&t.editor.selection.rangeAtStartOf(n)?(t.editor.selection.save(),i.remove(),t.editor.selection.restore(),!0):(e=t.editor.util.closestBlockEl(),t.editor.util.browser.webkit&&t.editor.selection.rangeAtStartOf(e)?(t.editor.selection.save(),t.editor.formatter.cleanNode(e,!0),t.editor.selection.restore(),null):void 0)}}(this)),this.editor.inputManager.addKeystrokeHandler("13","li",function(e){return function(i,n){var o,s,a,r;if(o=n.clone(),o.find("ul, ol").remove(),e.editor.util.isEmptyNode(o)&&n.is(e.editor.util.closestBlockEl())){if(s=n.parent(),n.next("li").length>0){if(!e.editor.util.isEmptyNode(n))return;s.parent("li").length>0?(a=t("<li/>").append(e.editor.util.phBr).insertAfter(s.parent("li")),r=t("<"+s[0].tagName+"/>").append(n.nextAll("li")),a.append(r)):(a=t("<p/>").append(e.editor.util.phBr).insertAfter(s),r=t("<"+s[0].tagName+"/>").append(n.nextAll("li")),a.after(r))}else s.parent("li").length>0?(a=t("<li/>").insertAfter(s.parent("li")),a.append(n.contents().length>0?n.contents():e.editor.util.phBr)):(a=t("<p/>").append(e.editor.util.phBr).insertAfter(s),n.children("ul, ol").length>0&&a.after(n.children("ul, ol")));return n.prev("li").length?n.remove():s.remove(),e.editor.selection.setRangeAtStartOf(a),!0}}}(this)),this.editor.inputManager.addKeystrokeHandler("13","pre",function(e){return function(i,n){var o,s,a;return i.preventDefault(),i.shiftKey?(o=t("<p/>").append(e.editor.util.phBr).insertAfter(n),e.editor.selection.setRangeAtStartOf(o),!0):(a=e.editor.selection.getRange(),s=null,a.deleteContents(),!e.editor.util.browser.msie&&e.editor.selection.rangeAtEndOf(n)?(s=document.createTextNode("\n\n"),a.insertNode(s),a.setEnd(s,1)):(s=document.createTextNode("\n"),a.insertNode(s),a.setStartAfter(s)),a.collapse(!1),e.editor.selection.selectRange(a),!0)}}(this)),this.editor.inputManager.addKeystrokeHandler("13","blockquote",function(t){return function(e,i){var n,o;return n=t.editor.util.closestBlockEl(),n.is("p")&&!n.next().length&&t.editor.util.isEmptyNode(n)?(i.after(n),o=document.createRange(),t.editor.selection.setRangeAtStartOf(n,o),!0):void 0}}(this)),this.editor.inputManager.addKeystrokeHandler("8","li",function(e){return function(i,n){var o,s,a,r,l,c,u,d;return s=n.children("ul, ol"),l=n.prev("li"),s.length>0&&l.length>0?(d="",c=null,n.contents().each(function(e,i){if(1===i.nodeType&&/UL|OL/.test(i.nodeName))return!1;if(1!==i.nodeType||!/BR/.test(i.nodeName))return 3===i.nodeType&&i.nodeValue?d+=i.nodeValue:1===i.nodeType&&(d+=t(i).text()),c=t(i)}),c&&1===d.length&&e.editor.util.browser.firefox&&!c.next("br").length?(o=t(e.editor.util.phBr).insertAfter(c),c.remove(),e.editor.selection.setRangeBefore(o),!0):d.length>0?!1:(u=document.createRange(),r=l.children("ul, ol"),r.length>0?(a=t("<li/>").append(e.editor.util.phBr).appendTo(r),r.append(s.children("li")),n.remove(),e.editor.selection.setRangeAtEndOf(a,u)):(e.editor.selection.setRangeAtEndOf(l,u),l.append(s),n.remove(),e.editor.selection.selectRange(u)),!0)):!1}}(this)),this.editor.inputManager.addKeystrokeHandler("8","pre",function(e){return function(i,n){var o,s,a;if(e.editor.selection.rangeAtStartOf(n))return s=n.html().replace("\n","<br/>"),o=t("<p/>").append(s||e.editor.util.phBr).insertAfter(n),n.remove(),a=document.createRange(),e.editor.selection.setRangeAtStartOf(o,a),!0}}(this)),this.editor.inputManager.addKeystrokeHandler("8","blockquote",function(t){return function(e,i){var n,o;if(t.editor.selection.rangeAtStartOf(i))return n=i.children().first().unwrap(),o=document.createRange(),t.editor.selection.setRangeAtStartOf(n,o),!0}}(this))},i}(e),P=function(e){function i(){return i.__super__.constructor.apply(this,arguments)}return O(i,e),i.pluginName="UndoManager",i.prototype._index=-1,i.prototype._capacity=50,i.prototype._timer=null,i.prototype._init=function(){var t,e;return this.editor=this._module,this._stack=[],this.editor.util.os.mac?(e="cmd+z",t="shift+cmd+z"):this.editor.util.os.win?(e="ctrl+z",t="ctrl+y"):(e="ctrl+z",t="shift+ctrl+z"),this.editor.inputManager.addShortcut(e,function(t){return function(e){return e.preventDefault(),t.undo(),!1}}(this)),this.editor.inputManager.addShortcut(t,function(t){return function(e){return e.preventDefault(),t.redo(),!1}}(this)),this.editor.on("valuechanged",function(t){return function(e,i){return"undo"!==i&&"redo"!==i?(t._timer&&(clearTimeout(t._timer),t._timer=null),t._timer=setTimeout(function(){return t._pushUndoState(),t._timer=null},200)):void 0}}(this))},i.prototype._pushUndoState=function(){var t,e;if(this.editor.triggerHandler("pushundostate")!==!1&&(t=this.currentState(),e=this.editor.body.html(),!t||t.html!==e))return this._index+=1,this._stack.length=this._index,this._stack.push({html:e,caret:this.caretPosition()}),this._stack.length>this._capacity?(this._stack.shift(),this._index-=1):void 0},i.prototype.currentState=function(){return this._stack.length&&this._index>-1?this._stack[this._index]:null},i.prototype.undo=function(){var t;if(!(this._index<1||this._stack.length<2))return this.editor.hidePopover(),this._index-=1,t=this._stack[this._index],this.editor.body.html(t.html),this.caretPosition(t.caret),this.editor.body.find(".selected").removeClass("selected"),this.editor.sync(),this.editor.trigger("valuechanged",["undo"])},i.prototype.redo=function(){var t;if(!(this._index<0||this._stack.length<this._index+2))return this.editor.hidePopover(),this._index+=1,t=this._stack[this._index],this.editor.body.html(t.html),this.caretPosition(t.caret),this.editor.body.find(".selected").removeClass("selected"),this.editor.sync(),this.editor.trigger("valuechanged",["redo"])},i.prototype.update=function(){var t,e;if(!this._timer&&(t=this.currentState()))return e=this.editor.body.html(),t.html=e,t.caret=this.caretPosition()},i.prototype._getNodeOffset=function(e,i){var n,o,s;return n=i?t(e):t(e).parent(),s=0,o=!1,n.contents().each(function(){return function(t,n){return i===t||e===n?!1:(3===n.nodeType?o||(s+=1,o=!0):(s+=1,o=!1),null)}}(this)),s},i.prototype._getNodePosition=function(t,e){var i,n;if(3===t.nodeType)for(n=t.previousSibling;n&&3===n.nodeType;)t=n,e+=this.editor.util.getNodeLength(n),n=n.previousSibling;else e=this._getNodeOffset(t,e);return i=[],i.unshift(e),this.editor.util.traverseUp(function(t){return function(e){return i.unshift(t._getNodeOffset(e))}}(this),t),i},i.prototype._getNodeByPosition=function(e){var i,n,o,s,a,r,l,c;for(r=this.editor.body[0],c=e.slice(0,e.length-1),o=s=0,a=c.length;a>s;o=++s){if(l=c[o],n=r.childNodes,l>n.length-1){if(o!==e.length-2||!t(r).is("pre")){r=null;break}i=document.createTextNode(""),r.appendChild(i),n=r.childNodes}r=n[l]}return r},i.prototype.caretPosition=function(t){var e,i,n,o,s;if(t){if(this.editor.inputManager.focused||this.editor.body.focus(),!t.start)return void this.editor.body.blur();if(o=this._getNodeByPosition(t.start),s=t.start[t.start.length-1],t.collapsed?(e=o,i=s):(e=this._getNodeByPosition(t.end),i=t.start[t.start.length-1]),!o||!e)throw new Error("simditor: invalid caret state");return n=document.createRange(),n.setStart(o,s),n.setEnd(e,i),this.editor.selection.selectRange(n)}return n=this.editor.selection.getRange(),this.editor.inputManager.focused&&null!=n?(t={start:[],end:null,collapsed:!0},t.start=this._getNodePosition(n.startContainer,n.startOffset),n.collapsed||(t.end=this._getNodePosition(n.endContainer,n.endOffset),t.collapsed=!1),t):{}},i}(e),$=function(e){function i(){return i.__super__.constructor.apply(this,arguments)}return O(i,e),i.pluginName="Util",i.prototype._init=function(){return this.editor=this._module,this.browser.msie&&this.browser.version<11?this.phBr="":void 0},i.prototype.phBr="<br/>",i.prototype.os=function(){var t;return t={},/Mac/.test(navigator.appVersion)?t.mac=!0:/Linux/.test(navigator.appVersion)?t.linux=!0:/Win/.test(navigator.appVersion)?t.win=!0:/X11/.test(navigator.appVersion)&&(t.unix=!0),/Mobi/.test(navigator.appVersion)&&(t.mobile=!0),t}(),i.prototype.browser=function(){var t,e,i,n,o,s,a,r,l;return l=navigator.userAgent,i=/(msie|trident)/i.test(l),t=/chrome|crios/i.test(l),r=/safari/i.test(l)&&!t,e=/firefox/i.test(l),i?{msie:!0,version:1*(null!=(n=l.match(/(msie |rv:)(\d+(\.\d+)?)/i))?n[2]:void 0)}:t?{webkit:!0,chrome:!0,version:1*(null!=(o=l.match(/(?:chrome|crios)\/(\d+(\.\d+)?)/i))?o[1]:void 0)}:r?{webkit:!0,safari:!0,version:1*(null!=(s=l.match(/version\/(\d+(\.\d+)?)/i))?s[1]:void 0)}:e?{mozilla:!0,firefox:!0,version:1*(null!=(a=l.match(/firefox\/(\d+(\.\d+)?)/i))?a[1]:void 0)}:{}}(),i.prototype.support=function(){return{onselectionchange:function(){var t,e;if(e=document.onselectionchange,void 0!==e)try{return document.onselectionchange=0,null===document.onselectionchange}catch(i){t=i}finally{document.onselectionchange=e}return!1}(),oninput:function(){return!/(msie|trident)/i.test(navigator.userAgent)}()}}(),i.prototype.reflow=function(e){return null==e&&(e=document),t(e)[0].offsetHeight},i.prototype.metaKey=function(t){var e;return e=/Mac/.test(navigator.userAgent),e?t.metaKey:t.ctrlKey},i.prototype.isEmptyNode=function(e){var i;return i=t(e),i.is(":empty")||!i.text()&&!i.find(":not(br, span, div)").length},i.prototype.blockNodes=["div","p","ul","ol","li","blockquote","hr","pre","h1","h2","h3","h4","table"],i.prototype.isBlockNode=function(e){return e=t(e)[0],e&&3!==e.nodeType?new RegExp("^("+this.blockNodes.join("|")+")$").test(e.nodeName.toLowerCase()):!1},i.prototype.closestBlockEl=function(e){var i,n,o;return null==e&&(o=this.editor.selection.getRange(),e=null!=o?o.commonAncestorContainer:void 0),i=t(e),i.length?(n=i.parentsUntil(this.editor.body).addBack(),n=n.filter(function(t){return function(e){return t.isBlockNode(n.eq(e))}}(this)),n.length?n.last():null):null},i.prototype.furthestNode=function(e,i){var n,o,s;return null==e&&(s=this.editor.selection.getRange(),e=null!=s?s.commonAncestorContainer:void 0),n=t(e),n.length?(o=n.parentsUntil(this.editor.body).addBack(),o=o.filter(function(){return function(e){var n;return n=o.eq(e),t.isFunction(i)?i(n):n.is(i)}}(this)),o.length?o.first():null):null},i.prototype.furthestBlockEl=function(e){return this.furthestNode(e,t.proxy(this.isBlockNode,this))},i.prototype.getNodeLength=function(t){switch(t.nodeType){case 7:case 10:return 0;case 3:case 8:return t.length;default:return t.childNodes.length}},i.prototype.traverseUp=function(e,i){var n,o,s,a,r,l,c;if(null==i&&(r=this.editor.selection.getRange(),i=null!=r?r.commonAncestorContainer:void 0),null==i||!t.contains(this.editor.body[0],i))return!1;for(a=t(i).parentsUntil(this.editor.body).get(),a.unshift(i),c=[],n=0,o=a.length;o>n&&(s=a[n],l=e(s),l!==!1);n++)c.push(void 0);return c},i.prototype.dataURLtoBlob=function(t){var e,i,n,o,s,a,r,l,c,u,d;if(a=window.Blob&&function(){var t;try{return Boolean(new Blob)}catch(e){return t=e,!1}}(),s=a&&window.Uint8Array&&function(){var t;try{return 100===new Blob([new Uint8Array(100)]).size}catch(e){return t=e,!1}}(),e=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder,!((a||e)&&window.atob&&window.ArrayBuffer&&window.Uint8Array))return!1;for(o=t.split(",")[0].indexOf("base64")>=0?atob(t.split(",")[1]):decodeURIComponent(t.split(",")[1]),i=new ArrayBuffer(o.length),l=new Uint8Array(i),r=c=0,d=o.length;d>=0?d>=c:c>=d;r=d>=0?++c:--c)l[r]=o.charCodeAt(r);return u=t.split(",")[0].split(":")[1].split(";")[0],a?new Blob([s?l:i],{type:u}):(n=new e,n.append(i),n.getBlob(u))},i.prototype.throttle=function(t,e){var i,n,o;return i=null,n=0,o=function(){return i?(clearTimeout(i),i=null):void 0},function(){var s,a,r,l;return a=Date.now(),n||(n=a),r=e-(a-n),l=null,r>0&&e>r?(n=a,o(),s=arguments,i=setTimeout(function(){return n=0,i=null,l=t.apply(null,s)},e)):(o(),n!==a&&(n=0),l=t.apply(null,arguments)),l}},i.prototype.formatHTML=function(e){var i,n,o,s,a,r,l,c,u;for(r=/<(\/?)(.+?)(\/?)>/g,c="",s=0,o=null,n="  ",l=function(t,e){return new Array(e+1).join(t)};null!==(a=r.exec(e));)a.isBlockNode=t.inArray(a[2],this.blockNodes)>-1,a.isStartTag="/"!==a[1]&&"/"!==a[3],a.isEndTag="/"===a[1]||"/"===a[3],i=o?o.index+o[0].length:0,(u=e.substring(i,a.index)).length>0&&t.trim(u)&&(c+=u),a.isBlockNode&&a.isEndTag&&!a.isStartTag&&(s-=1),a.isBlockNode&&a.isStartTag&&(o&&o.isBlockNode&&o.isEndTag||(c+="\n"),c+=l(n,s)),c+=a[0],a.isBlockNode&&a.isEndTag&&(c+="\n"),a.isBlockNode&&a.isStartTag&&(s+=1),o=a;return t.trim(c)},i}(e),M=function(e){function i(){return i.__super__.constructor.apply(this,arguments)}return O(i,e),i.pluginName="Toolbar",i.prototype.opts={toolbar:!0,toolbarFloat:!0,toolbarHidden:!1,toolbarFloatOffset:0},i.prototype._tpl={wrapper:'<div class="simditor-toolbar"><ul></ul></div>',separator:'<li><span class="separator"></span></li>'},i.prototype._init=function(){var e;return this.editor=this._module,this.opts.toolbar?(t.isArray(this.opts.toolbar)||(this.opts.toolbar=["bold","italic","underline","strikethrough","|","ol","ul","blockquote","code","|","link","image","|","indent","outdent"]),this._render(),this.list.on("click",function(){return function(){return!1}}(this)),this.wrapper.on("mousedown",function(t){return function(){return t.list.find(".menu-on").removeClass(".menu-on")}}(this)),t(document).on("mousedown.simditor"+this.editor.id,function(t){return function(){return t.list.find(".menu-on").removeClass(".menu-on")}}(this)),!this.opts.toolbarHidden&&this.opts.toolbarFloat&&(this.wrapper.css("top",this.opts.toolbarFloatOffset),e=0,t(window).on("resize.simditor-"+this.editor.id,function(t){return function(){return t.wrapper.css("position","static"),t.wrapper.width("auto"),t.editor.util.reflow(t.wrapper),t.wrapper.width(t.wrapper.outerWidth()),t.wrapper.css("left",t.wrapper.offset().left),t.wrapper.css("position",""),e=t.wrapper.outerHeight(),t.editor.placeholderEl.css("top",e)
}}(this)).resize(),t(window).on("scroll.simditor-"+this.editor.id,function(i){return function(){var n,o,s;if(s=i.editor.wrapper.offset().top,n=s+i.editor.wrapper.outerHeight()-80,o=t(document).scrollTop()+i.opts.toolbarFloatOffset,s>=o||o>=n){if(i.editor.wrapper.removeClass("toolbar-floating").css("padding-top",""),i.editor.util.os.mobile)return i.wrapper.css("top",i.opts.toolbarFloatOffset)}else if(i.editor.wrapper.addClass("toolbar-floating").css("padding-top",e),i.editor.util.os.mobile)return i.wrapper.css("top",o-s+i.opts.toolbarFloatOffset)}}(this))),this.editor.on("selectionchanged",function(t){return function(){return t.toolbarStatus()}}(this)),this.editor.on("destroy",function(t){return function(){return t.buttons.length=0}}(this)),t(document).on("mousedown.simditor-"+this.editor.id,function(t){return function(){return t.list.find("li.menu-on").removeClass("menu-on")}}(this))):void 0},i.prototype._render=function(){var e,i,n,o;for(this.buttons=[],this.wrapper=t(this._tpl.wrapper).prependTo(this.editor.wrapper),this.list=this.wrapper.find("ul"),o=this.opts.toolbar,e=0,i=o.length;i>e;e++)if(n=o[e],"|"!==n){if(!this.constructor.buttons[n])throw new Error('simditor: invalid toolbar button "'+n+'"');this.buttons.push(new this.constructor.buttons[n]({editor:this.editor}))}else t(this._tpl.separator).appendTo(this.list);return this.opts.toolbarHidden?this.wrapper.hide():void 0},i.prototype.toolbarStatus=function(e){var i;if(this.editor.inputManager.focused)return i=this.buttons.slice(0),this.editor.util.traverseUp(function(){return function(n){var o,s,a,r,l,c,u;for(u=[],s=a=0,l=i.length;l>a;s=++a)o=i[s],(null==e||o.name===e)&&(o.status&&o.status(t(n))!==!0||u.push(o));for(r=0,c=u.length;c>r;r++)o=u[r],s=t.inArray(o,i),i.splice(s,1);return 0===i.length?!1:void 0}}(this))},i.prototype.findButton=function(t){var e;return e=this.list.find(".toolbar-item-"+t).data("button"),null!=e?e:null},i.addButton=function(t){return this.buttons[t.prototype.name]=t},i.buttons={},i}(e),v=function(e){function i(){return i.__super__.constructor.apply(this,arguments)}return O(i,e),i.pluginName="Indentation",i.prototype.opts={tabIndent:!0},i.prototype._init=function(){return this.editor=this._module,this.editor.inputManager.addKeystrokeHandler("9","*",function(t){return function(e){var i;return i=t.editor.toolbar.findButton("code"),t.opts.tabIndent||i&&i.active?t.indent(e.shiftKey):void 0}}(this))},i.prototype.indent=function(t){var e,i,n,o,s;return(o=this.editor.selection.getRange())?(n=this.editor.util.closestBlockEl(o.startContainer),i=this.editor.util.closestBlockEl(o.endContainer),n.is("li")&&i.is("li")&&n.parent().is(i.parent())||(n=this.editor.util.furthestBlockEl(n),i=this.editor.util.furthestBlockEl(i)),e=n.is(i)?n:n.nextUntil(i).add(n).add(i),s=!1,e.each(function(e){return function(i,n){return s=t?e.outdentBlock(n):e.indentBlock(n)}}(this)),s):void 0},i.prototype.indentBlock=function(e){var i,n,o,s,a,r,l,c,u;if(i=t(e),i.length){if(i.is("pre")){if(c=this.editor.selection.getRange(),a=t(c.commonAncestorContainer),!a.is(i)&&!a.closest("pre").is(i))return;this.indentText(c)}else if(i.is("li")){if(s=i.prev("li"),s.length<1)return;this.editor.selection.save(),u=i.parent()[0].tagName,n=s.children("ul, ol"),n.length>0?n.append(i):t("<"+u+"/>").append(i).appendTo(s),this.editor.selection.restore()}else if(i.is("p, h1, h2, h3, h4"))l=i.attr("data-indent")||0,l=Math.min(1*l+1,10),i.attr("data-indent",l);else if(i.is("table")||i.is(".simditor-table")){if(c=this.editor.selection.getRange(),r=t(c.commonAncestorContainer).closest("td"),o=r.next("td"),o.length>0||(o=r.parent("tr").next("tr").find("td:first")),!(r.length>0&&o.length>0))return!1;this.editor.selection.setRangeAtEndOf(o)}return!0}},i.prototype.indentText=function(t){var e,i;return e=t.toString().replace(/^(?=.+)/gm,"\xa0\xa0"),i=document.createTextNode(e||"\xa0\xa0"),t.deleteContents(),t.insertNode(i),e?(t.selectNode(i),this.editor.selection.selectRange(t)):this.editor.selection.setRangeAfter(i)},i.prototype.outdentBlock=function(e){var i,n,o,s,a,r,l,c,u,d;if(i=t(e),i&&i.length>0){if(i.is("pre")){if(u=this.editor.selection.getRange(),s=t(u.commonAncestorContainer),!s.is(i)&&!s.closest("pre").is(i))return;this.outdentText(u)}else if(i.is("li")){if(n=i.parent(),o=n.parent("li"),o.length<1)return l=this.editor.toolbar.findButton(n[0].tagName.toLowerCase()),void(null!=l&&l.command());this.editor.selection.save(),i.next("li").length>0&&t("<"+n[0].tagName+"/>").append(i.nextAll("li")).appendTo(i),i.insertAfter(o),n.children("li").length<1&&n.remove(),this.editor.selection.restore()}else if(i.is("p, h1, h2, h3, h4"))c=null!=(d=i.attr("data-indent"))?d:0,c=1*c-1,0>c&&(c=0),i.attr("data-indent",c);else if(i.is("table")||i.is(".simditor-table")){if(u=this.editor.selection.getRange(),r=t(u.commonAncestorContainer).closest("td"),a=r.prev("td"),a.length>0||(a=r.parent("tr").prev("tr").find("td:last")),!(r.length>0&&a.length>0))return;this.editor.selection.setRangeAtEndOf(a)}return!0}},i.prototype.outdentText=function(){},i}(e),_=function(e){function i(){return i.__super__.constructor.apply(this,arguments)}return O(i,e),i.connect($),i.connect(g),i.connect(P),i.connect(w),i.connect(d),i.connect(E),i.connect(M),i.connect(v),i.count=0,i.prototype.opts={textarea:null,placeholder:"",defaultImage:"images/image.png",params:{},upload:!1},i.prototype._init=function(){var e,o,s,a;if(this.textarea=t(this.opts.textarea),this.opts.placeholder=this.opts.placeholder||this.textarea.attr("placeholder"),!this.textarea.length)throw new Error("simditor: param textarea is required.");if(o=this.textarea.data("simditor"),null!=o&&o.destroy(),this.id=++i.count,this._render(),this.opts.upload&&n&&(a="object"==typeof this.opts.upload?this.opts.upload:{},this.uploader=n(a)),s=this.textarea.closest("form"),s.length&&(s.on("submit.simditor-"+this.id,function(t){return function(){return t.sync()}}(this)),s.on("reset.simditor-"+this.id,function(t){return function(){return t.setValue("")}}(this))),this.on("initialized",function(t){return function(){return t.opts.placeholder&&t.on("valuechanged",function(){return t._placeholder()}),t.setValue(t.textarea.val().trim()||"")}}(this)),this.util.browser.mozilla){this.util.reflow();try{return document.execCommand("enableObjectResizing",!1,!1),document.execCommand("enableInlineTableEditing",!1,!1)}catch(r){e=r}}},i.prototype._tpl='<div class="simditor">\n  <div class="simditor-wrapper">\n    <div class="simditor-placeholder"></div>\n    <div class="simditor-body" contenteditable="true">\n    </div>\n  </div>\n</div>',i.prototype._render=function(){var e,i,n,o;if(this.el=t(this._tpl).insertBefore(this.textarea),this.wrapper=this.el.find(".simditor-wrapper"),this.body=this.wrapper.find(".simditor-body"),this.placeholderEl=this.wrapper.find(".simditor-placeholder").append(this.opts.placeholder),this.el.data("simditor",this),this.wrapper.append(this.textarea),this.textarea.data("simditor",this).blur(),this.body.attr("tabindex",this.textarea.attr("tabindex")),this.util.os.mac?this.el.addClass("simditor-mac"):this.util.os.linux&&this.el.addClass("simditor-linux"),this.util.os.mobile&&this.el.addClass("simditor-mobile"),this.opts.params){i=this.opts.params,n=[];for(e in i)o=i[e],n.push(t("<input/>",{type:"hidden",name:e,value:o}).insertAfter(this.textarea));return n}},i.prototype._placeholder=function(){var t,e;return t=this.body.children(),0===t.length||1===t.length&&this.util.isEmptyNode(t)&&(null!=(e=t.data("indent"))?e:0)<1?this.placeholderEl.show():this.placeholderEl.hide()},i.prototype.setValue=function(t){return this.hidePopover(),this.textarea.val(t),this.body.html(t),this.formatter.format(),this.formatter.decorate(),this.util.reflow(this.body),this.inputManager.lastCaretPosition=null,this.trigger("valuechanged")},i.prototype.getValue=function(){return this.sync()},i.prototype.sync=function(){var e,i,n,o,s,a;for(i=this.body.clone(),this.formatter.undecorate(i),this.formatter.format(i),this.formatter.autolink(i),e=i.children(),s=e.last("p"),o=e.first("p");s.is("p")&&this.util.isEmptyNode(s);)n=s,s=s.prev("p"),n.remove();for(;o.is("p")&&this.util.isEmptyNode(o);)n=o,o=s.next("p"),n.remove();return i.find("img.uploading").remove(),a=t.trim(i.html()),this.textarea.val(a),a},i.prototype.focus=function(){var e,i;return this.body.is(":visible")&&this.body.is("[contenteditable]")?this.inputManager.lastCaretPosition?this.undoManager.caretPosition(this.inputManager.lastCaretPosition):(e=this.body.find("p").last(),e.length>0||(e=t("<p/>").append(this.util.phBr).appendTo(this.body)),i=document.createRange(),this.selection.setRangeAtEndOf(e,i),this.body.focus()):void this.el.find("textarea:visible").focus()},i.prototype.blur=function(){return this.body.is(":visible")&&this.body.is("[contenteditable]")?this.body.blur():this.body.find("textarea:visible").blur()},i.prototype.hidePopover=function(){return this.el.find(".simditor-popover").each(function(){return function(e,i){return i=t(i).data("popover"),i.active?i.hide():void 0}}(this))},i.prototype.destroy=function(){return this.triggerHandler("destroy"),this.textarea.closest("form").off(".simditor .simditor-"+this.id),this.selection.clear(),this.inputManager.focused=!1,this.textarea.insertBefore(this.el).hide().val("").removeData("simditor"),this.el.remove(),t(document).off(".simditor-"+this.id),t(window).off(".simditor-"+this.id),this.off()},i}(e),_.i18n={"zh-CN":{blockquote:"\u5f15\u7528",bold:"\u52a0\u7c97\u6587\u5b57",code:"\u63d2\u5165\u4ee3\u7801",color:"\u6587\u5b57\u989c\u8272",hr:"\u5206\u9694\u7ebf",image:"\u63d2\u5165\u56fe\u7247",externalImage:"\u5916\u94fe\u56fe\u7247",uploadImage:"\u4e0a\u4f20\u56fe\u7247",uploadFailed:"\u4e0a\u4f20\u5931\u8d25\u4e86",uploadError:"\u4e0a\u4f20\u51fa\u9519\u4e86",imageUrl:"\u56fe\u7247\u5730\u5740",imageSize:"\u56fe\u7247\u5c3a\u5bf8",imageAlt:"\u56fe\u7247\u63cf\u8ff0",restoreImageSize:"\u8fd8\u539f\u56fe\u7247\u5c3a\u5bf8",uploading:"\u6b63\u5728\u4e0a\u4f20",indent:"\u5411\u53f3\u7f29\u8fdb",outdent:"\u5411\u5de6\u7f29\u8fdb",italic:"\u659c\u4f53\u6587\u5b57",link:"\u63d2\u5165\u94fe\u63a5",text:"\u6587\u672c",linkText:"\u94fe\u63a5\u6587\u5b57",linkUrl:"\u5730\u5740",removeLink:"\u79fb\u9664\u94fe\u63a5",ol:"\u6709\u5e8f\u5217\u8868",ul:"\u65e0\u5e8f\u5217\u8868",strikethrough:"\u5220\u9664\u7ebf\u6587\u5b57",table:"\u8868\u683c",deleteRow:"\u5220\u9664\u884c",insertRowAbove:"\u5728\u4e0a\u9762\u63d2\u5165\u884c",insertRowBelow:"\u5728\u4e0b\u9762\u63d2\u5165\u884c",deleteColumn:"\u5220\u9664\u5217",insertColumnLeft:"\u5728\u5de6\u8fb9\u63d2\u5165\u5217",insertColumnRight:"\u5728\u53f3\u8fb9\u63d2\u5165\u5217",deleteTable:"\u5220\u9664\u8868\u683c",title:"\u6807\u9898",normalText:"\u666e\u901a\u6587\u672c",underline:"\u4e0b\u5212\u7ebf\u6587\u5b57",alignment:"\u6392\u7248",alignCenter:"\u5c45\u4e2d",alignLeft:"\u5c45\u5de6",alignRight:"\u5c45\u53f3"}},r=function(e){function i(t){this.editor=t.editor,this.title=this._t(this.name),i.__super__.constructor.call(this,t)}return O(i,e),i.prototype._tpl={item:'<li><a tabindex="-1" unselectable="on" class="toolbar-item" href="javascript:;"><span></span></a></li>',menuWrapper:'<div class="toolbar-menu"></div>',menuItem:'<li><a tabindex="-1" unselectable="on" class="menu-item" href="javascript:;"><span></span></a></li>',separator:'<li><span class="separator"></span></li>'},i.prototype.name="",i.prototype.icon="",i.prototype.title="",i.prototype.text="",i.prototype.htmlTag="",i.prototype.disableTag="",i.prototype.menu=!1,i.prototype.active=!1,i.prototype.disabled=!1,i.prototype.needFocus=!0,i.prototype.shortcut=null,i.prototype._init=function(){var e,i,n,o,s;for(this.render(),this.el.on("mousedown",function(t){return function(e){var i,n;return e.preventDefault(),t.el.hasClass("disabled")||t.needFocus&&!t.editor.inputManager.focused?!1:t.menu?(t.wrapper.toggleClass("menu-on").siblings("li").removeClass("menu-on"),t.wrapper.is(".menu-on")&&(i=t.menuWrapper.offset().left+t.menuWrapper.outerWidth()+5-t.editor.wrapper.offset().left-t.editor.wrapper.outerWidth(),i>0&&t.menuWrapper.css({left:"auto",right:0}),t.trigger("menuexpand")),!1):(n=t.el.data("param"),t.command(n),!1)}}(this)),this.wrapper.on("click","a.menu-item",function(e){return function(i){var n,o;return i.preventDefault(),n=t(i.currentTarget),e.wrapper.removeClass("menu-on"),n.hasClass("disabled")||e.needFocus&&!e.editor.inputManager.focused?!1:(e.editor.toolbar.wrapper.removeClass("menu-on"),o=n.data("param"),e.command(o),!1)}}(this)),this.wrapper.on("mousedown","a.menu-item",function(){return function(){return!1}}(this)),this.editor.on("blur",function(t){return function(){return t.editor.body.is(":visible")&&t.editor.body.is("[contenteditable]")?(t.setActive(!1),t.setDisabled(!1)):void 0}}(this)),null!=this.shortcut&&this.editor.inputManager.addShortcut(this.shortcut,function(t){return function(){return t.el.mousedown(),!1}}(this)),n=this.htmlTag.split(","),o=[],e=0,i=n.length;i>e;e++)s=n[e],s=t.trim(s),o.push(s&&t.inArray(s,this.editor.formatter._allowedTags)<0?this.editor.formatter._allowedTags.push(s):void 0);return o},i.prototype.iconClassOf=function(t){return t?"simditor-icon simditor-icon-"+t:""},i.prototype.setIcon=function(t){return this.el.find("span").removeClass().addClass(this.iconClassOf(t)).text(this.text)},i.prototype.render=function(){return this.wrapper=t(this._tpl.item).appendTo(this.editor.toolbar.list),this.el=this.wrapper.find("a.toolbar-item"),this.el.attr("title",this.title).addClass("toolbar-item-"+this.name).data("button",this),this.setIcon(this.icon),this.menu?(this.menuWrapper=t(this._tpl.menuWrapper).appendTo(this.wrapper),this.menuWrapper.addClass("toolbar-menu-"+this.name),this.renderMenu()):void 0},i.prototype.renderMenu=function(){var e,i,n,o,s,a,r,l;if(t.isArray(this.menu)){for(this.menuEl=t("<ul/>").appendTo(this.menuWrapper),a=this.menu,l=[],n=0,o=a.length;o>n;n++)s=a[n],"|"!==s?(i=t(this._tpl.menuItem).appendTo(this.menuEl),e=i.find("a.menu-item").attr({title:null!=(r=s.title)?r:s.text,"data-param":s.param}).addClass("menu-item-"+s.name),l.push(s.icon?e.find("span").addClass(this.iconClassOf(s.icon)):e.find("span").text(s.text))):t(this._tpl.separator).appendTo(this.menuEl);return l}},i.prototype.setActive=function(t){return t!==this.active?(this.active=t,this.el.toggleClass("active",this.active),this.editor.toolbar.trigger("buttonstatus",[this])):void 0},i.prototype.setDisabled=function(t){return t!==this.disabled?(this.disabled=t,this.el.toggleClass("disabled",this.disabled),this.editor.toolbar.trigger("buttonstatus",[this])):void 0},i.prototype.status=function(t){return null!=t&&this.setDisabled(t.is(this.disableTag)),this.disabled?!0:(null!=t&&this.setActive(t.is(this.htmlTag)),this.active)},i.prototype.command=function(){},i.prototype._t=function(){var t,e,n;return t=1<=arguments.length?R.call(arguments,0):[],n=i.__super__._t.apply(this,t),n||(n=(e=this.editor)._t.apply(e,t)),n},i}(e),_.Button=r,S=function(e){function i(t){this.button=t.button,this.editor=t.button.editor,i.__super__.constructor.call(this,t)}return O(i,e),i.prototype.offset={top:4,left:0},i.prototype.target=null,i.prototype.active=!1,i.prototype._init=function(){return this.el=t('<div class="simditor-popover"></div>').appendTo(this.editor.el).data("popover",this),this.render(),this.el.on("mouseenter",function(t){return function(){return t.el.addClass("hover")}}(this)),this.el.on("mouseleave",function(t){return function(){return t.el.removeClass("hover")}}(this))},i.prototype.render=function(){},i.prototype.show=function(e,i){return null==i&&(i="bottom"),null!=e?(this.el.siblings(".simditor-popover").each(function(){return function(e,i){return i=t(i).data("popover"),i.active?i.hide():void 0}}(this)),this.target=e.addClass("selected"),this.active?(this.refresh(i),this.trigger("popovershow")):(this.active=!0,this.el.css({left:-9999}).show(),setTimeout(function(t){return function(){return t.refresh(i),t.trigger("popovershow")}}(this),0))):void 0},i.prototype.hide=function(){return this.active?(this.target&&this.target.removeClass("selected"),this.target=null,this.active=!1,this.el.hide(),this.trigger("popoverhide")):void 0},i.prototype.refresh=function(t){var e,i,n,o,s;return null==t&&(t="bottom"),this.active?(e=this.editor.el.offset(),o=this.target.offset(),n=this.target.outerHeight(),"bottom"===t?s=o.top-e.top+n:"top"===t&&(s=o.top-e.top-this.el.height()),i=Math.min(o.left-e.left,this.editor.wrapper.width()-this.el.outerWidth()-10),this.el.css({top:s+this.offset.top,left:i+this.offset.left})):void 0},i.prototype.destroy=function(){return this.target=null,this.active=!1,this.editor.off(".linkpopover"),this.el.remove()},i.prototype._t=function(){var t,e,n;return t=1<=arguments.length?R.call(arguments,0):[],n=i.__super__._t.apply(this,t),n||(n=(e=this.button)._t.apply(e,t)),n},i}(e),_.Popover=S,D=function(e){function i(){return i.__super__.constructor.apply(this,arguments)}return O(i,e),i.prototype.name="title",i.prototype.htmlTag="h1, h2, h3, h4",i.prototype.disableTag="pre, table",i.prototype._init=function(){return this.menu=[{name:"normal",text:this._t("normalText"),param:"p"},"|",{name:"h1",text:this._t("title")+" 1",param:"h1"},{name:"h2",text:this._t("title")+" 2",param:"h2"},{name:"h3",text:this._t("title")+" 3",param:"h3"},{name:"h4",text:this._t("title")+" 4",param:"h4"},{name:"h5",text:this._t("title")+" 5",param:"h5"}],i.__super__._init.call(this)},i.prototype.setActive=function(t,e){return i.__super__.setActive.call(this,t),this.el.removeClass("active-p active-h1 active-h2 active-h3"),t?this.el.addClass("active active-"+e):void 0},i.prototype.status=function(t){var e,i;return null!=t&&this.setDisabled(t.is(this.disableTag)),this.disabled?!0:(null!=t&&(e=null!=(i=t[0].tagName)?i.toLowerCase():void 0,this.setActive(t.is(this.htmlTag),e)),this.active)},i.prototype.command=function(e){var i,n,o,s,a,r,l,c,u,d,h;for(c=this.editor.selection.getRange(),h=c.startContainer,s=c.endContainer,o=this.editor.util.closestBlockEl(h),n=this.editor.util.closestBlockEl(s),this.editor.selection.save(),c.setStartBefore(o[0]),c.setEndAfter(n[0]),i=t(c.extractContents()),d=[],i.children().each(function(t){return function(i,n){var o,s,a,r,l;for(s=t._convertEl(n,e),l=[],a=0,r=s.length;r>a;a++)o=s[a],l.push(d.push(o));return l}}(this)),u=d.reverse(),a=0,r=u.length;r>a;a++)l=u[a],c.insertNode(l[0]);return this.editor.selection.restore(),this.editor.trigger("valuechanged")},i.prototype._convertEl=function(e,i){var n,o,s;return o=t(e),s=[],o.is(i)?s.push(o):(n=t("<"+i+"/>").append(o.contents()),s.push(n)),s},i}(r),_.Toolbar.addButton(D),a=function(e){function i(){return i.__super__.constructor.apply(this,arguments)}return O(i,e),i.prototype.name="bold",i.prototype.icon="bold",i.prototype.htmlTag="b, strong",i.prototype.disableTag="pre",i.prototype.shortcut="cmd+b",i.prototype._init=function(){return this.editor.util.os.mac?this.title=this.title+" ( Cmd + b )":(this.title=this.title+" ( Ctrl + b )",this.shortcut="ctrl+b"),i.__super__._init.call(this)},i.prototype.status=function(t){var e;return null!=t&&this.setDisabled(t.is(this.disableTag)),this.disabled?!0:(e=document.queryCommandState("bold")===!0,this.setActive(e),e)},i.prototype.command=function(){return document.execCommand("bold"),this.editor.util.support.oninput||this.editor.trigger("valuechanged"),t(document).trigger("selectionchange")},i}(r),_.Toolbar.addButton(a),y=function(e){function i(){return i.__super__.constructor.apply(this,arguments)}return O(i,e),i.prototype.name="italic",i.prototype.icon="italic",i.prototype.htmlTag="i",i.prototype.disableTag="pre",i.prototype.shortcut="cmd+i",i.prototype._init=function(){return this.editor.util.os.mac?this.title=this.title+" ( Cmd + i )":(this.title=this.title+" ( Ctrl + i )",this.shortcut="ctrl+i"),i.__super__._init.call(this)},i.prototype.status=function(t){var e;return null!=t&&this.setDisabled(t.is(this.disableTag)),this.disabled?this.disabled:(e=document.queryCommandState("italic")===!0,this.setActive(e),e)},i.prototype.command=function(){return document.execCommand("italic"),this.editor.util.support.oninput||this.editor.trigger("valuechanged"),t(document).trigger("selectionchange")},i}(r),_.Toolbar.addButton(y),I=function(e){function i(){return i.__super__.constructor.apply(this,arguments)}return O(i,e),i.prototype.name="underline",i.prototype.icon="underline",i.prototype.htmlTag="u",i.prototype.disableTag="pre",i.prototype.shortcut="cmd+u",i.prototype.render=function(){return this.editor.util.os.mac?this.title=this.title+" ( Cmd + u )":(this.title=this.title+" ( Ctrl + u )",this.shortcut="ctrl+u"),i.__super__.render.call(this)},i.prototype.status=function(t){var e;return null!=t&&this.setDisabled(t.is(this.disableTag)),this.disabled?this.disabled:(e=document.queryCommandState("underline")===!0,this.setActive(e),e)},i.prototype.command=function(){return document.execCommand("underline"),this.editor.util.support.oninput||this.editor.trigger("valuechanged"),t(document).trigger("selectionchange")},i}(r),_.Toolbar.addButton(I),u=function(e){function i(){return i.__super__.constructor.apply(this,arguments)}return O(i,e),i.prototype.name="color",i.prototype.icon="tint",i.prototype.disableTag="pre",i.prototype.menu=!0,i.prototype.render=function(){var t;return t=1<=arguments.length?R.call(arguments,0):[],i.__super__.render.apply(this,t)},i.prototype.renderMenu=function(){return t('<ul class="color-list">\n  <li><a href="javascript:;" class="font-color font-color-1" data-color=""></a></li>\n  <li><a href="javascript:;" class="font-color font-color-2" data-color=""></a></li>\n  <li><a href="javascript:;" class="font-color font-color-3" data-color=""></a></li>\n  <li><a href="javascript:;" class="font-color font-color-4" data-color=""></a></li>\n  <li><a href="javascript:;" class="font-color font-color-5" data-color=""></a></li>\n  <li><a href="javascript:;" class="font-color font-color-6" data-color=""></a></li>\n  <li><a href="javascript:;" class="font-color font-color-7" data-color=""></a></li>\n  <li><a href="javascript:;" class="font-color font-color-default" data-color=""></a></li>\n</ul>').appendTo(this.menuWrapper),this.menuWrapper.on("mousedown",".color-list",function(){return!1}),this.menuWrapper.on("click",".font-color",function(e){return function(i){var n,o,s,a;if(e.wrapper.removeClass("menu-on"),n=t(i.currentTarget),n.hasClass("font-color-default")){if(o=e.editor.body.find("p, li"),!(o.length>0))return;a=window.getComputedStyle(o[0],null).getPropertyValue("color"),s=e._convertRgbToHex(a)}else a=window.getComputedStyle(n[0],null).getPropertyValue("background-color"),s=e._convertRgbToHex(a);return s?(document.execCommand("foreColor",!1,s),e.editor.util.support.oninput?void 0:e.editor.trigger("valuechanged")):void 0}}(this))},i.prototype._convertRgbToHex=function(t){var e,i,n;return i=/rgb\((\d+),\s?(\d+),\s?(\d+)\)/g,(e=i.exec(t))?(n=function(t,e,i){var n;return n=function(t){var e;return e=t.toString(16),1===e.length?"0"+e:e},"#"+n(t)+n(e)+n(i)})(1*e[1],1*e[2],1*e[3]):""},i}(r),_.Toolbar.addButton(u),C=function(e){function i(){return i.__super__.constructor.apply(this,arguments)}return O(i,e),i.prototype.type="",i.prototype.disableTag="pre, table",i.prototype.status=function(t){var e;return null!=t&&this.setDisabled(t.is(this.disableTag)),this.disabled?!0:null==t?this.active:(e="ul"===this.type?"ol":"ul",t.is(e)?(this.setActive(!1),!0):(this.setActive(t.is(this.htmlTag)),this.active))},i.prototype.command=function(){var e,i,n,o,s,a,r,l,c,u,d,h,p,f,m,v,g;for(p=this.editor.selection.getRange(),g=p.startContainer,l=p.endContainer,a=this.editor.util.closestBlockEl(g),i=this.editor.util.closestBlockEl(l),this.editor.selection.save(),p.setStartBefore(a[0]),p.setEndAfter(i[0]),a.is("li")&&i.is("li")&&(o=this.editor.util.furthestNode(a,"ul, ol"),n=this.editor.util.furthestNode(i,"ul, ol"),o.is(n)?(c=function(t){var e;for(e=1;!t.parent().is(o);)e+=1,t=t.parent();return e},v=c(a),r=c(i),s=v>r?i.parent():a.parent(),p.setStartBefore(s[0]),p.setEndAfter(s[0])):(p.setStartBefore(o[0]),p.setEndAfter(n[0]))),e=t(p.extractContents()),m=[],e.children().each(function(t){return function(e,i){var n,o,s,a,r;for(o=t._convertEl(i),r=[],s=0,a=o.length;a>s;s++)n=o[s],r.push(m.length&&m[m.length-1].is(t.type)&&n.is(t.type)?m[m.length-1].append(n.children()):m.push(n));return r}}(this)),f=m.reverse(),u=0,d=f.length;d>u;u++)h=f[u],p.insertNode(h[0]);return this.editor.selection.restore(),this.editor.trigger("valuechanged")},i.prototype._convertEl=function(e){var i,n,o,s,a,r,l,c,u;if(i=t(e),u=[],n="ul"===this.type?"ol":"ul",i.is(this.type))i.children("li").each(function(e){return function(i,n){var o,s,a;return s=t(n),o=s.children("ul, ol").remove(),a=t("<p/>").append(t(n).html()||e.editor.util.phBr),u.push(a),o.length>0?u.push(o):void 0}}(this));else if(i.is(n))o=t("<"+this.type+"/>").append(i.html()),u.push(o);else if(i.is("blockquote")){for(c=i.children().get(),r=0,l=c.length;l>r;r++)s=c[r],a=this._convertEl(s);t.merge(u,a)}else i.is("table")||(o=t("<"+this.type+"><li></li></"+this.type+">"),o.find("li").append(i.html()||this.editor.util.phBr),u.push(o));return u},i}(r),T=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return O(e,t),e.prototype.type="ol",e.prototype.name="ol",e.prototype.icon="list-ol",e.prototype.htmlTag="ol",e.prototype.shortcut="cmd+/",e.prototype._init=function(){return this.editor.util.os.mac?this.title=this.title+" ( Cmd + / )":(this.title=this.title+" ( ctrl + / )",this.shortcut="ctrl+/"),e.__super__._init.call(this)},e}(C),F=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return O(e,t),e.prototype.type="ul",e.prototype.name="ul",e.prototype.icon="list-ul",e.prototype.htmlTag="ul",e.prototype.shortcut="cmd+.",e.prototype._init=function(){return this.editor.util.os.mac?this.title=this.title+" ( Cmd + . )":(this.title=this.title+" ( Ctrl + . )",this.shortcut="ctrl+."),e.__super__._init.call(this)},e}(C),_.Toolbar.addButton(T),_.Toolbar.addButton(F),s=function(e){function i(){return i.__super__.constructor.apply(this,arguments)}return O(i,e),i.prototype.name="blockquote",i.prototype.icon="quote-left",i.prototype.htmlTag="blockquote",i.prototype.disableTag="pre, table",i.prototype.command=function(){var e,i,n,o,s,a,r,l,c,u,d;for(l=this.editor.selection.getRange(),d=l.startContainer,o=l.endContainer,n=this.editor.util.furthestBlockEl(d),i=this.editor.util.furthestBlockEl(o),this.editor.selection.save(),l.setStartBefore(n[0]),l.setEndAfter(i[0]),e=t(l.extractContents()),u=[],e.children().each(function(t){return function(e,i){var n,o,s,a,r;for(o=t._convertEl(i),r=[],s=0,a=o.length;a>s;s++)n=o[s],r.push(u.length&&u[u.length-1].is(t.htmlTag)&&n.is(t.htmlTag)?u[u.length-1].append(n.children()):u.push(n));return r}}(this)),c=u.reverse(),s=0,a=c.length;a>s;s++)r=c[s],l.insertNode(r[0]);return this.editor.selection.restore(),this.editor.trigger("valuechanged")},i.prototype._convertEl=function(e){var i,n,o;return i=t(e),o=[],i.is(this.htmlTag)?i.children().each(function(){return function(e,i){return o.push(t(i))}}(this)):(n=t("<"+this.htmlTag+"/>").append(i),o.push(n)),o},i}(r),_.Toolbar.addButton(s),l=function(e){function i(){return i.__super__.constructor.apply(this,arguments)}return O(i,e),i.prototype.name="code",i.prototype.icon="code",i.prototype.htmlTag="pre",i.prototype.disableTag="li, table",i.prototype._init=function(){return i.__super__._init.call(this),this.editor.on("decorate",function(e){return function(i,n){return n.find("pre").each(function(i,n){return e.decorate(t(n))})}}(this)),this.editor.on("undecorate",function(e){return function(i,n){return n.find("pre").each(function(i,n){return e.undecorate(t(n))})}}(this))},i.prototype.render=function(){var t;return t=1<=arguments.length?R.call(arguments,0):[],i.__super__.render.apply(this,t),this.popover=new c({button:this})},i.prototype.status=function(t){var e;return e=i.__super__.status.call(this,t),this.active?this.popover.show(t):this.editor.util.isBlockNode(t)&&this.popover.hide(),e},i.prototype.decorate=function(t){var e;return e=t.attr("data-lang"),t.removeClass(),e&&-1!==e?t.addClass("lang-"+e):void 0},i.prototype.undecorate=function(t){var e;return e=t.attr("data-lang"),t.removeClass(),e&&-1!==e?t.addClass("lang-"+e):void 0},i.prototype.command=function(){var e,i,n,o,s,a,r,l,c,u,d;for(l=this.editor.selection.getRange(),d=l.startContainer,o=l.endContainer,n=this.editor.util.closestBlockEl(d),i=this.editor.util.closestBlockEl(o),l.setStartBefore(n[0]),l.setEndAfter(i[0]),e=t(l.extractContents()),u=[],e.children().each(function(t){return function(e,i){var n,o,s,a,r;for(o=t._convertEl(i),r=[],s=0,a=o.length;a>s;s++)n=o[s],r.push(u.length&&u[u.length-1].is(t.htmlTag)&&n.is(t.htmlTag)?u[u.length-1].append(n.contents()):u.push(n));return r}}(this)),c=u.reverse(),s=0,a=c.length;a>s;s++)r=c[s],l.insertNode(r[0]);return this.editor.selection.setRangeAtEndOf(u[0]),this.editor.trigger("valuechanged")},i.prototype._convertEl=function(e){var i,n,o,s;return i=t(e),s=[],i.is(this.htmlTag)?(n=t("<p/>").append(i.html().replace("\n","<br/>")),s.push(n)):(o=!i.text()&&1===i.children().length&&i.children().is("br")?"\n":this.editor.formatter.clearHtml(i),n=t("<"+this.htmlTag+"/>").text(o),s.push(n)),s},i}(r),c=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return O(e,t),e.prototype._tpl='<div class="code-settings">\n  <div class="settings-field">\n    <select class="select-lang">\n      <option value="-1">\u9009\u62e9\u7a0b\u5e8f\u8bed\u8a00</option>\n      <option value="bash">Bash</option>\n      <option value="c++">C++</option>\n      <option value="cs">C#</option>\n      <option value="css">CSS</option>\n      <option value="erlang">Erlang</option>\n      <option value="less">Less</option>\n      <option value="scss">Sass</option>\n      <option value="diff">Diff</option>\n      <option value="coffeeScript">CoffeeScript</option>\n      <option value="html">Html,XML</option>\n      <option value="json">JSON</option>\n      <option value="java">Java</option>\n      <option value="js">JavaScript</option>\n      <option value="markdown">Markdown</option>\n      <option value="oc">Objective C</option>\n      <option value="php">PHP</option>\n      <option value="perl">Perl</option>\n      <option value="python">Python</option>\n      <option value="ruby">Ruby</option>\n      <option value="sql">SQL</option>\n    </select>\n  </div>\n</div>',e.prototype.render=function(){return this.el.addClass("code-popover").append(this._tpl),this.selectEl=this.el.find(".select-lang"),this.selectEl.on("change",function(t){return function(){var e;return t.lang=t.selectEl.val(),e=t.target.hasClass("selected"),t.target.removeClass().removeAttr("data-lang"),-1!==t.lang&&(t.target.addClass("lang-"+t.lang),t.target.attr("data-lang",t.lang)),e?t.target.addClass("selected"):void 0}}(this)),this.editor.on("valuechanged",function(t){return function(){return t.active?t.refresh():void 0}}(this))},e.prototype.show=function(){var t;return t=1<=arguments.length?R.call(arguments,0):[],e.__super__.show.apply(this,t),this.lang=this.target.attr("data-lang"),this.selectEl.val(null!=this.lang?this.lang:-1)},e}(S),_.Toolbar.addButton(l),b=function(e){function i(){return i.__super__.constructor.apply(this,arguments)}return O(i,e),i.prototype.name="link",i.prototype.icon="link",i.prototype.htmlTag="a",i.prototype.disableTag="pre",i.prototype.render=function(){var t;return t=1<=arguments.length?R.call(arguments,0):[],i.__super__.render.apply(this,t),this.popover=new x({button:this})},i.prototype.status=function(t){var e;return null!=t&&this.setDisabled(t.is(this.disableTag)),this.disabled?!0:null==t?this.active:(e=!0,!t.is(this.htmlTag)||t.is('[class^="simditor-"]')?(this.setActive(!1),e=!1):this.editor.selection.rangeAtEndOf(t)?(this.setActive(!0),e=!1):this.setActive(!0),e?this.popover.show(t):this.editor.util.isBlockNode(t)&&this.popover.hide(),this.active)},i.prototype.command=function(){var e,i,n,o,s,a,r,l,c,u;return l=this.editor.selection.getRange(),this.active?(n=t(l.commonAncestorContainer).closest("a"),u=document.createTextNode(n.text()),n.replaceWith(u),l.selectNode(u)):(c=l.startContainer,a=l.endContainer,s=this.editor.util.closestBlockEl(c),i=this.editor.util.closestBlockEl(a),e=t(l.extractContents()),r=this.editor.formatter.clearHtml(e.contents(),!1),n=t("<a/>",{href:"http://www.example.com",target:"_blank",text:r||this._t("linkText")}),s[0]===i[0]?l.insertNode(n[0]):(o=t("<p/>").append(n),l.insertNode(o[0])),l.selectNodeContents(n[0]),this.popover.one("popovershow",function(t){return function(){return r?(t.popover.urlEl.focus(),t.popover.urlEl[0].select()):(t.popover.textEl.focus(),t.popover.textEl[0].select())}}(this))),this.editor.selection.selectRange(l),this.editor.trigger("valuechanged")
},i}(r),x=function(e){function i(){return i.__super__.constructor.apply(this,arguments)}return O(i,e),i.prototype.render=function(){var e;return e='<div class="link-settings">\n  <div class="settings-field">\n    <label>'+this._t("text")+'</label>\n    <input class="link-text" type="text"/>\n    <a class="btn-unlink" href="javascript:;" title="'+this._t("removeLink")+'" tabindex="-1"><span class="simditor-icon simditor-icon-unlink"></span></a>\n  </div>\n  <div class="settings-field">\n    <label>'+this._t("linkUrl")+'</label>\n    <input class="link-url" type="text"/>\n  </div>\n</div>',this.el.addClass("link-popover").append(e),this.textEl=this.el.find(".link-text"),this.urlEl=this.el.find(".link-url"),this.unlinkEl=this.el.find(".btn-unlink"),this.textEl.on("keyup",function(t){return function(e){return 13!==e.which?t.target.text(t.textEl.val()):void 0}}(this)),this.urlEl.on("keyup",function(t){return function(e){var i;if(13!==e.which)return i=t.urlEl.val(),!/https?:\/\/|^\//gi.test(i)&&i&&(i="http://"+i),t.target.attr("href",i)}}(this)),t([this.urlEl[0],this.textEl[0]]).on("keydown",function(e){return function(i){return 13===i.which||27===i.which||!i.shiftKey&&9===i.which&&t(i.target).hasClass("link-url")?(i.preventDefault(),setTimeout(function(){var t;return t=document.createRange(),e.editor.selection.setRangeAfter(e.target,t),e.hide(),e.editor.trigger("valuechanged")},0)):void 0}}(this)),this.unlinkEl.on("click",function(t){return function(){var e,i;return i=document.createTextNode(t.target.text()),t.target.replaceWith(i),t.hide(),e=document.createRange(),t.editor.selection.setRangeAfter(i,e),t.editor.trigger("valuechanged")}}(this))},i.prototype.show=function(){var t;return t=1<=arguments.length?R.call(arguments,0):[],i.__super__.show.apply(this,t),this.textEl.val(this.target.text()),this.urlEl.val(this.target.attr("href"))},i}(S),_.Toolbar.addButton(b),p=function(e){function i(){return i.__super__.constructor.apply(this,arguments)}return O(i,e),i.prototype.name="image",i.prototype.icon="picture-o",i.prototype.htmlTag="img",i.prototype.disableTag="pre, table",i.prototype.defaultImage="",i.prototype.needFocus=!1,i.prototype._init=function(){var e,n,o,s;if(this.editor.opts.imageButton)if(Array.isArray(this.editor.opts.imageButton))for(this.menu=[],s=this.editor.opts.imageButton,n=0,o=s.length;o>n;n++)e=s[n],this.menu.push({name:e+"-image",text:this._t(e+"Image")});else this.menu=!1;else this.menu=null!=this.editor.uploader?[{name:"upload-image",text:this._t("uploadImage")},{name:"external-image",text:this._t("externalImage")}]:!1;return this.defaultImage=this.editor.opts.defaultImage,this.editor.body.on("click","img:not([data-non-image])",function(e){return function(i){var n,o;return n=t(i.currentTarget),o=document.createRange(),o.selectNode(n[0]),e.editor.selection.selectRange(o),e.editor.util.support.onselectionchange||e.editor.trigger("selectionchanged"),!1}}(this)),this.editor.body.on("mouseup","img:not([data-non-image])",function(){return function(){return!1}}(this)),this.editor.on("selectionchanged.image",function(e){return function(){var i,n,o;return o=e.editor.selection.getRange(),null!=o?(i=t(o.cloneContents()).contents(),1===i.length&&i.is("img:not([data-non-image])")?(n=t(o.startContainer).contents().eq(o.startOffset),e.popover.show(n)):e.popover.hide()):void 0}}(this)),this.editor.on("valuechanged.image",function(e){return function(){var i;return i=e.editor.wrapper.find(".simditor-image-loading"),i.length>0?i.each(function(i,n){var o,s,a;return s=t(n),o=s.data("img"),!(o&&o.parent().length>0)&&(s.remove(),o&&(a=o.data("file"),a&&(e.editor.uploader.cancel(a),e.editor.body.find("img.uploading").length<1)))?e.editor.uploader.trigger("uploadready",[a]):void 0}):void 0}}(this)),i.__super__._init.call(this)},i.prototype.render=function(){var t;return t=1<=arguments.length?R.call(arguments,0):[],i.__super__.render.apply(this,t),this.popover=new f({button:this}),"upload"===this.editor.opts.imageButton?this._initUploader(this.el):void 0},i.prototype.renderMenu=function(){return i.__super__.renderMenu.call(this),this._initUploader()},i.prototype._initUploader=function(e){var i,n;return null==e&&(e=this.menuEl.find(".menu-item-upload-image")),null==this.editor.uploader?void this.el.find(".btn-upload").remove():(i=null,n=function(n){return function(){return i&&i.remove(),i=t('<input type="file" title="'+n._t("uploadImage")+'" accept="image/*">').appendTo(e)}}(this),n(),e.on("click mousedown","input[type=file]",function(){return function(t){return t.stopPropagation()}}(this)),e.on("change","input[type=file]",function(t){return function(){return t.editor.inputManager.focused?(t.editor.uploader.upload(i,{inline:!0}),n()):(t.editor.one("focus",function(){return t.editor.uploader.upload(i,{inline:!0}),n()}),t.editor.focus()),t.wrapper.removeClass("menu-on")}}(this)),this.editor.uploader.on("beforeupload",function(e){return function(i,n){var o;if(n.inline)return n.img?o=t(n.img):(o=e.createImage(n.name),n.img=o),o.addClass("uploading"),o.data("file",n),e.editor.uploader.readImageFile(n.obj,function(t){var i;if(o.hasClass("uploading"))return i=t?t.src:e.defaultImage,e.loadImage(o,i,function(){return e.popover.active?(e.popover.refresh(),e.popover.srcEl.val(e._t("uploading")).prop("disabled",!0)):void 0})})}}(this)),this.editor.uploader.on("uploadprogress",t.proxy(this.editor.util.throttle(function(t,e,i,n){var o,s,a;if(e.inline&&(s=e.img.data("mask")))return o=s.data("img"),o.hasClass("uploading")&&o.parent().length>0?(a=i/n,a=(100*a).toFixed(0),a>99&&(a=99),s.find(".progress").height(100-a+"%")):void s.remove()},500),this)),this.editor.uploader.on("uploadsuccess",function(e){return function(i,n,o){var s,a,r;if(n.inline&&(s=n.img,s.hasClass("uploading")&&s.parent().length>0)){if(s.removeData("file"),s.removeClass("uploading").removeClass("loading"),a=s.data("mask"),a&&a.remove(),s.removeData("mask"),"object"!=typeof o)try{o=t.parseJSON(o)}catch(l){i=l,o={success:!1}}return o.success===!1?(r=o.msg||e._t("uploadFailed"),alert(r),s.attr("src",e.defaultImage)):s.attr("src",o.file_path),e.popover.active&&(e.popover.srcEl.prop("disabled",!1),e.popover.srcEl.val(o.file_path)),e.editor.trigger("valuechanged"),e.editor.body.find("img.uploading").length<1?e.editor.uploader.trigger("uploadready",[n,o]):void 0}}}(this)),this.editor.uploader.on("uploaderror",function(e){return function(i,n,o){var s,a,r,l;if(n.inline&&"abort"!==o.statusText){if(o.responseText){try{l=t.parseJSON(o.responseText),r=l.msg}catch(c){i=c,r=e._t("uploadError")}alert(r)}if(s=n.img,s.hasClass("uploading")&&s.parent().length>0)return s.removeData("file"),s.removeClass("uploading").removeClass("loading"),a=s.data("mask"),a&&a.remove(),s.removeData("mask"),s.attr("src",e.defaultImage),e.popover.active&&(e.popover.srcEl.prop("disabled",!1),e.popover.srcEl.val(e.defaultImage)),e.editor.trigger("valuechanged"),e.editor.body.find("img.uploading").length<1?e.editor.uploader.trigger("uploadready",[n,l]):void 0}}}(this)))},i.prototype.status=function(t){return null!=t&&this.setDisabled(t.is(this.disableTag)),this.disabled?!0:void 0},i.prototype.loadImage=function(e,i,n){var o,s,a;return a=function(t){return function(){var i,n;return i=e.offset(),n=t.editor.wrapper.offset(),o.css({top:i.top-n.top,left:i.left-n.left,width:e.width(),height:e.height()}).show()}}(this),e.addClass("loading"),o=e.data("mask"),o||(o=t('<div class="simditor-image-loading"><div class="progress"></div></div>').hide().appendTo(this.editor.wrapper),a(),e.data("mask",o),o.data("img",e)),s=new Image,s.onload=function(t){return function(){var r,l;if(e.hasClass("loading")||e.hasClass("uploading"))return l=s.width,r=s.height,e.attr({src:i,"data-image-size":l+","+r}).removeClass("loading"),e.hasClass("uploading")?(t.editor.util.reflow(t.editor.body),a()):(o.remove(),e.removeData("mask")),n(s)}}(this),s.onerror=function(){return function(){return n(!1),o.remove(),e.removeData("mask").removeClass("loading")}}(this),s.src=i},i.prototype.createImage=function(e){var i,n,o,s;return null==e&&(e="Image"),this.editor.inputManager.focused||this.editor.focus(),s=this.editor.selection.getRange(),s.deleteContents(),i=this.editor.util.closestBlockEl(),i.is("p")&&!this.editor.util.isEmptyNode(i)&&(i=t("<p/>").append(this.editor.util.phBr).insertAfter(i),this.editor.selection.setRangeAtStartOf(i,s)),n=t("<img/>").attr("alt",e),s.insertNode(n[0]),o=i.next("p"),o.length>0||(o=t("<p/>").append(this.editor.util.phBr).insertAfter(i)),this.editor.selection.setRangeAtStartOf(o),n},i.prototype.command=function(t){var e;return e=this.createImage(),this.loadImage(e,t||this.defaultImage,function(t){return function(){return t.editor.trigger("valuechanged"),t.editor.util.reflow(e),e.click(),t.popover.one("popovershow",function(){return t.popover.srcEl.focus(),t.popover.srcEl[0].select()})}}(this))},i}(r),f=function(e){function i(){return i.__super__.constructor.apply(this,arguments)}return O(i,e),i.prototype.offset={top:6,left:-4},i.prototype.render=function(){var e;return e='<div class="link-settings">\n  <div class="settings-field">\n    <label>'+this._t("imageUrl")+'</label>\n    <input class="image-src" type="text" tabindex="1" />\n    <a class="btn-upload" href="javascript:;" title="'+this._t("uploadImage")+'" tabindex="-1">\n      <span class="simditor-icon simditor-icon-upload"></span>\n    </a>\n  </div>\n  <div class=\'settings-field\'>\n    <label>'+this._t("imageAlt")+'</label>\n    <input class="image-alt" id="image-alt" type="text" tabindex="1" />\n  </div>\n  <div class="settings-field">\n    <label>'+this._t("imageSize")+'</label>\n    <input class="image-size" id="image-width" type="text" tabindex="2" />\n    <span class="times">\xd7</span>\n    <input class="image-size" id="image-height" type="text" tabindex="3" />\n    <a class="btn-restore" href="javascript:;" title="'+this._t("restoreImageSize")+'" tabindex="-1">\n      <span class="simditor-icon simditor-icon-undo"></span>\n    </a>\n  </div>\n</div>',this.el.addClass("image-popover").append(e),this.srcEl=this.el.find(".image-src"),this.widthEl=this.el.find("#image-width"),this.heightEl=this.el.find("#image-height"),this.altEl=this.el.find("#image-alt"),this.srcEl.on("keydown",function(t){return function(e){return 13!==e.which||t.target.hasClass("uploading")?void 0:(e.preventDefault(),t.button.editor.body.focus(),t.button.editor.selection.setRangeAfter(t.target),t.hide())}}(this)),this.srcEl.on("blur",function(t){return function(){return t._loadImage(t.srcEl.val())}}(this)),this.el.find(".image-size").on("blur",function(e){return function(i){return e._resizeImg(t(i.currentTarget)),e.el.data("popover").refresh()}}(this)),this.el.find(".image-size").on("keyup",function(e){return function(i){var n;return n=t(i.currentTarget),13!==i.which&&27!==i.which&&9!==i.which?e._resizeImg(n,!0):void 0}}(this)),this.el.find(".image-size").on("keydown",function(e){return function(i){var n;return n=t(i.currentTarget),13===i.which||27===i.which?(i.preventDefault(),13===i.which?e._resizeImg(n):e._restoreImg(),e.button.editor.body.focus(),e.button.editor.selection.setRangeAfter(e.target),e.hide()):9===i.which?e.el.data("popover").refresh():void 0}}(this)),this.altEl.on("keydown",function(t){return function(e){return 13===e.which?(e.preventDefault(),t.button.editor.body.focus(),t.button.editor.selection.setRangeAfter(t.target),t.hide()):void 0}}(this)),this.altEl.on("keyup",function(t){return function(e){return 13!==e.which&&27!==e.which&&9!==e.which?(t.alt=t.altEl.val(),t.target.attr("alt",t.alt)):void 0}}(this)),this.el.find(".btn-restore").on("click",function(t){return function(){return t._restoreImg(),t.el.data("popover").refresh()}}(this)),this.editor.on("valuechanged",function(t){return function(){return t.active?t.refresh():void 0}}(this)),this._initUploader()},i.prototype._initUploader=function(){var e,i;return e=this.el.find(".btn-upload"),null==this.editor.uploader?void e.remove():(i=function(i){return function(){return i.input&&i.input.remove(),i.input=t('<input type="file" title="'+i._t("uploadImage")+'" accept="image/*">').appendTo(e)}}(this),i(),this.el.on("click mousedown","input[type=file]",function(){return function(t){return t.stopPropagation()}}(this)),this.el.on("change","input[type=file]",function(t){return function(){return t.editor.uploader.upload(t.input,{inline:!0,img:t.target}),i()}}(this)))},i.prototype._resizeImg=function(e,i){var n,o,s;return null==i&&(i=!1),o=1*e.val(),t.isNumeric(o)||0>o?(e.is(this.widthEl)?(n=this.height*o/this.width,this.heightEl.val(n)):(s=this.width*o/this.height,this.widthEl.val(s)),i||this.target.attr({width:s||o,height:n||o}),this.editor.trigger("valuechanged")):void 0},i.prototype._restoreImg=function(){var t,e;return e=(null!=(t=this.target.data("image-size"))?t.split(","):void 0)||[this.width,this.height],this.target.attr({width:1*e[0],height:1*e[1]}),this.widthEl.val(e[0]),this.heightEl.val(e[1]),this.editor.trigger("valuechanged")},i.prototype._loadImage=function(t,e){return/^data:image/.test(t)&&!this.editor.uploader?void(e&&e(!1)):this.button.loadImage(this.target,t,function(i){return function(n){var o;if(n)return i.active&&(i.width=n.width,i.height=n.height,i.widthEl.val(i.width),i.heightEl.val(i.height),i.target.removeAttr("width").removeAttr("height")),/^data:image/.test(t)?(o=i.editor.util.dataURLtoBlob(t),o.name="Base64 Image.png",i.editor.uploader.upload(o,{inline:!0,img:i.target})):i.editor.trigger("valuechanged"),e?e(n):void 0}}(this))},i.prototype.show=function(){var t,e;return e=1<=arguments.length?R.call(arguments,0):[],i.__super__.show.apply(this,e),t=this.target,this.width=t.width(),this.height=t.height(),this.alt=t.attr("alt"),t.hasClass("uploading")?this.srcEl.val(this._t("uploading")).prop("disabled",!0):(this.srcEl.val(t.attr("src")).prop("disabled",!1),this.widthEl.val(this.width),this.heightEl.val(this.height),this.altEl.val(this.alt))},i}(S),_.Toolbar.addButton(p),m=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return O(e,t),e.prototype.name="indent",e.prototype.icon="indent",e.prototype._init=function(){return this.title=this._t(this.name)+" (Tab)",e.__super__._init.call(this)},e.prototype.status=function(){return!0},e.prototype.command=function(){return this.editor.indentation.indent()},e}(r),_.Toolbar.addButton(m),k=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return O(e,t),e.prototype.name="outdent",e.prototype.icon="outdent",e.prototype._init=function(){return this.title=this._t(this.name)+" (Shift + Tab)",e.__super__._init.call(this)},e.prototype.status=function(){return!0},e.prototype.command=function(){return this.editor.indentation.indent(!0)},e}(r),_.Toolbar.addButton(k),h=function(e){function i(){return i.__super__.constructor.apply(this,arguments)}return O(i,e),i.prototype.name="hr",i.prototype.icon="minus",i.prototype.htmlTag="hr",i.prototype.status=function(){return!0},i.prototype.command=function(){var e,i,n,o;return o=this.editor.util.furthestBlockEl(),n=o.next(),n.length>0?this.editor.selection.save():i=t("<p/>").append(this.editor.util.phBr),e=t("<hr/>").insertAfter(o),i?(i.insertAfter(e),this.editor.selection.setRangeAtStartOf(i)):this.editor.selection.restore(),this.editor.trigger("valuechanged")},i}(r),_.Toolbar.addButton(h),N=function(e){function i(){return i.__super__.constructor.apply(this,arguments)}return O(i,e),i.prototype.name="table",i.prototype.icon="table",i.prototype.htmlTag="table",i.prototype.disableTag="pre, li, blockquote",i.prototype.menu=!0,i.prototype._init=function(){return i.__super__._init.call(this),t.merge(this.editor.formatter._allowedTags,["tbody","tr","td","colgroup","col"]),t.extend(this.editor.formatter._allowedAttributes,{td:["rowspan","colspan"],col:["width"]}),this._initShortcuts(),this.editor.on("decorate",function(e){return function(i,n){return n.find("table").each(function(i,n){return e.decorate(t(n))})}}(this)),this.editor.on("undecorate",function(e){return function(i,n){return n.find("table").each(function(i,n){return e.undecorate(t(n))})}}(this)),this.editor.on("selectionchanged.table",function(e){return function(){var i,n;return e.editor.body.find(".simditor-table td").removeClass("active"),n=e.editor.selection.getRange(),null!=n?(i=t(n.commonAncestorContainer),n.collapsed&&i.is(".simditor-table")&&(i=i.find(e.editor.selection.rangeAtStartOf(i)?"td:first":"td:last"),e.editor.selection.setRangeAtEndOf(i)),i.closest("td",e.editor.body).addClass("active")):void 0}}(this)),this.editor.on("blur.table",function(t){return function(){return t.editor.body.find(".simditor-table td").removeClass("active")}}(this)),this.editor.inputManager.addKeystrokeHandler("38","td",function(t){return function(e,i){var n,o,s;return o=i.parent("tr"),n=o.prev("tr"),n.length>0?(s=o.find("td").index(i),t.editor.selection.setRangeAtEndOf(n.find("td").eq(s)),!0):!0}}(this)),this.editor.inputManager.addKeystrokeHandler("40","td",function(t){return function(e,i){var n,o,s;return o=i.parent("tr"),n=o.next("tr"),n.length>0?(s=o.find("td").index(i),t.editor.selection.setRangeAtEndOf(n.find("td").eq(s)),!0):!0}}(this))},i.prototype.initResize=function(e){var i,n,o;return o=e.parent(".simditor-table"),i=e.find("colgroup"),i.length<1&&(i=t("<colgroup/>").prependTo(e),e.find("tr:first td").each(function(){return function(){var e;return e=t("<col/>").appendTo(i)}}(this)),this.refreshTableWidth(e)),n=t('<div class="simditor-resize-handle" contenteditable="false"></div>').appendTo(o),o.on("mousemove","td",function(){return function(e){var s,a,r,l,c,u;if(!o.hasClass("resizing"))return a=t(e.currentTarget),u=e.pageX-t(e.currentTarget).offset().left,5>u&&a.prev().length>0&&(a=a.prev()),a.next("td").length<1?void n.hide():(null!=(l=n.data("td"))?l.is(a):void 0)?void n.show():(r=a.parent().find("td").index(a),s=i.find("col").eq(r),(null!=(c=n.data("col"))?c.is(s):void 0)?void n.show():n.css("left",a.position().left+a.outerWidth()-5).data("td",a).data("col",s).show())}}(this)),o.on("mouseleave",function(){return function(){return n.hide()}}(this)),o.on("mousedown",".simditor-resize-handle",function(){return function(e){var i,n,s,a,r,l,c,u,d,h,p;return i=t(e.currentTarget),s=i.data("td"),n=i.data("col"),r=s.next("td"),a=n.next("col"),h=e.pageX,u=1*s.outerWidth(),d=1*r.outerWidth(),c=parseFloat(i.css("left")),p=s.closest("table").width(),l=50,t(document).on("mousemove.simditor-resize-table",function(t){var e,o,s;return e=t.pageX-h,o=u+e,s=d-e,l>o?(o=l,e=l-u,s=d-e):l>s&&(s=l,e=d-l,o=u+e),n.attr("width",o/p*100+"%"),a.attr("width",s/p*100+"%"),i.css("left",c+e)}),t(document).one("mouseup.simditor-resize-table",function(){return t(document).off(".simditor-resize-table"),o.removeClass("resizing")}),o.addClass("resizing"),!1}}(this))},i.prototype._initShortcuts=function(){return this.editor.inputManager.addShortcut("ctrl+alt+up",function(t){return function(){return t.editMenu.find(".menu-item[data-param=insertRowAbove]").click(),!1}}(this)),this.editor.inputManager.addShortcut("ctrl+alt+down",function(t){return function(){return t.editMenu.find(".menu-item[data-param=insertRowBelow]").click(),!1}}(this)),this.editor.inputManager.addShortcut("ctrl+alt+left",function(t){return function(){return t.editMenu.find(".menu-item[data-param=insertColLeft]").click(),!1}}(this)),this.editor.inputManager.addShortcut("ctrl+alt+right",function(t){return function(){return t.editMenu.find(".menu-item[data-param=insertColRight]").click(),!1}}(this))},i.prototype.decorate=function(t){return t.parent(".simditor-table").length>0&&this.undecorate(t),t.wrap('<div class="simditor-table"></div>'),this.initResize(t),t.parent()},i.prototype.undecorate=function(t){return t.parent(".simditor-table").length>0?t.parent().replaceWith(t):void 0},i.prototype.renderMenu=function(){return t('<div class="menu-create-table">\n</div>\n<div class="menu-edit-table">\n  <ul>\n    <li><a tabindex="-1" unselectable="on" class="menu-item" href="javascript:;" data-param="deleteRow"><span>'+this._t("deleteRow")+'</span></a></li>\n    <li><a tabindex="-1" unselectable="on" class="menu-item" href="javascript:;" data-param="insertRowAbove"><span>'+this._t("insertRowAbove")+' ( Ctrl + Alt + \u2191 )</span></a></li>\n    <li><a tabindex="-1" unselectable="on" class="menu-item" href="javascript:;" data-param="insertRowBelow"><span>'+this._t("insertRowBelow")+' ( Ctrl + Alt + \u2193 )</span></a></li>\n    <li><span class="separator"></span></li>\n    <li><a tabindex="-1" unselectable="on" class="menu-item" href="javascript:;" data-param="deleteCol"><span>'+this._t("deleteColumn")+'</span></a></li>\n    <li><a tabindex="-1" unselectable="on" class="menu-item" href="javascript:;" data-param="insertColLeft"><span>'+this._t("insertColumnLeft")+' ( Ctrl + Alt + \u2190 )</span></a></li>\n    <li><a tabindex="-1" unselectable="on" class="menu-item" href="javascript:;" data-param="insertColRight"><span>'+this._t("insertColumnRight")+' ( Ctrl + Alt + \u2192 )</span></a></li>\n    <li><span class="separator"></span></li>\n    <li><a tabindex="-1" unselectable="on" class="menu-item" href="javascript:;" data-param="deleteTable"><span>'+this._t("deleteTable")+"</span></a></li>\n  </ul>\n</div>").appendTo(this.menuWrapper),this.createMenu=this.menuWrapper.find(".menu-create-table"),this.editMenu=this.menuWrapper.find(".menu-edit-table"),this.createTable(6,6).appendTo(this.createMenu),this.createMenu.on("mouseenter","td",function(e){return function(i){var n,o,s;return e.createMenu.find("td").removeClass("selected"),n=t(i.currentTarget),o=n.parent(),s=o.find("td").index(n)+1,o.prevAll("tr").addBack().find("td:lt("+s+")").addClass("selected")}}(this)),this.createMenu.on("mouseleave",function(){return function(e){return t(e.currentTarget).find("td").removeClass("selected")}}(this)),this.createMenu.on("mousedown","td",function(e){return function(i){var n,o,s,a,r,l;return e.wrapper.removeClass("menu-on"),e.editor.inputManager.focused?(s=t(i.currentTarget),a=s.parent(),r=a.find("td").index(s)+1,l=a.prevAll("tr").length+1,o=e.createTable(l,r,!0),n=e.editor.util.closestBlockEl(),e.editor.util.isEmptyNode(n)?n.replaceWith(o):n.after(o),e.decorate(o),e.editor.selection.setRangeAtStartOf(o.find("td:first")),e.editor.trigger("valuechanged"),!1):void 0}}(this))},i.prototype.createTable=function(e,i,n){var o,s,a,r,l,c,u,d,h,p;for(o=t("<table/>"),s=t("<tbody/>").appendTo(o),d=c=0,h=e;h>=0?h>c:c>h;d=h>=0?++c:--c)for(r=t("<tr/>").appendTo(s),l=u=0,p=i;p>=0?p>u:u>p;l=p>=0?++u:--u)a=t("<td/>").appendTo(r),n&&a.append(this.editor.util.phBr);return o},i.prototype.refreshTableWidth=function(e){var i,n;return n=e.width(),i=e.find("col"),e.find("tr:first td").each(function(){return function(e,o){var s;return s=i.eq(e),s.attr("width",t(o).outerWidth()/n*100+"%")}}(this))},i.prototype.setActive=function(t){return i.__super__.setActive.call(this,t),t?(this.createMenu.hide(),this.editMenu.show()):(this.createMenu.show(),this.editMenu.hide())},i.prototype.deleteRow=function(t){var e,i,n;return i=t.parent("tr"),i.siblings("tr").length<1?this.deleteTable(t):(e=i.next("tr"),e.length>0||(e=i.prev("tr")),n=i.find("td").index(t),i.remove(),this.editor.selection.setRangeAtEndOf(e.find("td").eq(n)))},i.prototype.insertRow=function(e,i){var n,o,s,a,r,l,c,u;for(null==i&&(i="after"),s=e.parent("tr"),o=s.closest("table"),a=0,o.find("tr").each(function(){return function(e,i){return a=Math.max(a,t(i).find("td").length)}}(this)),n=t("<tr/>"),r=c=1,u=a;u>=1?u>=c:c>=u;r=u>=1?++c:--c)t("<td/>").append(this.editor.util.phBr).appendTo(n);return s[i](n),l=s.find("td").index(e),this.editor.selection.setRangeAtStartOf(n.find("td").eq(l))},i.prototype.deleteCol=function(e){var i,n,o,s;return o=e.parent("tr"),o.siblings("tr").length<1&&e.siblings("td").length<1?this.deleteTable(e):(s=o.find("td").index(e),i=e.next("td"),i.length>0||(i=o.prev("td")),n=o.closest("table"),n.find("col").eq(s).remove(),n.find("tr").each(function(){return function(e,i){return t(i).find("td").eq(s).remove()}}(this)),this.refreshTableWidth(n),this.editor.selection.setRangeAtEndOf(i))},i.prototype.insertCol=function(e,i){var n,o,s,a,r,l,c,u;return null==i&&(i="after"),r=e.parent("tr"),l=r.find("td").index(e),a=e.closest("table"),n=a.find("col").eq(l),a.find("tr").each(function(e){return function(n,o){var s;return s=t("<td/>").append(e.editor.util.phBr),t(o).find("td").eq(l)[i](s)}}(this)),o=t("<col/>"),n[i](o),c=a.width(),u=Math.max(parseFloat(n.attr("width"))/2,50/c*100),n.attr("width",u+"%"),o.attr("width",u+"%"),this.refreshTableWidth(a),s="after"===i?e.next("td"):e.prev("td"),this.editor.selection.setRangeAtStartOf(s)},i.prototype.deleteTable=function(t){var e,i;return i=t.closest(".simditor-table"),e=i.next("p"),i.remove(),e.length>0?this.editor.selection.setRangeAtStartOf(e):void 0},i.prototype.command=function(e){var i,n;if(n=this.editor.selection.getRange(),i=t(n.commonAncestorContainer).closest("td"),i.length>0){if("deleteRow"===e)this.deleteRow(i);else if("insertRowAbove"===e)this.insertRow(i,"before");else if("insertRowBelow"===e)this.insertRow(i);else if("deleteCol"===e)this.deleteCol(i);else if("insertColLeft"===e)this.insertCol(i,"before");else if("insertColRight"===e)this.insertCol(i);else{if("deleteTable"!==e)return;this.deleteTable(i)}return this.editor.trigger("valuechanged")}},i}(r),_.Toolbar.addButton(N),A=function(e){function i(){return i.__super__.constructor.apply(this,arguments)}return O(i,e),i.prototype.name="strikethrough",i.prototype.icon="strikethrough",i.prototype.htmlTag="strike",i.prototype.disableTag="pre",i.prototype.status=function(t){var e;return null!=t&&this.setDisabled(t.is(this.disableTag)),this.disabled?!0:(e=document.queryCommandState("strikethrough")===!0,this.setActive(e),e)},i.prototype.command=function(){return document.execCommand("strikethrough"),this.editor.util.support.oninput||this.editor.trigger("valuechanged"),t(document).trigger("selectionchange")},i}(r),_.Toolbar.addButton(A),o=function(e){function i(){return i.__super__.constructor.apply(this,arguments)}return O(i,e),i.prototype.name="alignment",i.prototype.icon="align-left",i.prototype.htmlTag="p, h1, h2, h3, h4",i.prototype._init=function(){return this.menu=[{name:"left",text:this._t("alignLeft"),icon:"align-left",param:"left"},{name:"center",text:this._t("alignCenter"),icon:"align-center",param:"center"},{name:"right",text:this._t("alignRight"),icon:"align-right",param:"right"}],i.__super__._init.call(this)},i.prototype.setActive=function(t,e){return null==e&&(e="left"),"left"===e?i.__super__.setActive.call(this,!1):i.__super__.setActive.call(this,t),this.el.removeClass("align-left align-center align-right"),t&&this.el.addClass("align-"+e),this.setIcon("align-"+e),this.menuEl.find(".menu-item").show().end().find(".menu-item-"+e).hide()},i.prototype.status=function(t){if(null==t)return!0;if(this.editor.util.isBlockNode(t))return this.setDisabled(!t.is(this.htmlTag)),this.disabled?(this.setActive(!1),!0):(this.setActive(!0,t.data("align")),this.active)},i.prototype.command=function(e){var i,n,o,s,a,r,l,c,u,d;if(["left","center","right"].indexOf(e)<0)throw"invalid "+e;for(c=this.editor.selection.getRange(),d=c.startContainer,a=c.endContainer,o=this.editor.util.closestBlockEl(d),n=this.editor.util.closestBlockEl(a),this.editor.selection.save(),i=o.is(n)?o:o.nextUntil(n).addBack().add(n),u=i.filter(this.htmlTag),r=0,l=u.length;l>r;r++)s=u[r],t(s).attr("data-align",e).data("align",e);return this.editor.selection.restore(),this.editor.trigger("valuechanged")},i}(r),_.Toolbar.addButton(o),_});