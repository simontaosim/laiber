// copyright chris wanstrath
!function(t){function e(e,n,o){var s=this;return this.on("click.pjax",e,function(e){var r=t.extend({},h(n,o));r.container||(r.container=t(this).attr("data-pjax")||s),i(e,r)})}function i(e,i,n){n=h(i,n);var s=e.currentTarget;if("A"!==s.tagName.toUpperCase())throw"$.fn.pjax or $.pjax.click requires an anchor element";if(!(e.which>1||e.metaKey||e.ctrlKey||e.shiftKey||e.altKey||location.protocol!==s.protocol||location.host!==s.host||s.hash&&s.href.replace(s.hash,"")===location.href.replace(location.hash,"")||s.href===location.href+"#")){var r={url:s.href,container:t(s).attr("data-pjax"),target:s,fragment:null};o(t.extend({},r,n)),e.preventDefault()}}function n(e,i,n){n=h(i,n);var s=e.currentTarget;if("FORM"!==s.tagName.toUpperCase())throw"$.pjax.submit requires a form element";var r={type:s.method,url:s.action,data:t(s).serializeArray(),container:t(s).attr("data-pjax"),target:s,fragment:null};o(t.extend({},r,n)),e.preventDefault()}function o(e){function i(e,i){var o=t.Event(e,{relatedTarget:n});return a.trigger(o,i),!o.isDefaultPrevented()}e=t.extend(!0,{},t.ajaxSettings,o.defaults,e),t.isFunction(e.url)&&(e.url=e.url());var n=e.target,s=d(e.url).hash,a=e.context=p(e.container);e.data||(e.data={}),e.data._pjax=a.selector;var l;e.beforeSend=function(t,n){"GET"!==n.type&&(n.timeout=0),t.setRequestHeader("X-PJAX","true"),t.setRequestHeader("X-PJAX-Container",a.selector);return i("pjax:beforeSend",[t,n])?(n.timeout>0&&(l=setTimeout(function(){i("pjax:timeout",[t,e])&&t.abort("timeout")},n.timeout),n.timeout=0),void(e.requestUrl=d(n.url).href)):!1},e.complete=function(t,n){l&&clearTimeout(l),i("pjax:complete",[t,n,e]),i("pjax:end",[t,e])},e.error=function(t,n,o){var s=m("",t,e),a=i("pjax:error",[t,n,o,e]);"GET"==e.type&&"abort"!==n&&a&&r(s.url)},e.success=function(n,l,u){var h=m(n,u,e);if(!h.contents)return void r(h.url);if(o.state={id:e.id||c(),url:h.url,title:h.title,container:a.selector,fragment:e.fragment,timeout:e.timeout},(e.push||e.replace)&&window.history.replaceState(o.state,h.title,h.url),h.title&&(document.title=h.title),a.html(h.contents),"number"==typeof e.scrollTo&&t(window).scrollTop(e.scrollTo),(e.replace||e.push)&&window._gaq&&_gaq.push(["_trackPageview"]),""!==s){var p=d(h.url);p.hash=s,o.state.url=p.href,window.history.replaceState(o.state,h.title,p.href);var f=t(p.hash);f.length&&t(window).scrollTop(f.offset().top)}i("pjax:success",[n,l,u,e])},o.state||(o.state={id:c(),url:window.location.href,title:document.title,container:a.selector,fragment:e.fragment,timeout:e.timeout},window.history.replaceState(o.state,document.title));var h=o.xhr;h&&h.readyState<4&&(h.onreadystatechange=t.noop,h.abort()),o.options=e;var h=o.xhr=t.ajax(e);return h.readyState>0&&(e.push&&!e.replace&&(g(o.state.id,a.clone().contents()),window.history.pushState(null,"",u(e.requestUrl))),i("pjax:start",[h,e]),i("pjax:send",[h,e])),o.xhr}function s(e,i){var n={url:window.location.href,push:!1,replace:!0,scrollTo:!1};return o(t.extend(n,h(e,i)))}function r(t){window.history.replaceState(null,"","#"),window.location.replace(t)}function a(e){var i=e.state;if(i&&i.container){var n=t(i.container);if(n.length){var s=b[i.id];if(!o.state)return void(o.state=i);var a=o.state.id<i.id?"forward":"back";v(a,o.state.id,n.clone().contents());var l=t.Event("pjax:popstate",{state:i,direction:a});n.trigger(l);var c={id:i.id,url:i.url,container:n,push:!1,fragment:i.fragment,timeout:i.timeout,scrollTo:!1};s?(n.trigger("pjax:start",[null,c]),i.title&&(document.title=i.title),n.html(s),o.state=i,n.trigger("pjax:end",[null,c])):o(c),n[0].offsetHeight}else r(location.href)}}function l(e){var i=t.isFunction(e.url)?e.url():e.url,n=e.type?e.type.toUpperCase():"GET",o=t("<form>",{method:"GET"===n?"GET":"POST",action:i,style:"display:none"});"GET"!==n&&"POST"!==n&&o.append(t("<input>",{type:"hidden",name:"_method",value:n.toLowerCase()}));var s=e.data;if("string"==typeof s)t.each(s.split("&"),function(e,i){var n=i.split("=");o.append(t("<input>",{type:"hidden",name:n[0],value:n[1]}))});else if("object"==typeof s)for(key in s)o.append(t("<input>",{type:"hidden",name:key,value:s[key]}));t(document.body).append(o),o.submit()}function c(){return(new Date).getTime()}function u(t){return t.replace(/\?_pjax=[^&]+&?/,"?").replace(/_pjax=[^&]+&?/,"").replace(/[\?&]$/,"")}function d(t){var e=document.createElement("a");return e.href=t,e}function h(e,i){return e&&i?i.container=e:i=t.isPlainObject(e)?e:{container:e},i.container&&(i.container=p(i.container)),i}function p(e){if(e=t(e),e.length){if(""!==e.selector&&e.context===document)return e;if(e.attr("id"))return t("#"+e.attr("id"));throw"cant get selector for pjax container!"}throw"no pjax container for "+e.selector}function f(t,e){return t.filter(e).add(t.find(e))}function m(e,i,n){var o={};if(o.url=u(i.getResponseHeader("X-PJAX-URL")||n.requestUrl),/<html/i.test(e))var s=t(e.match(/<head[^>]*>([\s\S.]*)<\/head>/i)[0]),r=t(e.match(/<body[^>]*>([\s\S.]*)<\/body>/i)[0]);else var s=r=t(e);if(0===r.length)return o;if(o.title=f(s,"title").last().text(),n.fragment){if("body"===n.fragment)var a=r;else var a=f(r,n.fragment).first();a.length&&(o.contents=a.contents(),o.title||(o.title=a.attr("title")||a.data("title")))}else/<html/i.test(e)||(o.contents=r);return o.contents&&(o.contents=o.contents.not("title"),o.contents.find("title").remove()),o.title&&(o.title=t.trim(o.title)),o}function g(t,e){for(b[t]=e,C.push(t);x.length;)delete b[x.shift()];for(;C.length>o.defaults.maxCacheLength;)delete b[C.shift()]}function v(t,e,i){var n,o;b[e]=i,"forward"===t?(n=C,o=x):(n=x,o=C),n.push(e),(e=o.pop())&&delete b[e]}function y(){t.fn.pjax=e,t.pjax=o,t.pjax.enable=t.noop,t.pjax.disable=w,t.pjax.click=i,t.pjax.submit=n,t.pjax.reload=s,t.pjax.defaults={timeout:650,push:!0,replace:!1,type:"GET",dataType:"html",scrollTo:0,maxCacheLength:20},t(window).bind("popstate.pjax",a)}function w(){t.fn.pjax=function(){return this},t.pjax=l,t.pjax.enable=y,t.pjax.disable=t.noop,t.pjax.click=t.noop,t.pjax.submit=t.noop,t.pjax.reload=function(){window.location.reload()},t(window).unbind("popstate.pjax",a)}var b={},x=[],C=[];t.inArray("state",t.event.props)<0&&t.event.props.push("state"),t.support.pjax=window.history&&window.history.pushState&&window.history.replaceState&&!navigator.userAgent.match(/((iPod|iPhone|iPad).+\bOS\s+[1-4]|WebApps\/.+CFNetwork)/),t.support.pjax?y():w()}(jQuery);