!function(t){t.widget("ra.filteringSelect",{options:{createQuery:function(t){return{query:t}},minLength:0,searchDelay:200,remote_source:null,source:null,xhr:!1},_create:function(){var e=this,i=this.element.hide(),n=i.children(":selected"),o=n.val()?n.text():"";this.options.source=this.options.xhr?this.options.remote_source:i.children("option").map(function(){return{label:t(this).text(),value:this.value}}).toArray();var s=t('<div class="input-append filtering-select" style="float:left"></div>'),r=this.input=t('<input type="text">').val(o).addClass("form-control ra-filtering-select-input").attr("style",i.attr("style")).show().autocomplete({delay:this.options.searchDelay,minLength:this.options.minLength,source:this._getSourceFunction(this.options.source),select:function(n,o){var s=t("<option></option>").attr("value",o.item.id).attr("selected","selected").text(o.item.value);i.html(s),i.trigger("change",o.item.id),e._trigger("selected",n,{item:s}),t(e.element.parents(".controls")[0]).find(".update").removeClass("disabled")},change:function(n,o){if(!o.item){var s=new RegExp("^"+t.ui.autocomplete.escapeRegex(t(this).val())+"$","i"),a=!1;if(i.children("option").each(function(){return t(this).text().match(s)?(this.selected=a=!0,!1):void 0}),!a||""==t(this).val())return t(this).val(null),i.html(t('<option value="" selected="selected"></option>')),r.data("ui-autocomplete").term="",t(e.element.parents(".controls")[0]).find(".update").addClass("disabled"),!1}}}).keyup(function(){0==t(this).val().length&&(i.html(t('<option value="" selected="selected"></option>')),i.trigger("change"))});i.attr("placeholder")&&r.attr("placeholder",i.attr("placeholder")),r.data("ui-autocomplete")._renderItem=function(e,i){return t("<li></li>").data("ui-autocomplete-item",i).append(t("<a></a>").html(i.label||i.id)).appendTo(e)};var a=this.button=t('<label class="add-on ui-button ui-widget ui-state-default ui-corner-all ui-button-icon-only" title="Show All Items" role="button"><span class="ui-button-icon-primary ui-icon ui-icon-triangle-1-s"></span><span class="ui-button-text">&nbsp;</span></label>').click(function(){return r.autocomplete("widget").is(":visible")?void r.autocomplete("close"):(r.autocomplete("search",""),void r.focus())});s.append(r).append(a).insertAfter(i)},_getResultSet:function(e,i,n){var o=new RegExp(t.ui.autocomplete.escapeRegex(e.term),"i");return t.map(i,function(i){return(i.id||i.value)&&(n||o.test(i.label))?{label:i.label?i.label.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+t.ui.autocomplete.escapeRegex(e.term)+")(?![^<>]*>)(?![^&;]+;)","gi"),"<strong>$1</strong>"):i.id,value:i.label||i.id,id:i.id||i.value}:void 0})},_getSourceFunction:function(e){var i=this,n=0;return t.isArray(e)?function(t,n){n(i._getResultSet(t,e,!1))}:"string"==typeof e?function(o,s){this.xhr&&this.xhr.abort(),this.xhr=t.ajax({url:e,data:i.options.createQuery(o.term),dataType:"json",autocompleteRequest:++n,success:function(t){this.autocompleteRequest===n&&s(i._getResultSet(o,t,!0))},error:function(){this.autocompleteRequest===n&&s([])}})}:e},destroy:function(){this.input.remove(),this.button.remove(),this.element.show(),t.Widget.prototype.destroy.call(this)}})}(jQuery);